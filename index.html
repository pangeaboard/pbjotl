<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gloomhaven Helper</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root { --accent: #c2a35d; --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --border: #333; }
body { background: var(--bg); color: var(--text); font-family: 'Noto Sans KR', sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
#app { width: 100%; max-width: 500px; background: #1a1a1a; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
.screen { padding: 40px 0; text-align: center; width: 100%; box-sizing: border-box; }

input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }
.hidden { display: none !important; }
.modal-full { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; background: var(--bg); display: none; flex-direction: column; align-items: center; overflow-y: auto; }
.modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2000; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; }
.modal-content { background: #252525; padding: 30px; border-radius: 12px; max-width: 320px; width: 90%; text-align: center; border: 2px solid var(--accent); position: relative; }
#modal-global-alert, #modal-global-confirm { z-index: 3000 !important; }
.modal:not(.hidden) { display: flex !important; }
.modal-full:not(.hidden) { display: flex !important; }
#screen-home { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 10; }
#selected-party-display { flex: 1; border: 2px solid var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; background: var(--card-bg); cursor: pointer; color: var(--text); font-weight: bold; position: relative; z-index: 20; }
#party-list { list-style: none; padding: 0; margin: 0; position: absolute; top: 55px; left: 0; width: 222px; background: #252525; border: 2px solid var(--accent); border-radius: 8px; z-index: 100 !important; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.7); }
#party-list li { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; text-align: center; color: #fff; transition: 0.2s; }
button { cursor: pointer; border: none; transition: 0.2s; border-radius: 4px; color: white; }
.btn-confirm { background: var(--accent); color: black; padding: 12px; font-weight: bold; border-radius: 8px; width: 240px; position: relative; z-index: 20; }
.home-btn-add { width: 50px; height: 50px; padding: 0; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--accent); color: black; font-weight: bold; border-radius: 8px; position: relative; z-index: 25; cursor: pointer; }
#btn-party-enter, #btn-party-delete { flex: 1; height: 45px; font-weight: bold; border-radius: 8px; cursor: pointer; position: relative; z-index: 20; }
#btn-party-delete { background: #444; color: #ff4444; border: 1px solid #ff4444; }

        /* Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .job-list-vertical { display: flex; flex-direction: column; gap: 12px; padding: 0 15px; }
        .job-card-v { position: relative; height: 100px; background: #252525; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: 0.4s; cursor: pointer; display: flex; }
        .job-card-v:hover { height: 170px; border-color: var(--accent); }
        .job-character-img { height: 100%; width: 100%; object-fit: cover; transition: 0.4s; }
        .job-card-v:hover .job-character-img { width: 45%; }
        .card-overlay { position: absolute; top: 0; right: 0; width: 100%; height: 100%; display: flex; justify-content: flex-end; background: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.8) 80%); }
        .job-info-row { width: 55%; display: flex; flex-direction: column; align-items: flex-end; padding: 15px 20px; }
        .input-area { display: none; position: absolute; right: 20px; bottom: 15px; width: calc(100% - 230px); flex-direction: column; align-items: flex-end; }
	.job-card-v:hover .input-area { display: flex; }
	.underline-input { background: none; border: none; border-bottom: 2px solid var(--accent); width: 100%; color: white; text-align: right; margin-bottom: 8px; outline: none; font-size: 0.9rem; }
	.btn-small-confirm { background: var(--accent); color: black; padding: 3px 10px; font-size: 0.7rem; font-weight: bold; border-radius: 4px; width: fit-content; cursor: pointer; }
        .occupied-tag { font-size: 0.7rem; background: var(--accent); color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
	
/* Detailed Sheet - Layout & Components */
.modal-full { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #121212; z-index: 1000; overflow-y: auto; display: none; flex-direction: column; align-items: center; }
.modal-full[style*="display: flex"] { display: flex !important; }
.sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; height: 55px; background: #1a1a1a; border-bottom: 2px solid var(--accent); flex-shrink: 0; width: 100%; max-width: 500px; box-sizing: border-box; }
.header-left { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
#sheet-job-name { font-size: 1.1rem; font-weight: bold; color: var(--accent); }
#sheet-lv-num-wrap { font-size: 0.9rem; color: var(--accent); font-weight: bold; }
.header-right-group { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; }
.name-txt { font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
.header-icons-wrap { display: flex; align-items: center; gap: 4px; }
.header-icons-wrap button { background: #1a1a1a; border: 1px solid #333; color: #888; font-size: 1rem; cursor: pointer; padding: 4px 6px; border-radius: 4px; display: flex; align-items: center; }
.info-controls-section { flex: 0 0 50% !important; width: 50% !important; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
.party-status-bar { cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 6px; padding: 4px; display: flex; align-items: center; justify-content: center; gap: 4px; width: 100%; box-sizing: border-box; }
.status-lv-box { display: flex; align-items: center; gap: 2px; flex-shrink: 1; min-width: 0; }
.status-lv-box .lv-label, .status-lv-box b { color: #888; font-size: 0.6rem; font-weight: normal; }
.status-divider { width: 1px; height: 12px; background: var(--accent); opacity: 0.5; margin: 0 2px; flex-shrink: 0; }
.status-check-txt { font-size: 0.55rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.stat-item { width: 100%; display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.stat-label { font-size: 0.6rem; color: #666; font-weight: bold; }
.exp-bar-wrap { display: flex; align-items: center; gap: 4px; width: 100%; margin-top: 1px; }
.exp-bar-bg { flex: 1; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
.exp-bar-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }
.btn-group-mini { display: flex; gap: 4px; margin-top: 5px; width: 100%; }
.btn-mini { flex: 1; height: 32px; font-size: 0.7rem; background: #222; color: white; border: 1px solid #444; border-radius: 4px; cursor: pointer; white-space: nowrap; }
.sheet-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); width: 100%; max-width: 500px; gap: 1px; background: #333; border-top: 2px solid var(--accent); }
.menu-tab { height: 50px; background: #1a1a1a; color: #eee; border: none; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
.next-lv-txt { font-size: 0.7rem; color: var(--accent); font-weight: bold; white-space: nowrap; margin-left: 5px; }
@media (max-width: 480px) { .sheet-main-info { flex-direction: column; } .job-image-area, .stats-area { width: 100%; flex: none; border-left: none; } .job-image-area { height: auto; min-height: 300px; } }
 
.sheet-main-info { display: flex !important; flex-direction: row !important; width: 100% !important; max-width: 100% !important; height: auto; background: #000; box-sizing: border-box; overflow: hidden; }
.job-image-area { flex: 0 0 50% !important; width: 50% !important; max-width: 50% !important; min-width: 50% !important; display: flex; align-items: flex-start; justify-content: center; background: #000; overflow: hidden; }
#sheet-character-portrait { width: 100% !important; height: auto !important; display: block; object-fit: contain; }
.stats-area { flex: 0 0 50% !important; width: 50% !important; max-width: 50% !important; min-width: 50% !important; display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #111; box-sizing: border-box; border-left: 1px solid #333; overflow: hidden; }
.exp-line, .gold-line { display: flex; align-items: center; gap: 4px; width: 100% !important; max-width: 100% !important; box-sizing: border-box; }
#modal-char-sheet .underline-input { flex: 1 !important; width: 0 !important; min-width: 0 !important; font-size: 0.85rem !important; height: 26px !important; text-align: center; background: #1a1a1a; border: none; border-bottom: 1px solid #333; color: white; outline: none; }


#modal-name-edit .underline-input { background: transparent !important; border: none; border-bottom: 2px solid var(--accent); color: white; font-size: 1.5rem !important; text-align: center; width: 100%; padding: 10px 0; outline: none; margin-bottom: 25px; }
.modal-btn-group { display: flex; gap: 10px; width: 100%; justify-content: center; margin-top: 10px; }
.modal-btn-group button { flex: 1; height: 45px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }
.btn-save-gold { background: var(--accent) !important; color: black !important; }
.btn-cancel-gray { background: #444 !important; color: white !important; }
.btn-reset-red { background: #ff4444 !important; color: white !important; }

/* --- Scenario Setting Modal Detail --- */
.sc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
.sc-title { margin: 0; color: var(--accent); font-size: 1rem; letter-spacing: 1px; font-weight: bold; }
.sc-avg-info-box { display: flex; background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.75rem; color: #888; border: 1px solid #333; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
.sc-avg-item { flex: 1; text-align: center; }
.sc-avg-val { display: block; color: #eee; font-size: 1rem; margin-top: 2px; }
.sc-base-val { display: block; color: var(--accent); font-size: 1rem; margin-top: 2px; font-weight: bold; }
.sc-divider { width: 1px; background: #444; margin: 0 15px; }
.sc-diff-row { display: flex; gap: 5px; margin-bottom: 20px; background: #111; padding: 5px; border-radius: 10px; border: 1px solid #333; }
.sc-diff-btn { flex: 1; border: none; background: transparent; color: #666; padding: 10px 0; font-size: 0.7rem; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
.sc-diff-btn.active { background: var(--accent); color: #000; font-weight: bold; box-shadow: 0 0 12px rgba(194, 163, 93, 0.5); }
.sc-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 10px; border: 1px solid #333; }
.sc-result-item { display: flex; flex-direction: column; align-items: center; padding: 5px 0; }
.sc-result-item.border-r { border-right: 1px solid #333; }
.sc-result-item.border-t { border-top: 1px solid #333; padding-top: 10px; }
.sc-result-label { font-size: 0.65rem; color: #777; margin-bottom: 4px; }
.sc-result-val { font-size: 1.1rem; font-weight: bold; }
.sc-val-monster { color: var(--accent); }
.sc-val-gold { color: #ffd700; }
.sc-val-trap { color: #ff5555; }
.sc-val-exp { color: #44ff44; }

#sh-popup, #bg-popup, .sh-popup-overlay, .bg-popup-overlay { display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; opacity: 0; transition: opacity 0.2s ease; justify-content: center; align-items: center; }
#sh-popup.active, #bg-popup.active, .sh-popup-overlay.active, .bg-popup-overlay.active { display: flex !important; opacity: 1 !important; }
.sh-popup-content, .bg-popup-content { position: relative; width: 95%; max-width: 480px; height: 85vh; background: #1a1a1a; border: 2px solid var(--accent); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; z-index: 2001; box-shadow: 0 0 25px rgba(0,0,0,0.7); }
.sh-header, .bg-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; flex-shrink: 0; }
.sh-title { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
.sh-title small { color: #ffd700; margin-left: 8px; font-size: 0.9rem; font-weight: normal; }
.sh-close-x { background: none; border: none; color: #888; font-size: 1.8rem; cursor: pointer; line-height: 1; }
.sh-category-bar, .bg-category-bar { display: flex; overflow-x: auto; background: #222; padding: 10px; gap: 8px; border-bottom: 1px solid #111; flex-shrink: 0; scrollbar-width: none; }
.sh-category-bar::-webkit-scrollbar { display: none; }
.sh-category-btn, .bg-category-btn { background: #333; color: #eee; border: 1px solid #444; padding: 6px 15px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: 0.2s; }
.sh-category-btn.active, .bg-category-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }
.sh-scroll-area, .bg-scroll-area { flex: 1; overflow-y: auto; padding: 10px 0; background: #111; scroll-behavior: smooth; }
.sh-item-card { display: flex; align-items: center; justify-content: space-between; background: #252525; margin: 8px 12px; padding: 12px; border-radius: 10px; border: 1px solid #333; transition: 0.2s; position: relative; overflow: hidden; z-index: 2005; }
.sh-item-card:hover { border-color: var(--accent); background: #2a2a2a; }
.sh-item-info { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; pointer-events: none; }
.sh-item-no { font-size: 0.65rem; color: var(--accent); font-weight: bold; opacity: 0.8; }
.sh-item-name { font-size: 0.9rem; color: #eee; font-weight: bold; }
.sh-item-type { font-size: 0.7rem; color: #666; background: #1a1a1a; padding: 1px 6px; border-radius: 4px; margin-top: 2px; }
.sh-item-buy-zone { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 4px; min-width: 95px; text-align: right; }
.sh-item-price { font-size: 0.9rem; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
.sh-item-stock { font-size: 0.75rem; color: #ccc; background: none; padding: 0; border-radius: 0; font-family: inherit; }
.sh-item-stock b { color: var(--accent); }
.sh-item-soldout { font-size: 0.9rem; font-weight: bold; color: #ff4444; }
.sh-sold-out { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: #ff4444; font-weight: bold; font-size: 0.8rem; letter-spacing: 2px; transform: rotate(-5deg); pointer-events: none; border: 1px solid rgba(255,68,68,0.3); z-index: 2010; }
.sh-item-owner-label { font-size: 0.75rem; color: #bbb; max-width: 90px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sh-footer, .bg-footer { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #222; border-top: 1px solid #333; flex-shrink: 0; }
.sh-unlock-zone { display: flex; gap: 5px; align-items: center; }
.sh-footer-input { background: #111; border: 1px solid #444; color: #fff; padding: 5px; width: 50px; border-radius: 4px; text-align: center; font-size: 0.85rem; }
.sh-btn-confirm { background: #444; color: #fff; border: 1px solid #555; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
.sh-btn-confirm:hover { background: var(--accent); color: #000; }

.modal, .modal-backdrop { z-index: 3000 !important; }
#modal-alert { z-index: 3001 !important; }


.bag-item-card { display: flex; align-items: center; justify-content: space-between; background: #252525; margin: 8px 12px; padding: 12px; border-radius: 10px; border: 1px solid #333; transition: 0.2s; position: relative; overflow: hidden; }
.bag-item-card:hover { border-color: var(--accent); background: #2a2a2a; }
.bag-item-left { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; gap: 2px; flex-grow: 1; pointer-events: none; }
.bag-item-header { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
.bag-item-id { font-size: 0.65rem; color: var(--accent); font-weight: bold; opacity: 0.8; }
.bag-item-name { font-size: 0.9rem; color: #eee; font-weight: bold; }
.bag-item-category { font-size: 0.7rem; color: #666; background: #1a1a1a; padding: 1px 6px; border-radius: 4px; margin-top: 2px; width: fit-content; }
.bag-item-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 4px; min-width: 95px; text-align: right; }
.btn-bag-remove { background: none; border: none; color: #ff4444; font-size: 1.5rem; cursor: pointer; line-height: 0.8; padding: 0; margin-bottom: 2px; }
.bag-item-sell-price { font-size: 0.9rem; font-weight: bold; color: #ffd700; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); margin: 0; }
.btn-bag-trade { background: rgba(77, 255, 140, 0.15); color: #4dff8c; border: 1px solid rgba(77, 255, 140, 0.4); border-radius: 4px; padding: 2px 10px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; margin-top: 4px; }
.btn-bag-trade:hover { background: #4dff8c; color: #111111; }
.btn-icon-switch { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.4); border-radius: 50%; cursor: pointer; font-size: 1.3rem; transition: 0.2s; padding: 0; line-height: 1; box-shadow: 0 2px 8px rgba(0,0,0,0.4); outline: none; }
.btn-icon-switch:hover { background: #ffd700; border-color: #ffd700; transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
.btn-icon-switch:active { transform: scale(0.95); }
 
.badge-job { padding: 1px 5px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: white; margin-left: 2px; display: inline-block; }
.badge-Ï†ÅÏúÑÎ≥ë { background-color: #e74c3c; } 
.badge-ÎèÑÎÅºÌà¨Ï≤ôÏàò { background-color: #27ae60; } 
.badge-Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä { background-color: #f39c12; } 
.badge-Í≥µÌóàÍ∞êÏãúÏûê { background-color: #8e44ad; } 


#popup-perks { display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2500; opacity: 0; transition: opacity 0.2s ease; justify-content: center; align-items: center; }
#popup-perks.active { display: flex !important; opacity: 1 !important; }
.pk-popup-content { position: relative; width: 95%; max-width: 480px; height: 85vh; background: #1a1a1a; border: 2px solid var(--accent); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.7); }
.pk-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; flex-shrink: 0; }
.pk-header-title { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
.pk-close-btn { background: none; border: none; color: #888; font-size: 1.8rem; cursor: pointer; line-height: 1; }
.pk-scroll-area { flex: 1; overflow-y: auto; padding: 15px; background: #111; }
.pk-point-control { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--accent); }
.pk-stepper { display: flex; align-items: center; gap: 15px; }
.pk-stepper button { width: 30px !important; height: 30px !important; background: var(--accent) !important; color: black !important; font-weight: bold !important; font-size: 1.2rem; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#display-perk-points { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
.pk-battle-goal-section { background: #222; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
.pk-sub-label { font-size: 0.8rem; color: #888; display: block; margin-bottom: 8px; }
.pk-battle-goal-boxes { display: flex; gap: 10px; justify-content: center; }
.pk-bg-box { width: 24px; height: 24px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #222; transition: all 0.2s; font-weight: bold; color: var(--accent); }
.pk-bg-box.checked { border-color: var(--accent); background: #333; box-shadow: inset 0 0 5px var(--accent); }
.pk-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #333; }
.pk-check-container { display: flex; gap: 4px; flex-shrink: 0; padding-top: 2px; }
.pk-check { width: 18px; height: 18px; border: 1px solid var(--accent); border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.pk-check.checked { background: var(--accent); position: relative; }
.pk-check.checked::after { content: '‚úî'; font-size: 12px; color: black; font-weight: bold; }
.pk-txt { font-size: 0.85rem; line-height: 1.4; color: #ccc; flex: 1; }
.pk-txt .icon { display: inline-block; padding: 1px 4px; margin: 0 2px; font-size: 0.75rem; border-radius: 3px; font-weight: bold; color: white; vertical-align: middle; }
.pk-txt .icon.status { background-color: #A29BFE; }
.pk-txt .icon.poison { background-color: #819e7a; }
.pk-txt .icon.wound { background-color: #e67e22; }
.pk-txt .icon.fire { background-color: #E74C3C; }
.pk-txt .icon.ice { background-color: #3498db; }
.pk-txt .icon.air { background-color: #74b9ff; }
.pk-txt .icon.earth { background-color: #795548; }
.pk-txt .icon.light { background-color: #f1c40f; color: black; }
.pk-txt .icon.dark { background-color: #2c3e50; }
.pk-txt .icon.curse { background-color: #4b4b4b; color: #a29bfe; }
.pk-txt .icon.immob { background-color: #4b4b4b; color: #e74c3c; }
.pk-txt .icon.heal { background-color: #27ae60; }
.pk-txt .icon.stun { background-color: #FFFAFA; color: blue; }
.pk-txt .icon.shield { background: none; padding: 0; font-size: 0.9rem; }

.sr-popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2500; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s ease; }
.sr-popup-overlay.active { display: flex !important; opacity: 1 !important; }
.sr-popup-content { position: relative; width: 95%; max-width: 480px; height: 85vh; background: #1a1a1a; border: 2px solid var(--accent); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.7); }
.sr-pp-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; flex-shrink: 0; }
.sr-pp-title { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
.sr-pp-close { background: none; border: none; color: #888; font-size: 1.8rem; cursor: pointer; line-height: 1; }
.sr-pp-scroll-area { flex: 1; overflow-y: auto; padding: 10px 0; background: #111; scroll-behavior: smooth; }
.sr-footer-zone { display: flex; justify-content: center; padding: 12px; background: #222; border-top: 1px solid #333; }
.sr-btn-close-main { background: #444; color: #fff; border: 1px solid #555; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
.sr-btn-close-main:hover { background: var(--accent); color: #000; }
.sr-card { display: flex; align-items: center; justify-content: space-between; background: #252525; margin: 8px 12px; padding: 12px 18px; border-radius: 10px; border: 1px solid #333; transition: 0.2s; cursor: pointer; position: relative; overflow: hidden; height: auto; }
.sr-card:hover { border-color: var(--accent); background: #2a2a2a; transform: translateY(-1px); }
.sr-card.completed { border-left: 5px solid #2ecc71; background: linear-gradient(90deg, #1e2d24, #1a1a1a); }
.sr-card.locked { opacity: 0.4; background: #151515; cursor: not-allowed; filter: grayscale(1); }
.sr-info-zone { display: flex; flex-direction: column; gap: 4px; flex: 1; pointer-events: none; }
.sr-title-row { display: flex; align-items: center; gap: 8px; }
.sr-no { font-size: 0.65rem; color: var(--accent); font-weight: bold; background: rgba(255,184,77,0.1); padding: 2px 5px; border-radius: 4px; }
.sr-title { font-size: 0.95rem; color: #eee; font-weight: bold; }
.sr-reward-preview { font-size: 0.75rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; transition: 0.3s; height: 1rem; }
.sr-reward-preview.hide-reward { opacity: 0; visibility: hidden; }
.sr-reward-preview.show-reward { opacity: 1; visibility: visible; color: #ffd700; font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.3); }
.sr-status-zone { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.sr-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; border: 1px solid transparent; letter-spacing: 0.5px; order: 2; }
.sr-badge.ready { color: #5dade2; border-color: #5dade2; background: rgba(93,173,226,0.1); }
.sr-badge.done { color: #2ecc71; border-color: #2ecc71; background: rgba(46,204,113,0.1); }
.sr-btn-treasure { order: 1; position: relative; background: #333; border: 1px solid #555; border-radius: 6px; padding: 6px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
.sr-btn-treasure:hover { border-color: #ffd700; background: #444; }
.sr-btn-treasure.has-pending::after { content: ''; position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff4d4d; border-radius: 50%; border: 2px solid #252525; box-shadow: 0 0 5px rgba(255,0,0,0.5); }
.modal-global-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
.modal-global-overlay.active { display: flex !important; }
.modal-global-content { background: #1a1a1a; border: 2px solid var(--accent); border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
.modal-global-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; background: #222; }
#treasure-title { color: var(--accent); font-weight: bold; font-size: 1rem; }
.modal-close-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
.treasure-mgr-body { padding: 15px; max-height: 50vh; overflow-y: auto; background: #111; }
.treasure-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; }
.ts-info { display: flex; flex-direction: column; gap: 4px; }
.ts-id { font-size: 0.75rem; color: var(--accent); font-weight: bold; }
.ts-content { font-size: 0.9rem; color: #eee; }
.ts-owner-select { background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 6px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; outline: none; }
.ts-owner-select:focus { border-color: var(--accent); }
.modal-global-footer { padding: 12px; display: flex; justify-content: flex-end; background: #222; border-top: 1px solid #333; }
.btn-confirm { background: var(--accent); color: #000; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.btn-confirm:hover { filter: brightness(1.2); }
.treasure-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px 18px; margin: 8px 12px; border-radius: 10px; border: 1px solid #333; transition: all 0.3s ease; position: relative; overflow: hidden; box-sizing: border-box; }
.treasure-item:hover { border-color: var(--accent); background: #2a2a2a; transform: translateY(-1px); }
.treasure-item.assigned { border-left: 5px solid #2ecc71 !important; background: linear-gradient(90deg, #1e2d24 0%, #1a1a1a 100%) !important; border-top-color: #333; border-right-color: #333; border-bottom-color: #333; }
.ts-info { display: flex; flex-direction: column; gap: 4px; flex: 1; pointer-events: none; }
.ts-id { font-size: 0.65rem; color: var(--accent); font-weight: bold; background: rgba(255,184,77,0.1); padding: 2px 5px; border-radius: 4px; align-self: flex-start; transition: 0.3s; }
.treasure-item.assigned .ts-id { color: #2ecc71 !important; background: rgba(46,204,113,0.1) !important; }
.ts-content { font-size: 0.95rem; color: #eee; font-weight: bold; transition: 0.3s; margin-top: 2px; }
.treasure-item.assigned .ts-content { color: #ffffff !important; text-shadow: 0 0 8px rgba(46,204,113,0.2); }
.ts-owner-select { background: #333; color: white; border: 1px solid #555; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; outline: none; transition: 0.2s; position: relative; z-index: 1; }
.treasure-item.assigned .ts-owner-select { border-color: #2ecc71; background: #222; }
.sr-btn-treasure { opacity: 1; transition: transform 0.2s; position: relative; background: none; border: none; cursor: pointer; }
.sr-btn-treasure:hover { transform: scale(1.2); }

/* ÎèÑÏãúÏù¥Î≤§Ìä∏ */
.ce-popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2500; justify-content: center; align-items: center; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s ease; }
.ce-popup-overlay.active { display: flex !important; opacity: 1 !important; }
.ce-popup-content { background: #1a1a1a; width: 95%; max-width: 480px; height: 85vh; border-radius: 12px; border: 2px solid var(--accent); display: flex; flex-direction: column; overflow: hidden; position: relative; box-shadow: 0 0 20px rgba(184, 134, 11, 0.3); }
.ce-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #222; border-bottom: 1px solid #333; }
.ce-title { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
.ce-category-bar { display: flex; justify-content: space-around; background: #252525; padding: 10px; border-bottom: 1px solid #333; font-size: 0.85rem; color: #888; }
.ce-scroll-area { flex: 1; overflow-y: auto; padding: 15px; background: #151515; }
.ce-deck-section { background: #222; border-radius: 8px; padding: 12px; margin-bottom: 15px; border-left: 4px solid #444; }
.ce-section-title { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; }
.ce-card-active { background: #ffd700; color: #000; border: 1px solid #b8860b; }
.ce-card-removed { background: #c0392b; color: #fff; border: 1px solid #7b1d12; }
.ce-card-locked { background: #333; color: #777; border: 1px solid #444; }
.ce-log-card { background: #1d1d1d; border: 1px solid #333; padding: 10px; border-radius: 6px; margin-bottom: 8px; position: relative; border-left: 4px solid var(--accent); }
.ce-log-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #fff; }
.ce-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.ce-btn-remove { background: #c0392b; }
.ce-btn-bottom { background: #2980b9; }
.ce-footer { padding: 12px; background: #222; border-top: 1px solid #333; }

.ce-footer-input { background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; height: 45px; padding: 0 12px; font-size: 0.95rem; outline: none; box-sizing: border-box; }
.ce-footer-input:focus { border-color: var(--accent); background: #1a1a1a; }
.ce-btn-action { height: 45px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.8rem; color: #fff; transition: filter 0.2s; }
.ce-btn-action:active { filter: brightness(1.3); transform: scale(0.98); }
.ce-log-mini-zone { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #252525; }

.ce-card-badge { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; margin: 2px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; cursor: pointer; transition: transform 0.1s; font-family: 'monospace'; }
.ce-card-badge:active { transform: scale(0.9); }

.hidden { display: none !important; }
.modal-full { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #121212; z-index: 1000; overflow-y: auto; display: none; flex-direction: column; align-items: center; }
.modal-full.active, .modal-full[style*="display: flex"], .modal-full:not(.hidden) { display: flex !important; }
#modal-char-sheet .sheet-header, #modal-char-sheet .sheet-main-info, #modal-char-sheet .sheet-menu-grid { width: 100% !important; max-width: 500px !important; box-sizing: border-box; flex-shrink: 0; }
.sheet-main-info { display: flex !important; flex-direction: row !important; height: auto; background: #000; overflow: hidden; }
.job-image-area { flex: 0 0 50% !important; width: 50% !important; max-width: 50% !important; min-width: 50% !important; display: flex; align-items: flex-start; justify-content: center; background: #000; overflow: hidden; }
.stats-area { flex: 0 0 50% !important; width: 50% !important; max-width: 50% !important; min-width: 50% !important; display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #111; box-sizing: border-box; border-left: 1px solid #333; overflow: hidden; }
.exp-line, .gold-line { display: flex; align-items: center; justify-content: flex-start; gap: 10px; width: 100% !important; box-sizing: border-box; overflow: hidden; }
#modal-char-sheet .underline-input { flex: 0 0 65px !important; width: 65px !important; min-width: 65px !important; font-size: 0.85rem !important; height: 26px !important; text-align: center; background: #1a1a1a; border: none; border-bottom: 1px solid #333; color: white; outline: none; margin: 0; }
.exp-bar-wrap { flex: 1; display: flex; align-items: center; gap: 6px; min-width: 0; overflow: hidden; }
.exp-bar-bg { flex: 1; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
.next-lv-txt { font-size: 0.65rem; color: var(--accent); font-weight: bold; white-space: nowrap; flex-shrink: 0; }
.stat-label { font-size: 0.65rem; color: #666; font-weight: bold; flex-shrink: 0; min-width: 35px; }
.btn-group-mini { display: flex; gap: 4px; margin-top: 5px; width: 100%; flex-shrink: 0; }
.btn-mini { flex: 1; height: 32px; font-size: 0.7rem; background: #222; color: white; border: 1px solid #444; border-radius: 4px; cursor: pointer; white-space: nowrap; }
.sheet-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #333; border-top: 2px solid var(--accent); }
.sr-reward-preview { font-size: 0.75rem; color: #888; overflow: hidden; transition: 0.3s; min-height: 1.2rem; height: auto !important; display: none; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.sr-reward-preview.show-reward { display: flex !important; opacity: 1; visibility: visible; color: #ffd700; font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.3); }
.sr-reward-preview.hide-reward { display: none !important; }

 </style>
</head>
<body>
    <div id="app">
    <section id="screen-home" class="screen">
        <h1 style="font-family: 'Cinzel', serif; color: var(--accent); letter-spacing: 5px; margin-top: 50px; text-align: center; line-height: 1.2;">
            GLOOMHAVEN<br>
            <span style="font-size: 0.5em; letter-spacing: 8px; color: #888; font-weight: 400;">JAWS OF THE LION</span>
        </h1>

        <div style="margin-top: 80px; display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%;">
            <div style="display: flex; gap: 8px; width: 280px; height: 50px; position: relative;">
                <div id="selected-party-display" 
                     style="flex: 1; border: 2px solid var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; background: var(--card-bg); cursor: pointer; color: var(--text); font-weight: bold;"
                     onclick="window.togglePartyList(event)">
                    ÌååÌã∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                </div>
                
                <ul id="party-list" class="hidden"></ul> <button class="home-btn-add" 
                        style="width: 50px; height: 50px; padding: 0; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;" 
                        onclick="window.openModal('modal-party-name')">+</button>
            </div>

            <div style="display: flex; gap: 10px; width: 280px;">
                <button id="btn-party-enter" class="btn-confirm" style="flex: 1; opacity: 0.5;" onclick="window.enterSelectedParty()" disabled>ÏûÖÏû•</button>
                <button id="btn-party-delete" style="flex: 1; background: #444; color: #ff4444; border: 1px solid #ff4444; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5;" 
                        onclick="window.deleteSelectedParty()" disabled>ÏÇ≠Ï†ú</button>
            </div>
        </div>
    </section>

    <section id="screen-job-select" class="screen hidden" style="padding: 20px 0;">
        <h2 id="display-party-name" style="color: var(--accent); font-size: 1.1rem; margin-bottom: 15px; padding: 0 20px; text-align: center;">ÌååÌã∞Ïù¥Î¶Ñ</h2>
        <div class="job-list-vertical" id="job-list-container" style="padding: 0 20px;"></div>
        <button onclick="window.showScreen('screen-home')" style="color:#666; background:none; border:none; margin-top:20px; font-size:0.8rem; width:100%; cursor:pointer;">‚Üê Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </section>

    <div id="modal-party-name" class="modal hidden">
        <div class="modal-content">
            <h3 style="color:var(--accent); font-family:'Cinzel';">CREATE NEW PARTY</h3>
            <input type="text" id="input-party-name" class="underline-input" placeholder="ÌååÌã∞ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="text-align:center; margin-bottom:25px; width:100%;">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-confirm" onclick="window.confirmPartyName()" style="flex:1;">ÏÉùÏÑ±</button>
                <button onclick="window.closeModal('modal-party-name')" style="flex:1; background:#444; border-radius:8px; color:white;">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>


	<div id="modal-char-sheet" class="modal-full hidden">
    <header class="sheet-header">
        <div class="header-left">
            <span id="sheet-job-name" style="color:var(--accent); font-weight:bold;">ÏßÅÏóÖ</span>
            <span id="sheet-lv-num-wrap" style="color:var(--accent);">LV.<span id="sheet-lv-num">1</span></span>
        </div>
        <div class="header-right-group">
            <span id="sheet-player-name" class="name-txt">Ïù¥Î¶Ñ</span>
            <div class="header-icons-wrap">
                <button onclick="window.openNameEditModal()" title="Ïù¥Î¶Ñ ÏàòÏ†ï">‚úèÔ∏è</button>
                <button onclick="window.closeModal('modal-char-sheet')" title="Îí§Î°úÍ∞ÄÍ∏∞">‚¨ÖÔ∏è</button>
                <button onclick="window.openModal('modal-reset-confirm')" title="Ï¥àÍ∏∞Ìôî">‚ùå</button>
            </div>
        </div>
    </header>

    <div class="sheet-main-info">
        <div class="job-image-area">
            <img id="sheet-character-portrait" src="" alt="Ï∫êÎ¶≠ÌÑ∞ Ï†ÑÏã†">
        </div>

        <div class="stats-area">
            <div class="party-status-bar" onclick="window.openDifficultyModal()">
                <div class="status-lv-box">
                    <span class="emoji">üíÄ</span>
                    <span class="lv-label">PARTY LV.</span>
                    <b id="header-scenario-lv">1</b>
                </div>
                <div class="status-divider"></div> 
                <div class="status-check-txt">ÎÇúÏù¥ÎèÑ ÌôïÏù∏</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">EXP (Ï¥ùÎüâ / ÌöçÎìùÎüâ)</div>
                <div class="exp-line">
                    <input type="number" id="input-exp" class="underline-input readonly-input" readonly>
                    <input type="number" id="add-exp-input" class="underline-input edit-input" placeholder="ÌöçÎìùÎüâ" onblur="window.addStatOnBlur('exp')" autocomplete="off">
                </div>
                <div class="exp-bar-wrap">
                    <div class="exp-bar-bg">
                        <div id="sheet-exp-fill" class="exp-bar-fill"></div>
                    </div>
                    <span id="next-lv-info" class="next-lv-txt"></span>
                </div>
            </div>

            <div class="stat-item" style="margin-top: 10px;">
                <div class="stat-label">GOLD (Ï¥ùÎüâ / ÌöçÎìùÎüâ)</div>
                <div class="gold-line">
                    <input type="number" id="input-gold" class="underline-input readonly-input" readonly>
                    <input type="number" id="add-gold-input" class="underline-input edit-input" placeholder="ÌöçÎìùÎüâ" onblur="window.addStatOnBlur('gold')" autocomplete="off">
                </div>
                <div class="btn-group-mini">
                    <button class="btn-mini" onclick="window.openShop()">üõí ÏÉÅÏ†ê</button>
                    <button class="btn-mini" onclick="window.openBag()">üéí Í∞ÄÎ∞©</button>
                </div>
            </div>
        </div> 
    </div>

    <div class="sheet-menu-grid">
        <button class="menu-tab" onclick="window.openPerks()">üìú ÌäπÌòú</button>
        <button class="menu-tab" onclick="window.openScenarioMode()">‚öîÔ∏è ÏãúÎÇòÎ¶¨Ïò§</button>
        <button class="menu-tab" onclick="window.openCityEventMode()">üèôÔ∏è ÎèÑÏãúÏù¥Î≤§Ìä∏</button>
    </div>

<div id="modal-difficulty" class="modal hidden">
    <div class="modal-content">
        <div class="sc-header">
            <h3 class="sc-title">SCENARIO SETTING</h3>
            <span onclick="window.closeModal('modal-difficulty')" style="cursor:pointer; font-size:1.5rem; color:#888;">&times;</span>
        </div>

        <div class="sc-avg-info-box">
            <div class="sc-avg-item">ÌèâÍ∑† Î†àÎ≤® <b id="val-avg-lv" class="sc-avg-val">0.0</b></div>
            <div class="sc-divider"></div>
            <div class="sc-avg-item">Í∏∞Ï§Ä ÎÇúÏù¥ÎèÑ <b id="val-base-lv" class="sc-base-val">0</b></div>
        </div>
        
        <div class="sc-diff-row">
            <button class="sc-diff-btn" onclick="window.calcDifficulty(-1, this)">Ïâ¨ÏõÄ</button>
            <button class="sc-diff-btn active" onclick="window.calcDifficulty(0, this)">Î≥¥ÌÜµ</button>
            <button class="sc-diff-btn" onclick="window.calcDifficulty(1, this)">Ïñ¥Î†§ÏõÄ</button>
            <button class="sc-diff-btn" onclick="window.calcDifficulty(2, this)">ÏïÖÎ™Ω</button>
            <button class="sc-diff-btn" onclick="window.calcDifficulty(3, this)">ÏßÄÏò•</button>
        </div>

        <div class="sc-result-grid">
            <div class="sc-result-item border-r">
                <span class="sc-result-label">Î™¨Ïä§ÌÑ∞ Î†àÎ≤®</span>
                <b id="res-monster" class="sc-result-val sc-val-monster">1</b>
            </div>
            <div class="sc-result-item">
                <span class="sc-result-label">Í≥®Îìú Î∞∞Ïàò</span>
                <b id="res-coin" class="sc-result-val sc-val-gold">x2</b>
            </div>
            <div class="sc-result-item border-r border-t">
                <span class="sc-result-label">Ìï®Ï†ï ÌîºÌï¥</span>
                <b id="res-trap" class="sc-result-val sc-val-trap">3</b>
            </div>
            <div class="sc-result-item border-t">
                <span class="sc-result-label">Ï∂îÍ∞Ä Í≤ΩÌóòÏπò</span>
                <b id="res-xp" class="sc-result-val sc-val-exp">+2</b>
            </div>
        </div>
    </div>
</div>
</div>

<div id="modal-name-edit" class="modal hidden">
    <div class="modal-content">
        <h3 class="modal-title">Ïù¥Î¶Ñ ÏàòÏ†ï</h3>
        <p class="modal-desc">ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</p>
        <input type="text" id="input-edit-name" class="underline-input" style="background: transparent !important;" autocomplete="off">
        <div class="modal-btn-group">
            <button class="btn-save-gold" onclick="window.confirmNameEdit()">Ï†ÄÏû•</button>
            <button class="btn-cancel-gray" onclick="window.closeModal('modal-name-edit')">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<div id="modal-reset-confirm" class="modal hidden">
    <div class="modal-content">
        <h3 class="modal-title" style="color: #ff4444;">Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</h3>
        <p class="modal-desc">Ïù¥ Ï∫êÎ¶≠ÌÑ∞Ïùò Î™®Îì† ÏßÑÌñâ Ï†ïÎ≥¥Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.<br>Ï†ïÎßê ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
        <div class="modal-btn-group">
            <button class="btn-reset-red" onclick="window.executeReset()">Ï¥àÍ∏∞Ìôî</button>
            <button class="btn-cancel-gray" onclick="window.closeModal('modal-reset-confirm')">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<div id="sh-popup" class="sh-popup-overlay">
    <div class="sh-popup-content">
        <header class="sh-header">
            <div class="sh-header-left">
                <span class="sh-title">üõí SHOP <small>(<span class="current-gold-display">0</span>)</small></span>
            </div>
            <button onclick="window.closeShop()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;"> üîô Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú </button>
        </header>

        <nav class="sh-category-bar">
            <button onclick="window.renderShopItems('Ï†ÑÏ≤¥', this)" class="sh-category-btn active">Ï†ÑÏ≤¥</button>
            <button onclick="window.renderShopItems('Ìà¨Íµ¨', this)" class="sh-category-btn">Ìà¨Íµ¨</button>
            <button onclick="window.renderShopItems('Í∞ëÏò∑', this)" class="sh-category-btn">Í∞ëÏò∑</button>
            <button onclick="window.renderShopItems('Î¨¥Í∏∞', this)" class="sh-category-btn">Î¨¥Í∏∞</button>
            <button onclick="window.renderShopItems('Ïã†Î∞ú', this)" class="sh-category-btn">Ïã†Î∞ú</button>
            <button onclick="window.renderShopItems('ÏÜåÎ™®Ìíà', this)" class="sh-category-btn">ÏÜåÎ™®Ìíà</button>
        </nav>

        <div id="sh-item-list" class="sh-scroll-area">
            </div>

        <footer class="sh-footer">
            <div class="sh-unlock-zone">
                <input type="text" id="sh-unlock-input" class="sh-footer-input" placeholder="No.">
                <button class="sh-btn-confirm" onclick="window.unlockItem()">Ìï¥Í∏à</button>
            </div>
            <button onclick="window.closeShop(); window.openBag();" class="btn-icon-switch" title="Í∞ÄÎ∞© Î≥¥Í∏∞">üéí</button>
        </footer>
    </div>
</div> <div id="bg-popup" class="bg-popup-overlay" style="display: none;">
    <div class="bg-popup-content">
        <header class="bg-header">
            <div class="sh-header-left">
                <span class="sh-title">üéí BAG <small>(<span class="current-gold-display">0</span>)</small></span>
            </div>
            <button onclick="window.closeBag()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;"> üîô Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú </button>
        </header>

        <nav class="bg-category-bar">
            <button onclick="window.renderBagItems('Ï†ÑÏ≤¥', this)" class="bg-category-btn active">Ï†ÑÏ≤¥</button>
            <button onclick="window.renderBagItems('Ìà¨Íµ¨', this)" class="bg-category-btn">Ìà¨Íµ¨</button>
            <button onclick="window.renderBagItems('Í∞ëÏò∑', this)" class="bg-category-btn">Í∞ëÏò∑</button>
            <button onclick="window.renderBagItems('Î¨¥Í∏∞', this)" class="bg-category-btn">Î¨¥Í∏∞</button>
            <button onclick="window.renderBagItems('Ïã†Î∞ú', this)" class="bg-category-btn">Ïã†Î∞ú</button>
            <button onclick="window.renderBagItems('ÏÜåÎ™®Ìíà', this)" class="bg-category-btn">ÏÜåÎ™®Ìíà</button>
        </nav>

        <div id="bg-item-list" class="bg-scroll-area">
            </div>

        <footer class="bg-footer">
    <div class="bg-reward-zone" style="display: flex; gap: 5px; flex: 1;">
        <input type="text" id="bg-reward-input" class="sh-footer-input" placeholder="Reward No.">
        <button class="sh-btn-confirm" onclick="window.processRewardInput()" style="white-space: nowrap;">Î≥¥ÏÉÅ</button>
    </div>
    <button onclick="window.closeBag(); window.openShop();" class="btn-icon-switch" title="ÏÉÅÏ†ê Î≥¥Í∏∞" style="margin-left: 10px;">üõí</button>
</footer>
    </div>
</div>

<div id="modal-item-action" class="modal hidden">
    <div class="modal-content item-action-content">
        <h3 id="action-item-name" class="modal-title">ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ</h3>
        <p id="action-item-desc" class="modal-desc">Ïù¥ ÏïÑÏù¥ÌÖúÏùÑ Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
        
        <div class="action-info-zone">
            Í∞ÄÍ≤©: <span id="action-item-price">0</span>
        </div>

        <div class="modal-btn-group">
            <button id="btn-item-buy" class="btn-confirm" onclick="window.processItemAction('buy')">Íµ¨Îß§</button>
            <button class="btn-cancel-gray" onclick="window.closeModal('modal-item-action')">Îã´Í∏∞</button>
        </div>
    </div>
</div>

<div id="popup-perks"> <div class="pk-popup-content">
        <div class="pk-header">
            <span class="pk-header-title">üìú ÌäπÌòú (Perks)</span>
            <button onclick="window.closePerks()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;"> üîô Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú </button>
        </div>
        
        <div class="pk-scroll-area">
            <div class="pk-point-control">
                <span>ÌäπÌòú Ìè¨Ïù∏Ìä∏</span>
                <div class="pk-stepper">
                    <button onclick="window.changePerkPoint(-1)">-</button>
                    <span id="display-perk-points">0</span>
                    <button onclick="window.changePerkPoint(1)">+</button>
                </div>
            </div>

            <div class="pk-battle-goal-section">
                <span class="pk-sub-label">Î∞∞ÌãÄ Í≥® Îã¨ÏÑ± (3Ïπ∏ Ï±ÑÏö∏ Ïãú Ìè¨Ïù∏Ìä∏ +1)</span>
                <div class="pk-battle-goal-boxes" id="battle-goal-container"></div>
            </div>

            <div id="perk-list-container"></div>
        </div>
    </div>
</div>
</div>

<div id="popup-scenario" class="sr-popup-overlay">
    <div class="sr-popup-content">
        <header class="sr-pp-header">
            <div class="sr-info-zone">
                <span class="sr-pp-title">‚öîÔ∏è Ï∫†ÌéòÏù∏ ÏãúÎÇòÎ¶¨Ïò§</span>
            </div>
            <button onclick="window.closeScenarioMode()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;"> üîô Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú </button>
        </header>

        <div id="scenario-grid" class="sr-pp-scroll-area">
            </div>

        <footer class="sr-footer-zone" style="display: flex; align-items: center; justify-content: flex-start; padding: 12px 20px;">
    <div class="sh-unlock-zone" style="display: flex; align-items: center; gap: 8px;">
        <input type="number" id="manual-sr-id" class="sh-footer-input no-spin" placeholder="No." 
               style="width: 55px; text-align: center; -moz-appearance: textfield; appearance: none;">
        <button class="sh-btn-confirm" onclick="window.handleManualScenarioToggle()">Ìï¥Í∏à</button>
    </div>
    
    <span style="font-size: 0.75rem; color: #666; margin-left: 15px; pointer-events: none;">
        * ÏôÑÎ£åÎêú ÏãúÎÇòÎ¶¨Ïò§Îäî ÏàòÏ†ï Î∂àÍ∞Ä
    </span>
</footer>
<style>
#manual-sr-id::-webkit-outer-spin-button,
#manual-sr-id::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
</style>
    </div>
</div>
</div>

<div id="modal-treasure-manager" class="modal-global-overlay hidden" style="display: none;">
    <div class="modal-global-content">
        <header class="modal-global-header">
            <span id="treasure-title" style="font-weight: bold;">üéÅ Î≥¥Î¨º ÌöçÎìù Í∏∞Î°ù</span>
            <button onclick="window.closeModal('modal-treasure-manager')" class="modal-close-btn">√ó</button>
        </header>
        <div id="treasure-list" class="treasure-mgr-body" style="padding: 15px; min-height: 100px; max-height: 400px; overflow-y: auto;">
            </div>
    </div>
</div>

<div id="ce-popup" class="ce-popup-overlay">
    <div class="ce-popup-content">
        <header class="ce-header">
            <div class="ce-header-left">
                <span class="ce-title">üèôÔ∏è CITY EVENT</span>
            </div>
            <button onclick="window.closeCityEventMode()" style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold;"> üîô Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú </button>
        </header>

        <nav class="ce-category-bar">
            <span>ÌôúÏÑ±: <b id="ce-count-active" style="color:#ffd700;">0</b></span>
            <span>ÏÜåÎ©∏: <b id="ce-count-removed" style="color:#ff6b6b;">0</b></span>
            <span>Ïû†ÍπÄ: <b id="ce-count-locked" style="color:#777;">0</b></span>
        </nav>

        <div class="ce-scroll-area">
            <div class="ce-deck-section">
                <span class="ce-section-title" style="color:#ffd700;">‚úÖ ÌòÑÏû¨ Îç±</span>
                <div id="ce-deck-numbers"></div>
            </div>
            <div class="ce-deck-section" style="border-left-color:#c0392b;">
                <span class="ce-section-title" style="color:#ff6b6b;">üö´ ÏÜåÎ©∏ Îç±</span>
                <div id="ce-removed-numbers"></div>
            </div>
            <div class="ce-deck-section" style="border-left-color:#444; opacity:0.7;">
                <span class="ce-section-title" style="color:#888;">üîí Ïû†Í∏¥ Îç±</span>
                <div id="ce-locked-numbers"></div>
            </div>
        </div> <footer class="ce-footer">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="number" id="ce-input-id" class="ce-footer-input" placeholder="No." style="width:70px;">
                <input type="text" id="ce-input-note" class="ce-footer-input" placeholder="ÏÇ¨Í±¥ Í≤∞Í≥º ÏöîÏïΩ" style="flex:1;">
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 15px;">
                <button class="ce-btn-action" onclick="window.handleCityEvent('toggle')" style="background:#444;">Ìï¥Í∏à/Ïû†Í∏à</button>
                <button class="ce-btn-action" onclick="window.handleCityEvent('remove')" style="background:#c0392b;">ÏòÅÍµ¨ ÏÜåÎ©∏</button>
                <button class="ce-btn-action" onclick="window.handleCityEvent('bottom')" style="background:#2980b9;">Îç± Î≥µÍ∑Ä</button>
            </div>

            <div class="ce-log-mini-zone">
                <div style="display:flex; justify-content:space-between; align-items:center; color:#888; font-size:0.75rem; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px; cursor:pointer;" onclick="window.toggleCityEventLogs()">
                    <div id="ce-log-summary" style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        üìú ÏµúÍ∑º Í∏∞Î°ù: ÏóÜÏùå
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; flex-shrink:0;">
                        <span id="ce-log-toggle-icon">‚ñº</span>
                        <span style="color:#ff6b6b; font-weight:bold;" onclick="event.stopPropagation(); window.clearCityEventLogs();">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</span>
                    </div>
                </div>
                
                <div id="ce-log-container" class="hidden" style="max-height: 200px; overflow-y: auto; transition: all 0.3s ease;">
                </div>
            </div> </footer> </div> </div> <div id="modal-global-alert" class="modal hidden">
    <div class="modal-content">
        <h3 id="alert-title" style="color:var(--accent);">ÏïåÎ¶º</h3>
        <p id="alert-message" style="margin: 20px 0; color: #ccc;"></p>
        <button class="btn-confirm" onclick="window.closeModal('modal-global-alert')" style="width:100%;">ÌôïÏù∏</button>
    </div>
</div>

<div id="modal-global-confirm" class="modal hidden">
    <div class="modal-content">
        <h3 id="confirm-title" style="color:var(--accent); font-family:'Cinzel';">CONFIRM</h3>
        <p id="confirm-message" style="margin: 20px 0; line-height: 1.5; color: var(--text);"></p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="confirm-action-btn" class="btn-confirm" style="flex:1;">ÌôïÏù∏</button>
            <button onclick="window.closeModal('modal-global-confirm')" style="flex:1; background:#444; border-radius:8px; color:white; border:none; cursor:pointer;">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>



</body>
</html>
<script type="module">
// [1] Firebase Î™®Îìà Î∂àÎü¨Ïò§Í∏∞ (ÏµúÏÉÅÎã®)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

window.FB_DB = { getDatabase, ref, update, onValue };

// Ïù¥ Ìï®ÏàòÎ•º window.initAppÏù¥ÎÇò Firebase Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïÑÏò§Îäî .then() Î∏îÎ°ù ÎßàÏßÄÎßâÏóê ÎÑ£ÏúºÏÑ∏Ïöî.
window.syncAllDataAtStart = function() {
    // 1. Ïû•Î∂Ä Ï¥àÍ∏∞Ìôî
    itemData.forEach(item => item.owners = []);

    const parties = window.state.parties;
    if (!parties) return;

    // 2. Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Í∞ÄÎ∞©ÏùÑ ÌÉàÌÉà ÌÑ∏Ïñ¥ÏÑú Ïû•Î∂ÄÏóê Í∏∞ÏûÖ
    Object.values(parties).forEach(party => {
        // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏] party.charactersÍ∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ Îπà Í∞ùÏ≤¥Î°ú ÎåÄÏ≤¥ÌïòÏó¨ ÏóêÎü¨ Î∞©ÏßÄ
        const characters = party.characters || {}; 
        
        Object.entries(characters).forEach(([jobName, charData]) => {
            const myBag = charData.items || [];
            myBag.forEach(itemId => {
                const item = itemData.find(i => i.id == itemId);
                if (item) {
                    if (!item.owners.includes(jobName)) {
                        item.owners.push(jobName);
                    }
                }
            });
        });
    });
    
    console.log("‚úÖ Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å");
};

// [2] Firebase ÏÑ§Ï†ï
const firebaseConfig = {
    apiKey: "AIzaSyBavpez3lAxqLYEbcpXEfYEVAFVDwzTy_Y",
    authDomain: "jotl-4dbb1.firebaseapp.com",
    databaseURL: "https://jotl-4dbb1-default-rtdb.firebaseio.com", 
    projectId: "jotl-4dbb1",
    storageBucket: "jotl-4dbb1.firebasestorage.app",
    messagingSenderId: "664719527629",
    appId: "1:664719527629:web:6157026bd6f7e3dbfda384"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.state = {
    parties: {},
    currentPartyName: null,
    isInitialized: false
};

document.addEventListener('DOMContentLoaded', () => {
    if (typeof window.renderPartyList === 'function') {
        window.renderPartyList();
    }
});

// [JS] ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞ ÏÑ†Ïñ∏ (ÏõêÎ≥∏ ÏàòÏπò Ïú†ÏßÄ)
window.itemData = [
    { id: 1, name: "ÎèÖÏàòÎ¶¨ Îàà Í≥†Í∏Ä", price: 30, stock: 2, type: "Ìà¨Íµ¨", owners: [] },
    { id: 2, name: "Ï≤† Ìà¨Íµ¨", price: 20, stock: 2, type: "Ìà¨Íµ¨", owners: [] },
    { id: 3, name: "Ïá†ÏÇ¨Ïä¨ Í∞ëÏò∑", price: 30, stock: 2, type: "Í∞ëÏò∑", owners: [] },
    { id: 4, name: "Ïßï Î∞ïÏùÄ Í∞ÄÏ£Ω Í∞ëÏò∑", price: 25, stock: 2, type: "Í∞ëÏò∑", owners: [] },
    { id: 5, name: "ÎÇ°ÏùÄ Ïû•Ìôî", price: 15, stock: 2, type: "Ïã†Î∞ú", owners: [] },
    { id: 6, name: "ÎÇ†Í∞ú Îã¨Î¶∞ Ïã†Î∞ú", price: 15, stock: 2, type: "Ïã†Î∞ú", owners: [] },
    { id: 7, name: "Îã§Î¶¨ÎØ∏Íº¥ Î∞©Ìå®", price: 20, stock: 2, type: "Î¨¥Í∏∞", owners: [] },
    { id: 8, name: "Ìà¨Ï≤ôÏö© ÎßùÏπò", price: 30, stock: 2, type: "Î¨¥Í∏∞", owners: [] },
    { id: 9, name: "ÎèÖ Îã®Í≤Ä", price: 20, stock: 2, type: "Î¨¥Í∏∞", owners: [] },
    { id: 10, name: "Í∞ïÏ≤† Ï∞Ω", price: 20, stock: 2, type: "Î¨¥Í∏∞", owners: [] },
    { id: 11, name: "ÏπòÎ£å Î¨ºÏïΩ", price: 10, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 12, name: "ÌôúÎ†• Î¨ºÏïΩ", price: 10, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 13, name: "Ìûò Î¨ºÏïΩ", price: 10, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 14, name: "ÎßàÎÇò Î¨ºÏïΩ", price: 10, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 15, name: "ÏÉùÎ™ÖÏùò Î∂ÄÏ†Å", price: 20, stock: 1, type: "Ìà¨Íµ¨", owners: [] },
    { id: 16, name: "Ï¥àÌòºÏùò Î°úÎ∏å", price: 40, stock: 1, type: "Í∞ëÏò∑", owners: [] },
    { id: 17, name: "Ìé∏ÏïàÌïú Ïã†Î∞ú", price: 30, stock: 1, type: "Ïã†Î∞ú", owners: [] },
    { id: 18, name: "Ï†ÑÌà¨ ÎèÑÎÅº", price: 25, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 19, name: "Í≤ÄÏùÄ ÏñëÏ¥à", price: 40, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 20, name: "Í∏∞Ï†à Í∞ÄÎ£®", price: 20, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 21, name: "ÏÜ°Í≥®Îß§ Ìà¨Íµ¨", price: 20, stock: 1, type: "Ìà¨Íµ¨", owners: [] },
    { id: 22, name: "ÎÇ†Î∂ôÏù¥ Í∞ëÏò∑", price: 45, stock: 1, type: "Í∞ëÏò∑", owners: [] },
    { id: 23, name: "ÌôúÎ≥¥Ïùò Ïû•Ìôî", price: 30, stock: 1, type: "Ïã†Î∞ú", owners: [] },
    { id: 24, name: "ÌúòÎ∞úÏÑ± Ìè≠ÌÉÑ", price: 40, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 25, name: "Í∞ÄÏãú ÎèãÏπú ÏÇ¨Ïä¨", price: 30, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 26, name: "Îñ°Í∞àÎÇòÎ¨¥ Î∂ÄÏ†Å", price: 30, stock: 2, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 27, name: "Ïö¥Î™Ö ÎÇòÏπ®Î∞ò", price: 25, stock: 1, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 28, name: "Î≤ºÎ£©Ìà¨ÏÑ±Ïù¥ ÏàÑ", price: 10, stock: 1, type: "Í∞ëÏò∑", owners: [] },
    { id: 29, name: "ÎåÄÌòï Î∞©Ìå®", price: 40, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 30, name: "Ïã†ÏÜçÏùò Î∞òÏßÄ", price: 40, stock: 1, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 31, name: "ÌûòÏùò Î∞òÏßÄ", price: 40, stock: 1, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 32, name: "ÌöåÎ≥µÏùò Î∞òÏßÄ", price: 40, stock: 1, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 33, name: "Í∞ïÏ≤† Î∞òÏßÄ", price: 30, stock: 1, type: "ÏÜåÎ™®Ìíà", owners: [] },
    { id: 34, name: "Í∞ÄÏãú ÎèãÏπú ÎèÑÎÅº", price: 40, stock: 1, type: "Î¨¥Í∏∞", owners: [] },
    { id: 35, name: "Î™ÖÎ†πÏùò Î°úÎ∏å", price: 40, stock: 1, type: "Í∞ëÏò∑", owners: [] },
    { id: 36, name: "Ï†úÌä∏ Ïû•Ìôî", price: 30, stock: 1, type: "Ïã†Î∞ú", owners: [] }
];

window.unlockedItemIds = [];

window.perkData = {
    "ÎèÑÎÅºÌà¨Ï≤ôÏàò": [{n:2, t:"'-1' Ïπ¥Îìú 2Ïû•ÏùÑ Ï†úÍ±∞"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon status'>ÌòºÎûÄ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon poison'>Ï§ëÎèÖ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon wound'>Î∂ÄÏÉÅ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon immob'>Ïù¥ÎèôÎ∂àÍ∞Ä</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 [Î∞ÄÍ∏∞ 2]' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+0 <span class='icon stun'>Í∏∞Ï†à</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon stun'>Í∏∞Ï†à</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:3, t:"'+2 <span class='icon air'>Í≥µÍ∏∞</span>' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:3, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+3' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}],
    "Ï†ÅÏúÑÎ≥ë": [{n:1, t:"'0' Ïπ¥Îìú 4Ïû•ÏùÑ Ï†úÍ±∞"}, {n:1, t:"'-1' Ïπ¥Îìú 2Ïû•ÏùÑ Ï†úÍ±∞"}, {n:1, t:"'-2' Ïπ¥Îìú 1Ïû• Î∞è '+1' Ïπ¥Îìú 1Ïû•ÏùÑ Ï†úÍ±∞"}, {n:2, t:"'-1' Ïπ¥Îìú 1Ïû•ÏùÑ '+1' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon fire'>Î∂à</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon light'>Îπõ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'+1 <span class='icon fire'>Î∂à</span>,<span class='icon light'>Îπõ</span>' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:2, t:"'+1 [Î∞©Ïñ¥ 1] <span class='icon shield'>üõ°Ô∏è</span>' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon immob'>Ïù¥ÎèôÎ∂àÍ∞Ä</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:1, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon wound'>Î∂ÄÏÉÅ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}],
    "Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä": [{n:1, t:"'0' Ïπ¥Îìú 4Ïû•ÏùÑ Ï†úÍ±∞"}, {n:2, t:"'-1' Ïπ¥Îìú 2Ïû•ÏùÑ Ï†úÍ±∞"}, {n:1, t:"'-2' Ïπ¥Îìú 1Ïû• Î∞è '+1' Ïπ¥Îìú 1Ïû•ÏùÑ Ï†úÍ±∞"}, {n:2, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon status'>ÌòºÎûÄ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'-1' Ïπ¥Îìú 1Ïû•ÏùÑ '+0 <span class='icon poison'>Ï§ëÎèÖ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'+2' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:2, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon earth'>ÎïÖ</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'+1' Ïπ¥Îìú 1Ïû•ÏùÑ '+2 <span class='icon fire'>Î∂à</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'0' Ïù∏Ï†ëÌïú Î™®Îì† Ï†Å ÌîºÌï¥ 1 Ïπ¥Îìú 1Ïû• Ï∂îÍ∞Ä"}],
    "Í≥µÌóàÍ∞êÏãúÏûê": [{n:1, t:"'-1' Ïπ¥Îìú 2Ïû•ÏùÑ Ï†úÍ±∞"}, {n:1, t:"'-2' Ïπ¥Îìú 1Ïû•ÏùÑ Ï†úÍ±∞"}, {n:2, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon dark'>Ïñ¥Îë†</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'0' Ïπ¥Îìú 1Ïû•ÏùÑ '+1 <span class='icon ice'>ÎÉâÍ∏∞</span>' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:2, t:"'-1' Ïπ¥Îìú 1Ïû•ÏùÑ '+0 [ÏπòÏú† 1 <span class='icon heal'>‚ô•</span> ÏïÑÍµ∞]' Ïπ¥Îìú 1Ïû•ÏúºÎ°ú ÍµêÏ≤¥"}, {n:3, t:"'+1 [ÏπòÏú† 1 <span class='icon heal'>‚ô•</span> ÏïÑÍµ∞]' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:1, t:"'+1 <span class='icon poison'>Ï§ëÎèÖ</span>' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:1, t:"'+3' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}, {n:2, t:"'+1 <span class='icon curse'>Ï†ÄÏ£º</span>' Ïπ¥Îìú 1Ïû•ÏùÑ Ï∂îÍ∞Ä"}]
};

const SCENARIO_TEMPLATE = {
    1: { t: "Í∏∏ Í∞ÄÎçò Ï§ëÏùò ÏäµÍ≤©", st: "unlocked", rw: "ÏóÜÏùå", items: [], ts: [], nxt: [2], lks: [] },
    2: { t: "Íµ¨Î©ç ÎÇú Î≤Ω", st: "locked", rw: "Í∞Å +25G, ÏïÑÏù¥ÌÖú 1~13 Ìï¥Í∏à", items: [1,2,3,4,5,6,7,8,9,10,11,12,13], ts: [{ id: 14, c: "ü™ôx3", owner: null }], nxt: [3], lks: [] },
    3: { t: "Í≤ÄÏùÄ Î∞∞", st: "locked", rw: "Í∞Å 1ÌäπÌòúÌè¨Ïù∏Ìä∏", items: [], ts: [], nxt: [4], lks: [] },
    4: { t: "ÏùòÏãùÏùò Ïû•ÏÜå", st: "locked", rw: "ÏïÑÏù¥ÌÖú 14 Ìï¥Í∏à", items: [14], ts: [{ id: 16, c: "#14 ÎßàÎÇò Ìè¨ÏÖò", owner: null }], nxt: [5], lks: [] },
    5: { t: "Ïç©Ïñ¥Í∞ÄÎäî ÏùÄÏã†Ï≤ò", st: "locked", rw: "Í∞Å +25exp", items: [], ts: [{ id: 9, c: "+5G", owner: null }], nxt: [6], lks: [] },
    6: { t: "Í≥µÌè¨Ïùò Ïú†Ï†Å", st: "locked", rw: "Í∞Å 1ÌäπÌòúÌè¨Ïù∏Ìä∏", items: [], ts: [], nxt: [7, 8], lks: [] },
    7: { t: "ÏßÄÌïò Í∞êÏò•", st: "locked", rw: "Í∞Å +20exp", items: [], ts: [{ id: 12, c: "+5G", owner: null }], nxt: [9], lks: [8] },
    8: { t: "ÏûêÏú†Î°úÏö¥ Î≥ÄÏ†àÏûê", st: "locked", rw: "ÏóÜÏùå", items: [], ts: [{ id: 4, c: "+5G", owner: null }], nxt: [9], lks: [7] },
    9: { t: "Ìè≠Î∞úÌïòÎäî Í∏∞Í≥Ñ", st: "locked", rw: "Í∞Å +20exp,ÏïÑÏù¥ÌÖú 15~20 Ìï¥Í∏à", items: [15,16,17,18,19,20], ts: [{ id: 1, c: "+10exp", owner: null }], nxt: [10], lks: [] },
    10: { t: "Í∞ÄÎ†§ÏßÑ ÌÉúÏñë", st: "locked", rw: "Í∞Å +15exp", items: [], ts: [{ id: 8, c: "ÌîºÌï¥3, Ï§ëÎèÖ", owner: null }], nxt: [11, 12], lks: [] },
    11: { t: "Î∂ÄÏÑúÏßÑ ÏßëÎã®", st: "locked", rw: "#28 Î≤ºÎ£©Ìà¨ÏÑ±Ïù¥ ÏàÑ", items: [28], ts: [], nxt: [13, 19], lks: [12] },
    12: { t: "ÌïòÏàòÎèÑ Ï•ê", st: "locked", rw: "#28 Î≤ºÎ£©Ìà¨ÏÑ±Ïù¥ ÏàÑ", items: [28], ts: [], nxt: [14, 18], lks: [11] },
    13: { t: "ÌîºÏùò ÏùòÏãù", st: "locked", rw: "ÏïÑÏù¥ÌÖú 30 Ìï¥Í∏à", items: [30], ts: [{ id: 5, c: "+10G", owner: null }], nxt: [15], lks: [] },
    14: { t: "Í∑∏Î¶ºÏûê ÏäµÍ≤©", st: "locked", rw: "Í∞Å 1ÌäπÌòúÌè¨Ïù∏Ìä∏", items: [], ts: [{ id: 15, c: "1ÌäπÌòúÌè¨Ïù∏Ìä∏", owner: null }], nxt: [15], lks: [] },
    15: { t: "ÌÉÄÏò§Î•¥Îäî Ïà≤", st: "locked", rw: "Í∞Å +10G, ÏïÑÏù¥ÌÖú 21~26 Ìï¥Í∏à", items: [21,22,23,24,25,26], ts: [], nxt: [16], lks: [] },
    16: { t: "Ïú†ÎèÖÌïú Í∞ÄÏä§", st: "locked", rw: "Í∞Å +15exp, #29 ÎåÄÌòï Î∞©Ìå®", items: [29], ts: [], nxt: [17], lks: [] },
    17: { t: "ÏûäÌòÄÏßÑ ÎèôÍµ¥", st: "locked", rw: "Í∞Å +25exp, +30G", items: [], ts: [{ id: 3, c: "+15exp", owner: null }], nxt: [], lks: [] },
    18: { t: "Î≤ÑÎ†§ÏßÑ Ïã§ÌóòÏã§", st: "locked", rw: "Í∞Å +10exp", items: [], ts: [{ id: 2, c: "#31 ÌûòÏùò Î∞òÏßÄ", owner: null }, { id: 6, c: "+10G", owner: null }, { id: 7, c: "+5G", owner: null }, { id: 13, c: "+5G", owner: null }], nxt: [], lks: [] },
    19: { t: "ÏµúÌõÑÏùò Î≥¥Î£®", st: "locked", rw: "#31 ÌûòÏùò Î∞òÏßÄ", items: [31], ts: [], nxt: [], lks: [] },
    20: { t: "Ïã¨Ïó∞Ïùò Î∂ÄÎ¶Ñ", st: "locked", rw: "Í∞Å +10G", items: [], ts: [{ id: 99, c: "#32 ÌöåÎ≥µÏùò Î∞òÏßÄ", owner: null }], nxt: [], lks: [] },
    21: { t: "Î∂âÏùÄ ÏïàÍ∞ú", st: "locked", rw: "Í∞Å +15G", items: [], ts: [{ id: 11, c: "#30 Ïã†ÏÜçÏùò Î∞òÏßÄ", owner: null }], nxt: [], lks: [] },
    22: { t: "ÌååÎ©∏Ïùò ÏÑúÎßâ", st: "locked", rw: "#33 Í∞ïÏ≤† Î∞òÏßÄ", items: [33], ts: [], nxt: [], lks: [] },
    23: { t: "ÌòºÎèàÏùò ÎèÑÍ∞ÄÎãà", st: "locked", rw: "#34 Í∞ÄÏãú ÎèãÏπú ÎèÑÎÅº", items: [34], ts: [], nxt: [], lks: [] },
    24: { t: "Í≥†ÎåÄÏùò Î∂ÄÎ¶Ñ", st: "locked", rw: "#35 Î™ÖÎ†πÏùò Î°úÎ∏å", items: [35], ts: [], nxt: [], lks: [] },
    25: { t: "ÏÇ¨ÏûêÏùò ÌÑ±", st: "locked", rw: "#36 Ï†úÌä∏ Ïû•Ìôî", items: [36], ts: [], nxt: [], lks: [] }
}

window.scenarioData = window.scenarioData || null;

/* ============================================================
   [SECTION 1] Í∏∞Ï¥à ÎèÑÍµ¨ (ÌôîÎ©¥ Ï†ÑÌôò, Î™®Îã¨, ÏïåÎ¶º)
   ============================================================ */

// 1. ÌôîÎ©¥ Ï†ÑÌôò (Screen Switcher)
window.showScreen = function(id) {
    const allScreens = document.querySelectorAll('.screen, section');
    allScreens.forEach(s => {
        s.classList.add('hidden');
        s.style.display = 'none';
    });

    const target = document.getElementById(id);
    if (target) {
        target.classList.remove('hidden');
        const displayType = (id === 'screen-job-select' || id === 'screen-home') ? 'flex' : 'block';
        target.style.setProperty('display', displayType, 'important');
        if(displayType === 'flex') target.style.flexDirection = 'column';
    }
    window.scrollTo(0, 0);
};


// 2. Î™®Îã¨ Ï†úÏñ¥ (Modal Control) - ÏàòÏ†ïÎ≥∏
window.closeModal = function(id) {
    console.log(`[Îã´Í∏∞ ÏãúÎèÑ] ID: ${id}`);
    const m = document.getElementById(id);
    if (m) {
        m.classList.remove('active');
        // Í∞ïÏ†úÎ°ú display: noneÏùÑ Î∞ïÏùå (Ïù¥Í≤å Îã§ÏùåÏóê Ïó¥ Îïå Î∞úÎ™©ÏùÑ Ïû°Ïùå)
        m.style.setProperty('display', 'none', 'important'); 
        console.log(`[Îã´Í∏∞ ÏôÑÎ£å]`);
    }
};

window.openModal = function(id) {
    const m = document.getElementById(id);
    if (m) {
        // [ÌïµÏã¨] closeModalÏù¥ Î∞ïÏïÑÎÜìÏùÄ display: none Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùºÏùÑ Ï†úÍ±∞!
        m.style.removeProperty('display'); 
        
        m.classList.remove('hidden');
        m.classList.add('active'); // active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä (ÏÉÅÏ†ê Î∞©Ïãù)
        console.log(`[UI] ${id} Ïó¥Í∏∞ ÏÑ±Í≥µ (Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Ï†úÍ±∞Îê®)`);
    }
};

// 3. Í≥µÌÜµ ÏïåÎ¶ºÏ∞Ω (Alert)
window.showAlert = function(title, message) {
    const titleEl = document.getElementById('alert-title');
    const msgEl = document.getElementById('alert-message');
    const overlay = document.getElementById('modal-global-alert'); // idÎ°ú ÏßÅÏ†ë Ï∞æÍ∏∞

    if (titleEl) titleEl.innerText = title;
    if (msgEl) msgEl.innerText = message;

    if (overlay) {
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] openModalÏùÑ ÎØøÏßÄ ÏïäÍ≥† ÏßÅÏ†ë ÌÅ¥ÎûòÏä§Î•º ÎïåÎ†§ÎÑ£Ïùå
        overlay.classList.remove('hidden');
        overlay.classList.add('active');
        
        // ÎßåÏïΩÏùò ÏÇ¨ÌÉúÎ•º ÎåÄÎπÑÌï¥ Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùºÎ°ú ÌôïÏã§Ìûà ÎèÑÏû• Ï∞çÍ∏∞
        overlay.style.display = 'flex';
        overlay.style.zIndex = '9999'; 
        
        console.log("üö© showAlert Í∞ïÏ†ú Ïã§Ìñâ ÏôÑÎ£å");
    }
};


/* ============================================================
   [SECTION 2] Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§ÎÑà & Î†åÎçîÎßÅ
   ============================================================ */

// Firebase Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ Í∞êÏãú
// [Ï£ºÏùò] Ìï®Ïàò Î∞ñÏóê Ïù¥ Î≥ÄÏàòÍ∞Ä ÏÑ†Ïñ∏ÎêòÏñ¥ ÏûàÏñ¥Ïïº Ï§ëÎ≥µ Ìá¥Ïû•ÏùÑ Î∞©ÏßÄÌï©ÎãàÎã§.
// ÌååÏùº ÏµúÏÉÅÎã®Ïóê ÏÑ†Ïñ∏ (ÌéòÏù¥ÏßÄ Î°úÎìú ÏãúÏ†ê Í∏∞Î°ù)
window.lastEntryTime = window.lastEntryTime || Date.now();

onValue(ref(db, 'parties'), (snapshot) => {
    const data = snapshot.val() || {};
    window.state.parties = data;

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const cName = window.state.currentCharacter;

    // --- [1. ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî] (Í∏∞Ï°¥ Ïú†ÏßÄ) ---
    if (pName && data[pName]) {
        const serverSc = data[pName].scenarioData;
        if (serverSc && Object.keys(serverSc).length > 0) {
            window.scenarioData = JSON.parse(JSON.stringify(serverSc));
        } else if (!window.scenarioData) {
            window.scenarioData = JSON.parse(JSON.stringify(SCENARIO_TEMPLATE));
        }
        
        if (window.scenarioData) {
            Object.values(window.scenarioData).forEach(sc => {
                if (sc && sc.st === 'completed' && sc.nxt) {
                    sc.nxt.forEach(nid => {
                        if (window.scenarioData[nid] && window.scenarioData[nid].st === 'locked') {
                            window.scenarioData[nid].st = 'unlocked';
                        }
                    });
                }
            });
            const scenarioPopup = document.getElementById('popup-scenario');
            if (scenarioPopup?.classList.contains('active')) {
                if (typeof window.renderScenarios === 'function') window.renderScenarios();
            }
        }
    }

    // --- [2. Ïã§ÏãúÍ∞Ñ Í∞ïÏ†ú Ìá¥Ïû• Î∞è Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏ ÎèôÍ∏∞Ìôî] ---
    if (cName && pName && data[pName]?.characters?.[cName]) {
        const char = data[pName].characters[cName];

        // [ÏûÖÏû• ÏãúÍ∞Ñ Í∏∞Ï§Ä Ìá¥Ïû• Î°úÏßÅ]
        // ÏÑúÎ≤ÑÏùò Î¶¨ÏÖã ÏãúÍ∞ÑÏù¥ Ï°¥Ïû¨ÌïòÍ≥†, Í∑∏ ÏãúÍ∞ÑÏù¥ ÎÇ¥Í∞Ä ÏãúÌä∏Ïóê Îì§Ïñ¥Ïò® ÏãúÍ∞Ñ(window.lastEntryTime)Î≥¥Îã§ ÏµúÏã†Ïù¥ÎùºÎ©¥ Ìá¥Ïû•!
        if (char.lastResetAt && Number(char.lastResetAt) > window.lastEntryTime) {
            const sheet = document.getElementById('modal-char-sheet');
            
            if (sheet && (sheet.classList.contains('active') || sheet.style.display !== 'none')) {
                console.warn(`[Í∞ïÏ†ú Ìá¥Ïû•] ${cName} Ï∫êÎ¶≠ÌÑ∞ Î¶¨ÏÖã Ïã†Ìò∏ Í∞êÏßÄ (ÏûÖÏû•ÏãúÍ∞Ñ Ïù¥ÌõÑ Î∞úÏÉù)`);
                
                // Ï†ÑÏó≠ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                window.state.currentCharacter = null;

                // UI Îã´Í∏∞ (ÌÅ¥ÎûòÏä§ Í∏∞Î∞ò Ï†ëÍ∑º)
                sheet.classList.remove('active');
                sheet.classList.add('hidden');
                sheet.style.display = 'none';

                // Í≥µÌÜµ ÏïåÎ¶ºÏ∞Ω ÎùÑÏö∞Í∏∞
                if (typeof window.showGlobalAlert === 'function') {
                    window.showGlobalAlert("Ìï¥Îãπ Ï∫êÎ¶≠ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏñ¥ Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.");
                }
                return; // Ìá¥Ïû•ÌñàÏúºÎØÄÎ°ú ÏïÑÎûò UI ÏóÖÎç∞Ïù¥Ìä∏Îäî Ïã§ÌñâÌïòÏßÄ ÏïäÏùå
            }
        }

        // --- [Í∏∞Ï°¥ Ïã§ÏãúÍ∞Ñ UI ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ] ---
        const currentExp = Number(char.exp) || 0;
        let currentLevel = 1;
        const table = window.lvTable || [0, 45, 95, 150, 210, 275, 345, 420, 500];

        for (let i = 1; i <= table.length; i++) {
            if (currentExp >= table[i - 1]) currentLevel = i;
        }

        if (typeof window.updateSheetUI === 'function') {
            window.updateSheetUI(currentExp, currentLevel, char.gold || 0);
        }

        const lvNumEl = document.getElementById('sheet-lv-num');
        if (lvNumEl) lvNumEl.textContent = currentLevel;

        if (typeof window.renderShopItems === 'function') window.renderShopItems('Ï†ÑÏ≤¥');
        if (typeof window.renderBagItems === 'function') window.renderBagItems('Ï†ÑÏ≤¥');

        const pkPopup = document.getElementById('popup-perks');
        if (pkPopup?.classList.contains('active') && typeof window.renderPerks === 'function') {
            window.renderPerks();
        }
    }

    // ÌïòÎã® Î¶¨Ïä§Ìä∏ Í∞±Ïã† (Í∏∞Ï°¥ Ïú†ÏßÄ)
    if (typeof window.renderPartyList === 'function') window.renderPartyList();
    if (pName && data[pName]?.characters && typeof window.renderJobList === 'function') {
        window.renderJobList();
    }
});

// --- [saveScenarioToFirebase: ÏãúÎÇòÎ¶¨Ïò§ ÏÑúÎ≤Ñ Ï†ÄÏû• Ìï®Ïàò] ---
window.saveScenarioToFirebase = async function() {
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    if (!pName || !window.scenarioData) return;

    try {
        const { ref, update, getDatabase } = window.FB_DB;
        const db = getDatabase();
        const updates = {};
        
        // Ìï¥Îãπ ÌååÌã∞Ïùò scenarioDataÎßå Ï†ïÎ∞Ä ÌÉÄÍ≤©ÌïòÏó¨ Ï†ÄÏû•
        updates[`parties/${pName}/scenarioData`] = window.scenarioData;
        
        await update(ref(db), updates);
        console.log(`‚úÖ [Firebase] ${pName} ÌååÌã∞ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å`);
    } catch (e) {
        console.error("‚ùå ÏãúÎÇòÎ¶¨Ïò§ ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®:", e);
    }
};



window.renderPartyList = function() {
    const listContainer = document.getElementById('party-list');
    const display = document.getElementById('selected-party-display');
    
    if (!listContainer) return; 

    listContainer.innerHTML = '';
    const partyNames = Object.keys(window.state.parties || {});

    if (partyNames.length === 0) {
        if (display) display.innerText = "ÌååÌã∞Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî";
        return;
    }

    // [ÏàòÏ†ï] ÎßàÏßÄÎßâ Ï†ëÏÜç ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
    partyNames.sort((a, b) => {
        const timeA = window.state.parties[a].lastAccessed || 0;
        const timeB = window.state.parties[b].lastAccessed || 0;
        return timeB - timeA;
    });

    partyNames.forEach(name => {
        const li = document.createElement('li');
        li.style = "padding: 12px; border-bottom: 1px solid #333; cursor: pointer; text-align: center; color: #fff; transition: 0.2s;";
        li.innerText = name; 

        li.onclick = (e) => {
            e.stopPropagation(); 
            window.selectPartyInHome(name);
            window.togglePartyList();
        };
        
        listContainer.appendChild(li);
    });

    // [ÏàòÏ†ï] ÏÑ†ÌÉùÎêú ÌååÌã∞Í∞Ä ÏóÜÏúºÎ©¥ 'ÎßàÏßÄÎßâ Ï†ëÏÜç ÌååÌã∞(Ï†ïÎ†¨ Ï≤´Î≤àÏß∏)'Î•º ÏûêÎèô ÏÑ†ÌÉù
    if (!window.state.homeSelectedParty && partyNames.length > 0) {
        window.selectPartyInHome(partyNames[0]);
    }
};

/* [HOME: ACTIONS] ÌååÌã∞ ÏÑ†ÌÉù, ÏûÖÏû•, ÏÇ≠Ï†ú Ìï∏Îì§ÎßÅ */
window.selectPartyInHome = function(name) {
    // [ÏàòÏ†ï] ÎßàÏßÄÎßâ Ï†ëÏÜç ÏãúÍ∞Ñ Í∏∞Î°ù Î∞è ÏßÅÏ†ë DB Ï†ÄÏû•
    if (window.state.parties[name]) {
        const now = Date.now();
        window.state.parties[name].lastAccessed = now;
        
        // Ìï®Ïàò Ìò∏Ï∂ú ÎåÄÏã† ÏßÅÏ†ë Firebase Í≤ΩÎ°úÏóê ÏóÖÎç∞Ïù¥Ìä∏
        const partyRef = ref(db, `parties/${name}`);
        update(partyRef, { lastAccessed: now }).catch(err => console.error("ÏãúÍ∞Ñ Ï†ÄÏû• Ïã§Ìå®:", err));
    }

    // 1. ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    window.state.homeSelectedParty = name;
    
    // 2. Ï§ëÏïô Ïπ∏Ïóê Ïù¥Î¶Ñ ÌëúÏãú
    const display = document.getElementById('selected-party-display');
    if (display) {
        display.innerText = name;
        display.style.color = "var(--accent)";
    }
    
    // 3. ÏûÖÏû•/ÏÇ≠Ï†ú Î≤ÑÌäº ÌôúÏÑ±Ìôî Î∞è Ïä§ÌÉÄÏùº Ï†úÏñ¥
    const enterBtn = document.getElementById('btn-party-enter');
    const deleteBtn = document.getElementById('btn-party-delete');
    
    if (enterBtn) {
        enterBtn.disabled = false;
        enterBtn.style.opacity = "1";
        enterBtn.style.cursor = "pointer";
    }
    if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.style.opacity = "1";
        deleteBtn.style.background = "#444";
        deleteBtn.style.color = "#ff4444";
        deleteBtn.style.border = "1px solid #ff4444";
        deleteBtn.style.cursor = "pointer";
    }
};

/* ÏûÖÏû• Ïã§Ìñâ */
window.enterSelectedParty = function() {
    if (window.state.homeSelectedParty) {
        window.selectPartyByName(window.state.homeSelectedParty);
    } else {
        window.showAlert("ÏïåÎ¶º", "ÏûÖÏû•Ìï† ÌååÌã∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
    }
};

window.deleteSelectedParty = function() {
    // Î≤ÑÌäºÏù¥ ÌôúÏÑ±ÌôîÎêú ÏÉÅÌÉúÏóêÏÑú ÎàåÎ¶¨ÎØÄÎ°ú, Î∞îÎ°ú Ìï∏Îì§Îü¨Î°ú ÎÑòÍπÅÎãàÎã§.
    if (window.state.homeSelectedParty) {
        window.handlePartyDelete(window.state.homeSelectedParty);
    }
};

/* ============================================================
   [SECTION 3] ÏßÅÏóÖ ÏÑ†ÌÉù Î°úÏßÅ
   ============================================================ */
window.renderJobList = function() {
    const container = document.getElementById('job-list-container');
    const party = window.state.parties[window.state.currentPartyName];
    if (!container || !party) return;
    
    container.innerHTML = '';
    
    // [Í∏∞ÏñµÌïòÏã† ÎåÄÎ°ú Ìï®Ïàò ÎÇ¥Î∂ÄÏóê ÏÑ†Ïñ∏]
    const jobs = [
        { name: 'Ï†ÅÏúÑÎ≥ë', img: 'rg1.jpg', fullImg: 'rg.jpg' },
        { name: 'ÎèÑÎÅºÌà¨Ï≤ôÏàò', img: 'hc1.jpg', fullImg: 'hc.jpg' },
        { name: 'Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä', img: 'dm1.jpg', fullImg: 'dm.jpg' },
        { name: 'Í≥µÌóàÍ∞êÏãúÏûê', img: 'vw1.jpg', fullImg: 'vw.jpg' }
    ];

    jobs.forEach(job => {
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] characters Îí§Ïóê ? Î•º Î∂ôÏó¨ undefined ÏóêÎü¨Î•º Î∞©ÏßÄÌï©ÎãàÎã§.
        const charData = party.characters?.[job.name];
        const isOccupied = charData && charData.playerName !== '';
        
        const card = document.createElement('div');
        card.className = `job-card-v ${isOccupied ? 'occupied' : ''}`;
        
        card.onclick = () => {
            if (isOccupied) {              
                window.openDetailSheet(job.name, job.fullImg);
            } else {
                const input = document.getElementById(`input-${job.name}`);
                if (input) input.focus();
            }
        };
        
        card.innerHTML = `
            <img src="${job.img}" class="job-character-img" alt="${job.name}">
            <div class="card-overlay">
                <div class="job-info-row">
                    <span style="color:var(--accent); font-weight:bold; font-size:1.2rem;">${job.name}</span>
                    <span style="margin-top: 5px; font-size: 0.8rem; color: #ccc;">
                        ${isOccupied ? charData.playerName : 'ÏÑ†ÌÉù Í∞ÄÎä•'}
                    </span>
                </div>
                ${!isOccupied ? `
                <div class="input-area" onclick="event.stopPropagation()">
                    <input type="text" id="input-${job.name}" class="underline-input" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" onkeyup="if(event.keyCode==13) window.startJourney('${job.name}')">
                    <button class="btn-small-confirm" onclick="window.startJourney('${job.name}')">ÌôïÏù∏</button>
                </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    });
};

window.startJourney = async function(job) {
    const inputEl = document.getElementById(`input-${job}`);
    if (!inputEl) return;

    const pName = inputEl.value.trim();
    
    // [Î≥¥Ï†ï] modal-global-alert ÏÇ¨Ïö©
    if (!pName) {
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = "ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.";
        window.openModal('modal-global-alert');
        return;
    }
    
    try {
        const { getDatabase, ref, update } = window.FB_DB; 
        const dbRef = getDatabase();

        await update(ref(dbRef, `parties/${window.state.currentPartyName}/characters/${job}`), { 
            playerName: pName,
            job: job 
        });

        if (window.state.parties[window.state.currentPartyName]) {
            const char = window.state.parties[window.state.currentPartyName].characters[job];
            char.playerName = pName;
            char.job = job;
        }
        
        window.renderJobList();

        const fullImgMap = { 'Ï†ÅÏúÑÎ≥ë': 'rg.jpg', 'ÎèÑÎÅºÌà¨Ï≤ôÏàò': 'hc.jpg', 'Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä': 'dm.jpg', 'Í≥µÌóàÍ∞êÏãúÏûê': 'vw.jpg' };
        window.openDetailSheet(job, fullImgMap[job]);

    } catch (e) {
        console.error("Ï†ÄÏû• Ïã§Ìå®:", e);
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.";
        window.openModal('modal-global-alert');
    }
};

/* ============================================================
   [SECTION 4] ÌååÌã∞ Í¥ÄÎ¶¨ (ÏÉùÏÑ±, ÏÇ≠Ï†ú, ÏßÑÏûÖ)
   ============================================================ */
/* [HOME: PARTY-LIST] ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä */
window.togglePartyList = function(e) {
    if (e) e.stopPropagation();
    const list = document.getElementById('party-list');
    if (!list) return;

    list.classList.toggle('hidden');

    // Ïó¥Î†∏ÏùÑ ÎïåÎßå Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄ Î¶¨Ïä§ÎÑàÎ•º ÌïúÏãúÏ†ÅÏúºÎ°ú Îì±Î°ù
    if (!list.classList.contains('hidden')) {
        const closeOnOut = (ev) => {
            if (!list.contains(ev.target)) {
                list.classList.add('hidden');
                document.removeEventListener('mousedown', closeOnOut);
            }
        };
        document.addEventListener('mousedown', closeOnOut);
    }
};


window.confirmPartyName = async function() {
    const input = document.getElementById('input-party-name');
    if (!input) return;
    
    const name = input.value.trim();

    if (!name) {
        // Í≥µÌÜµ ÏïåÎ¶ºÏ∞Ω ÏÇ¨Ïö© (Ï†ÄÏû•Îêú Ï†ïÎ≥¥ Î∞òÏòÅ)
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = "ÌååÌã∞ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
        window.openModal('modal-global-alert');
        return;
    }
    const initialData = typeof SCENARIO_TEMPLATE !== 'undefined' 
        ? JSON.parse(JSON.stringify(SCENARIO_TEMPLATE)) 
        : {};

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÏÉÅÏ†ê Ìï¥Í∏à ÌïÑÎìúÎ™Ö ÌÜµÏùº Î∞è ÏãúÎÇòÎ¶¨Ïò§/Ïù¥Î≤§Ìä∏ Îπà ÍªçÎç∞Í∏∞ Ï∂îÍ∞Ä
    const newPartyData = {
        partyName: name,
        createdAt: new Date().toISOString(),
        lastAccessed: Date.now(),
        unlockedItems: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], // Ï¥àÍ∏∞ 1~12Î≤à Ìï¥Í∏à Î≥¥Ïû•
        scenarioData: initialData,            // ÏãúÎÇòÎ¶¨Ïò§ Ï¥àÍ∏∞ Íµ¨Ï°∞
        cityEvents: { deck: [], discard: [] },                 // ÎèÑÏãú Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞ Íµ¨Ï°∞
        characters: {
            'Ï†ÅÏúÑÎ≥ë': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
            'ÎèÑÎÅºÌà¨Ï≤ôÏàò': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
            'Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
            'Í≥µÌóàÍ∞êÏãúÏûê': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} }
        }
    };

    try {
        await set(ref(db, `parties/${name}`), newPartyData);
        window.closeModal('modal-party-name');
        input.value = '';
        
        window.selectPartyInHome(name);
        // ÏÉùÏÑ± ÏÑ±Í≥µ ÏïåÎ¶º
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = `[${name}] ÌååÌã∞Í∞Ä Ï∞ΩÏÑ§ÎêòÏóàÏäµÎãàÎã§!`;
        window.openModal('modal-global-alert');
        
    } catch (e) {
        console.error("ÌååÌã∞ ÏÉùÏÑ± Ïã§Ìå®:", e);
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = "Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.";
        window.openModal('modal-global-alert');
    }
};

window.selectPartyByName = function(name) {
    window.state.currentPartyName = name;
    document.getElementById('display-party-name').innerText = name;
    window.showScreen('screen-job-select');
    window.renderJobList();
};

window.handlePartyDelete = function(name) {
    const titleEl = document.getElementById('confirm-title');
    const msgEl = document.getElementById('confirm-message');
    const actionBtn = document.getElementById('confirm-action-btn');

    if (!titleEl || !msgEl || !actionBtn) {
        console.error("ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨Ïùò HTML ÏöîÏÜåÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.");
        return;
    }

    titleEl.innerText = "ÌååÌã∞ ÏÇ≠Ï†ú";
    msgEl.innerHTML = `üè∞ <b>${name}</b> ÌååÌã∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? <br><small style="color:red;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.</small>`;
    
    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] executeDeleteÍ∞Ä ÏïÑÎãå executePartyDeleteÎ•º Ìò∏Ï∂úÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
    actionBtn.onclick = () => window.executePartyDelete(name);
    
    window.openModal('modal-global-confirm');
};


// [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÌååÌã∞ Ï†ÑÏö© ÏÇ≠Ï†ú Ïã§Ìñâ Ìï®Ïàò Ï∂îÍ∞Ä
window.executePartyDelete = function(name) {
    if (!name) return;

    const partyRef = ref(db, `parties/${name}`);
    remove(partyRef)
        .then(() => {
                window.state.homeSelectedParty = null;
            location.reload(); 
        }) 
        .catch((err) => {
         
            console.error("ÌååÌã∞ ÏÇ≠Ï†ú Ïã§Ìå®:", err);
            alert("ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        });
};


// [1] ÏãúÌä∏ ÏßÑÏûÖ Î∞è Îç∞Ïù¥ÌÑ∞ Î°úÎìú
// lvTableÏùÑ Ï†ÑÏó≠(window) Í∞ùÏ≤¥Ïóê Îã¥ÏïÑ Ïñ¥ÎîîÏÑúÎì† Ï†ëÍ∑º Í∞ÄÎä•ÌïòÍ≤å Ìï©ÎãàÎã§.
window.lvTable = [0, 45, 95, 150, 210, 275, 345, 420, 500];
const lvTable = window.lvTable; // Í∏∞Ï°¥ ÏΩîÎìú Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ



// [ÏãúÌä∏ ÏßÑÏûÖ]
window.openDetailSheet = function(jobName, fullImgName) {
    const partyName = window.state.currentPartyName;
    const charData = window.state.parties[partyName]?.characters?.[jobName];
    if (!charData) return;

    // --- [ÌïµÏã¨ ÏàòÏ†ï: ÏûÖÏû• ÏãúÍ∞Ñ Í∏∞Î°ù] ---
    // ÏãúÌä∏Ïóê ÏßÑÏûÖÌïòÎäî 'ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ'ÏùÑ Í∏∞Î°ùÌï©ÎãàÎã§. 
    // Ïù¥ ÏãúÍ∞Ñ Ïù¥ÌõÑÏóê Î∞úÏÉùÌïòÎäî ÏÑúÎ≤Ñ Î¶¨ÏÖã Ïã†Ìò∏ÏóêÎßå Î∞òÏùëÌïòÍ≤å Îê©ÎãàÎã§.
    window.lastEntryTime = Date.now();
    window.state.currentCharacter = jobName; 

    // [Îç∞Ïù¥ÌÑ∞ Î≥¥Ï†ï Î°úÏßÅ]
    const requiredFields = {
        items: charData.items || [],
        checkedPerks: charData.checkedPerks || {},
        battleGoals: charData.battleGoals || [false, false, false],
        perkPoints: charData.perkPoints || 0
    };
    const needsFix = !charData.items || !charData.checkedPerks || !charData.battleGoals;
    if (needsFix) {
        const { ref, update, getDatabase } = window.FB_DB; 
        const db = getDatabase();
        const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
        update(charRef, requiredFields); 
    }

    // UI Îß§Ìïë
    const portraitImg = document.getElementById('sheet-character-portrait');
    const jobNameEl = document.getElementById('sheet-job-name');
    const playerNameEl = document.getElementById('sheet-player-name');
    const lvNumEl = document.getElementById('sheet-lv-num');
    const expInput = document.getElementById('input-exp');
    const goldInput = document.getElementById('input-gold');

    if (portraitImg) portraitImg.src = `${fullImgName || 'default.jpg'}`;
    if (jobNameEl) jobNameEl.textContent = jobName; 
    if (playerNameEl) playerNameEl.textContent = charData.playerName || "Ïù¥Î¶Ñ ÏóÜÏùå";
    if (lvNumEl) lvNumEl.textContent = charData.lv || "1";
    if (expInput) expInput.value = charData.exp || 0;
    if (goldInput) goldInput.value = charData.gold || 0;

    // --- [UI ÌëúÏãú Î∞è Ïû¨ÏßÑÏûÖ Ï≤òÎ¶¨] ---
    const sheet = document.getElementById('modal-char-sheet');
    if (sheet) {
        // 1. Í∏∞Ï°¥Ïóê ÎÇ®ÏïòÏùÑ Ïàò ÏûàÎäî Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Ï†úÍ±∞
        sheet.style.removeProperty('display'); 
        
        // 2. ÌÅ¥ÎûòÏä§ Ï†úÏñ¥ (active Ï∂îÍ∞ÄÎ°ú ÌôîÎ©¥ ÌëúÏãú)
        sheet.classList.remove('hidden');
        sheet.classList.add('active'); 

        // 3. Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è UI Í∞±Ïã†
        if (typeof window.loadCharacterData === 'function') {
            window.loadCharacterData(jobName);
        }
        if (typeof window.updateSheetUI === 'function') {
            const table = window.lvTable || [0, 45, 95, 150, 210, 275, 345, 420, 500];
            const currentExp = Number(charData.exp) || 0;
            let currentLevel = 1;
            for (let i = 1; i <= table.length; i++) {
                if (currentExp >= table[i - 1]) currentLevel = i;
            }
            window.updateSheetUI(currentExp, currentLevel, charData.gold || 0);
        }
        
        console.log(`[UI] ÏÉÅÏÑ∏ ÏãúÌä∏ ÏûÖÏû• ÏôÑÎ£å (Í∏∞Ï§Ä ÏãúÍ∞Ñ: ${window.lastEntryTime})`);
    }
};

// [Ïù¥Î¶Ñ ÏàòÏ†ï]
window.openNameEditModal = function() {
    console.log("1. Ìï®Ïàò ÏßÑÏûÖ"); 
    const party = window.state.parties[window.state.currentPartyName];
    const job = window.state.currentCharacter;
    
    console.log("2. Ï≤¥ÌÅ¨:", { partyName: window.state.currentPartyName, job: job });

    if (!party || !job) {
        console.warn("3. Ï§ëÎã®Îê®: ÌååÌã∞ÎÇò ÏßÅÏóÖ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
        return;
    }

    const input = document.getElementById('input-edit-name');
    if(input) {
        input.value = party.characters[job].playerName || "";
        console.log("4. Î™®Îã¨ Ïó¥Í∏∞ Ïã§Ìñâ");
        window.openModal('modal-name-edit');
        setTimeout(() => input.select(), 100);
    }
};

window.confirmNameEdit = async function() {
    const newName = document.getElementById('input-edit-name').value.trim();
    if (!newName) return;
    
    const partyName = window.state.currentPartyName;
    const job = window.state.currentCharacter;

    try {
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏïÑÎãå Ìï¥Îãπ ÏßÅÏóÖÏùò playerNameÎßå ÏóÖÎç∞Ïù¥Ìä∏
        await update(ref(db, `parties/${partyName}/characters/${job}`), { playerName: newName });
        
        // UI Ï¶âÏãú Î∞òÏòÅ
        const nameElem = document.getElementById('sheet-player-name');
        if (nameElem) nameElem.innerText = newName;
        
        window.closeModal('modal-name-edit');
        console.log(`‚úÖ [${job}] Ïù¥Î¶ÑÏù¥ '${newName}'ÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
    } catch (e) { 
        window.showAlert("Ïò§Î•ò", "Ïù¥Î¶Ñ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        console.error(e); 
    }
};

window.executeReset = function() {
    const partyName = window.state.currentPartyName;
    const jobName = window.state.currentCharacter;
    
    if (!partyName || !jobName) return;

    // 1. Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Îßµ (Í∏∞Ï°¥ Î∞±ÏóÖÎ≥∏ Ïú†ÏßÄ)
    const initialDataMap = {
        'Ï†ÅÏúÑÎ≥ë': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
        'ÎèÑÎÅºÌà¨Ï≤ôÏàò': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
        'Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} },
        'Í≥µÌóàÍ∞êÏãúÏûê': { playerName: '', exp: 0, gold: 0, lv: 1, items: [], perkPoints: 0, battleGoals: [false, false, false], checkedPerks: {} }
    };

    // Firebase Ï∞∏Ï°∞ (db Í∞ùÏ≤¥ ÌôïÏù∏ ÌïÑÏöî)
    const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
    
    // [ÌïµÏã¨ ÏàòÏ†ï] Í∏∞Ï°¥ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ + lastResetAt Ïã†Ìò∏ÌÉÑ Ï∂îÍ∞Ä
    const resetData = {
        ...(initialDataMap[jobName] || { playerName: '', exp: 0, gold: 0, lv: 1 }),
        lastResetAt: Date.now() // <-- Ïù¥ Ïã†Ìò∏Í∞Ä ÏûàÏñ¥Ïïº Ïã§ÏãúÍ∞Ñ Ìá¥Ïû•Ïù¥ ÏûëÎèôÌï©ÎãàÎã§!
    };

    // update ÎåÄÏã† setÏùÑ ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò, resetData Ï†ÑÏ≤¥Î•º update Ìï©ÎãàÎã§.
    update(charRef, resetData)
        .then(() => {
            // 1. Î≥∏Ïù∏ ÌôîÎ©¥ Ï¶âÏãú Îã´Í∏∞ (Ïû¨ÏßÑÏûÖ Ïãú Î≤ÑÍ∑∏ Î∞©ÏßÄ)
            const sheet = document.getElementById('modal-char-sheet');
            if (sheet) {
                window.state.currentCharacter = null;
                sheet.classList.remove('active');
                sheet.classList.add('hidden');
                sheet.style.display = 'none';
            }

            // 2. Ïª®Ìéå Î™®Îã¨ Îã´Í∏∞
            window.closeModal('modal-reset-confirm');
            
            // 3. ÏïåÎ¶ºÏ∞Ω (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
            if (typeof window.showGlobalAlert === 'function') {
                window.showGlobalAlert("Ï∫êÎ¶≠ÌÑ∞ Ï¥àÍ∏∞ÌôîÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
            }
            
            console.log(`[ÏÑ±Í≥µ] ${jobName} Ï¥àÍ∏∞Ìôî Î∞è Ïã†Ìò∏ÌÉÑ Î∞úÏÜ° ÏôÑÎ£å`);
        })
        .catch((error) => console.error("Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error));
};

// [Í≤ΩÌóòÏπò ÏûÖÎ†• Î∞è ÏûêÎèô Î†àÎ≤®ÏóÖ]
window.handleExpInput = async function(val) {
    const exp = parseInt(val) || 0;
    const partyName = window.state.currentPartyName;
    const job = window.state.currentCharacter;
    
    // ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞Ïùò Í∏∞Ï°¥ Í≥®Îìú Ï†ïÎ≥¥Î•º ÎØ∏Î¶¨ ÌôïÎ≥¥Ìï©ÎãàÎã§.
    const currentCharData = window.state.parties[partyName]?.characters[job];
    const currentGold = currentCharData?.gold || 0;

    // Î†àÎ≤® Í≥ÑÏÇ∞ Î°úÏßÅ
    let level = 1;
    for(let i = 1; i <= lvTable.length; i++) {
        if(exp >= lvTable[i-1]) level = i;
    }

    try {
        await update(ref(db, `parties/${partyName}/characters/${job}`), { exp: exp, lv: level });
        
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ïù¥Ï†ú Í≥®ÎìúÍπåÏßÄ 'ÏÇºÏ¥ùÏÇ¨'Î•º ÏôÑÏÑ±Ìï¥ÏÑú Î≥¥ÎÉÖÎãàÎã§.
        window.updateSheetUI(exp, level, currentGold);
    } catch (e) { console.error("Í≤ΩÌóòÏπò Ï†ÄÏû• Ïã§Ìå®", e); }
};

window.updateSheetUI = function(exp, level, gold) {
    const currentExp = Number(exp) || 0;
    const currentLv = Number(level) || 1;
    const currentGold = Number(gold) || 0; 

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ï†ÑÏó≠Ïóê ÏÑ†Ïñ∏Îêú lvTableÏùÑ ÏïàÏ†ÑÌïòÍ≤å Í∞ÄÏ†∏ÏòµÎãàÎã§.
    const table = window.lvTable || [0, 45, 95, 150, 210, 275, 345, 420, 500];

    const lvNumElem = document.getElementById('sheet-lv-num');
    if (lvNumElem) lvNumElem.innerText = currentLv;

    const expInput = document.getElementById('input-exp');
    if (expInput) expInput.value = currentExp;

    const sheetModal = document.getElementById('modal-char-sheet');
    if (sheetModal) {
        const goldInput = sheetModal.querySelector('#input-gold'); 
        if (goldInput) {
            if (isNaN(currentGold)) {
                console.error("üö® Í≥®Îìú Îç∞Ïù¥ÌÑ∞ Ïù¥ÏÉÅ Î∞úÏÉù: ", gold);
            } else {
                goldInput.value = currentGold;
            }
        }
    }

    // --- [Í≤ΩÌóòÏπò Î∞î Í≥ÑÏÇ∞ Î°úÏßÅ ÏàòÏ†ï] ---
    // Ï†ÑÏó≠ÏóêÏÑú Í∞ÄÏ†∏Ïò® table Î≥ÄÏàòÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.
    const minExp = table[currentLv - 1] || 0;
    const maxExp = table[currentLv] || 500;
    const nextLvLabel = (currentLv < 9) ? (currentLv + 1) : 'MAX';

    const infoElem = document.getElementById('next-lv-info');
    if (infoElem) {
        infoElem.innerText = (currentLv < 9) ? `LV.${nextLvLabel} (${maxExp})` : "MAX";
    }

    const fillElem = document.getElementById('sheet-exp-fill');
    if (fillElem) {
        // currentLvÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏñ¥ Îì§Ïñ¥Ïò§ÎØÄÎ°ú, Ïù¥Ï†ú progressÍ∞Ä 100%Î•º ÎÑòÏßÄ ÏïäÍ≥† ÏÉà Î†àÎ≤® Í∏∞Ï§ÄÏúºÎ°ú Í≥ÑÏÇ∞Îê©ÎãàÎã§.
        let progress = (currentLv >= 9) ? 100 : ((currentExp - minExp) / (maxExp - minExp)) * 100;
        fillElem.style.width = Math.min(Math.max(progress, 0), 100) + "%";
    }
};

window.updateDifficultyBar = function() {
    const party = window.state.parties[window.state.currentPartyName];
    // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶ÑÏù¥ ÏûàÎäî Ï∫êÎ¶≠ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ
    const activeChars = Object.values(party.characters).filter(c => c.playerName && c.playerName !== '');
    
    if (activeChars.length === 0) return;

    const totalLv = activeChars.reduce((sum, c) => sum + (parseInt(c.lv) || 1), 0);
    const avg = totalLv / activeChars.length;
    const scenarioLv = Math.ceil(avg / 2);

    const headerLv = document.getElementById('header-scenario-lv');
    if (headerLv) headerLv.innerText = scenarioLv;
    
    return { avg: avg.toFixed(1), scenarioLv: scenarioLv };
};

window.openDifficultyModal = function() {
    const diffData = window.updateDifficultyBar();
    if(!diffData) return;

    const valBaseLv = document.getElementById('val-base-lv');
    const valAvgLv = document.getElementById('val-avg-lv');
    
    if(valAvgLv) valAvgLv.innerText = diffData.avg;
    if(valBaseLv) valBaseLv.innerText = diffData.scenarioLv;

    window.calcDifficulty(0); 
    window.openModal('modal-difficulty');
};

window.calcDifficulty = function(diff, btn) {
    // 1. Í∏∞Ï§Ä Î†àÎ≤® Í∞ÄÏ†∏Ïò§Í∏∞ (ÏãúÎÇòÎ¶¨Ïò§ Î†àÎ≤® Ìó§Îçî Í∏∞Ï§Ä)
    const headerLv = document.getElementById('header-scenario-lv');
    const baseLv = parseInt(headerLv ? headerLv.innerText : 1) || 1;
    const targetLv = Math.max(0, baseLv + diff);

    // 2. Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (sc- Ï†ëÎëêÏÇ¨ Î∞òÏòÅ)
    if (btn) {
        // Î™®Îì† ÎÇúÏù¥ÎèÑ Î≤ÑÌäºÏóêÏÑú active Ï†úÍ±∞ ÌõÑ ÌÅ¥Î¶≠Ìïú Î≤ÑÌäºÎßå Ï∂îÍ∞Ä
        document.querySelectorAll('.sc-diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // 3. Í≤∞Í≥º ÌëúÏãú ÏóòÎ¶¨Î®ºÌä∏ ÌôïÎ≥¥
    const resMonster = document.getElementById('res-monster');
    const resCoin = document.getElementById('res-coin');
    const resTrap = document.getElementById('res-trap');
    const resXp = document.getElementById('res-xp');

    // 4. Í≤∞Í≥ºÍ∞í Îß§Ìïë Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
    if(resMonster) resMonster.innerText = targetLv;
    
    // Í≥®Îìú Î∞∞Ïàò Í≥µÏãù: Î†àÎ≤® 0 Ïù¥ÌïòÎ©¥ x2, 7 Ïù¥ÏÉÅÏù¥Î©¥ x6, Í∑∏ Ïô∏Ïóî Î†àÎ≤®/2 + 2
    if(resCoin) {
        const coinMult = targetLv <= 0 ? 2 : (targetLv >= 7 ? 6 : Math.floor(targetLv / 2) + 2);
        resCoin.innerText = `x${coinMult}`;
    }
    
    // Ìï®Ï†ï ÌîºÌï¥ Î∞è Ï∂îÍ∞Ä Í≤ΩÌóòÏπò ÏóÖÎç∞Ïù¥Ìä∏
    if(resTrap) resTrap.innerText = targetLv + 2; 
    if(resXp) resXp.innerText = `+${targetLv * 2 + 4}`;
};

// [ÌöçÎìùÎüâ Ìï©ÏÇ∞ Ï†ÄÏû•]
window.addStatOnBlur = async function(type) {
    const job = window.state.currentCharacter;
    const partyName = window.state.currentPartyName;
    const addInput = document.getElementById(`add-${type}-input`);
    
    if (!addInput || !addInput.value || !job) return;

    const addValue = parseInt(addInput.value) || 0;
    if (addValue === 0) { addInput.value = ""; return; }

    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏ÏôÄÏÑú Ìï©ÏÇ∞
    const currentVal = window.state.parties[partyName].characters[job][type] || 0;
    const newTotal = currentVal + addValue;

    try {
        const charRef = ref(db, `parties/${partyName}/characters/${job}`);
        await update(charRef, { [type]: newTotal });
        
        // Í≤ΩÌóòÏπòÏùº Í≤ΩÏö∞ Î†àÎ≤®ÏóÖ Î°úÏßÅ Ïã§Ìñâ
        if (type === 'exp') window.handleExpInput(newTotal);
        
        addInput.value = ''; // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        console.log(`${type} ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newTotal}`);
    } catch (e) {
        console.error("Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®", e);
    }
};


// [Í≥®Îìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏]
window.updateGoldDisplay = function() {
    const job = window.state.currentCharacter;
    const partyName = window.state.currentPartyName;
    
    const charData = window.state.parties[partyName]?.characters?.[job];
    if (!charData) return;

    const gold = charData.gold || 0;
   
    document.querySelectorAll('.current-gold-display').forEach(el => {
        el.innerText = `${gold}G`; 
    });

    const goldInput = document.getElementById('input-gold');
    if (goldInput) goldInput.value = gold;
};

/* ============================================================
    [SECTION: ITEM SYSTEM] ÏÉÅÏ†ê Î∞è Í∞ÄÎ∞© Í¥ÄÎ¶¨ (window. Î∞©Ïãù)
   ============================================================ */

/* [SECTION: UI CONTROL] */

window.openShop = function() {
    const shopPopup = document.getElementById('sh-popup'); // ID ÏàòÏ†ï: sh-popup
    if (!shopPopup) {
        console.error("ÏÉÅÏ†ê ÌåùÏóÖ(sh-popup)ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
    }

    shopPopup.style.display = 'flex';
    
    setTimeout(() => {
        shopPopup.classList.add('active');
    }, 10);

    // ÎÇ¥Î∂Ä Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
    window.updateGoldDisplay(); 
    window.renderShopItems('Ï†ÑÏ≤¥');
};

// 2. ÏÉÅÏ†ê Îã´Í∏∞
window.closeShop = function() {
    const shopPopup = document.getElementById('sh-popup'); // ID ÏàòÏ†ï: sh-popup
    if (!shopPopup) return;

    shopPopup.classList.remove('active');
    setTimeout(() => {
        shopPopup.style.display = 'none';
    }, 200);
};

// 1. ÏïÑÏù¥ÌÖú ÏÜåÏú†Í∂å ÏóÖÎç∞Ïù¥Ìä∏ (Ï§ëÏïô ÌÜµÏ†úÏã§)
window.syncItemOwnership = function(itemId, targetJob, action = 'add') {
    const pName = window.state.currentPartyName;
    const item = itemData.find(i => i.id == itemId); // == ÏÇ¨Ïö© (Î¨∏Ïûê/Ïà´Ïûê ÏÉÅÍ¥ÄÏóÜÏù¥)
    const char = window.state.parties[pName]?.characters[targetJob];
    
    if (!item || !char) return false;

    // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Î≥¥Ïû•
    if (!char.items) char.items = [];
    if (!item.owners) item.owners = [];

    if (action === 'add') {
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ïû¨Í≥† ÏàòÎüâ Í∞ïÏ†ú Ïà´Ïûê Î≥ÄÌôò (ÏóÜÏúºÎ©¥ 0ÏúºÎ°ú Ï≤òÎ¶¨Ìï†ÏßÄ 1Î°ú Ìï†ÏßÄ Í≤∞Ï†ï)
        // ÏÉÅÏ†êÏóêÏÑú ÏïÑÏòà ÏóÜÎäî ÌÖú(Ïû¨Í≥†0)ÏùÑ ÎßâÏúºÎ†§Î©¥ Í∏∞Î≥∏Í∞íÏùÑ 0Ïù¥ÎÇò item.stockÏúºÎ°ú ÏóÑÍ≤©Ìûà Ï†úÌïú
        const maxStock = item.stock !== undefined ? Number(item.stock) : 0; 
        const currentCount = item.owners.length;

        // 1. Ïû¨Í≥† 0Ïù¥Í±∞ÎÇò Ïù¥ÎØ∏ ÍΩâ Ï∞ºÏúºÎ©¥ Ï¶âÏãú Ï∞®Îã®
        if (currentCount >= maxStock) {
            console.warn(`[Ï∞®Îã®] ${item.name}: Ïû¨Í≥† ÏóÜÏùå (${currentCount}/${maxStock})`);
            return false; 
        }

        // 2. Î≥∏Ïù∏ Ï§ëÎ≥µ ÏÜåÏßÄ Ï≤¥ÌÅ¨
        if (char.items.includes(Number(itemId))) return false;

        // --- Í≤ÄÏÇ¨ ÌÜµÍ≥º ÏãúÏóêÎßå Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï ---
        char.items.push(Number(itemId));
        if (!item.owners.includes(targetJob)) {
            item.owners.push(targetJob);
        }
        
    } else if (action === 'remove') {
        char.items = char.items.filter(id => Number(id) !== Number(itemId));
        item.owners = item.owners.filter(owner => owner !== targetJob);
    }

    // Firebase ÏóÖÎç∞Ïù¥Ìä∏
    const charRef = ref(db, `parties/${pName}/characters/${targetJob}`);
    update(charRef, { items: char.items });
    
    return true; 
};

// Íµ¨Îß§ ÎòêÎäî Î≥¥ÏÉÅ ÌöçÎìù Ï≤òÎ¶¨
window.processItemAction = function(type) {
    if (!window.selectedItem) return;

    const partyName = window.state.currentPartyName;
    const jobName = window.state.currentCharacter;
    const charData = window.state.parties[partyName]?.characters?.[jobName];

    if (!charData) return;

    const itemId = Number(window.selectedItem.id);
    const currentGold = charData.gold || 0;
    const currentItems = charData.items || [];

    if (type === 'buy') {
        // Ï§ëÎ≥µ Î∞è Í≥®Îìú Ï≤¥ÌÅ¨ (Í∏∞Ï°¥ Î°úÏßÅ ÎèôÏùº)
        if (currentItems.includes(itemId)) {
            const msgElem = document.getElementById('alert-message');
            if (msgElem) msgElem.innerText = "Ïù¥ÎØ∏ ÏÜåÏú†ÌïòÍ≥† ÏûàÎäî ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§!";
            window.closeModal('modal-item-action');
            return window.openModal('modal-global-alert');
        }

        if (currentGold < window.selectedItem.price) {
            const msgElem = document.getElementById('alert-message');
            if (msgElem) msgElem.innerText = "Íµ¨Îß§ Ïã§Ìå®! Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!";
            window.closeModal('modal-item-action');
            return window.openModal('modal-global-alert');
        }

        const newGold = currentGold - window.selectedItem.price;
        const newItems = [...currentItems, itemId];

        const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
        
        update(charRef, {
            gold: newGold,
            items: newItems
        }).then(() => {
            // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] 1. Ï¶âÏãú Î°úÏª¨ state ÏóÖÎç∞Ïù¥Ìä∏ (Î¶¨Ïä§ÎÑàÍ∞Ä Ïò§Í∏∞ Ï†Ñ ÏÑ†Ï†ú Ï°∞Ïπò)
            window.state.parties[partyName].characters[jobName].gold = newGold;
            window.state.parties[partyName].characters[jobName].items = newItems;

            // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] 2. Î™®Îì† Í≥®Îìú ÌëúÏãú ÏöîÏÜå Ïã§ÏãúÍ∞Ñ Í∞±Ïã† Ìò∏Ï∂ú
            window.updateGoldDisplay(); 
            
            // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] 3. ÏÉÅÏ†ê Î™©Î°ù Ïû¨Î†åÎçîÎßÅ (Ïû¨Í≥†/ÏÜåÏú†Ï£º Î∞∞ÏßÄ Ï¶âÏãú Î∞òÏòÅ)
            window.renderShopItems(window.currentShopFilter || 'Ï†ÑÏ≤¥');

            window.closeModal('modal-item-action');
            const msgElem = document.getElementById('alert-message');
            if (msgElem) msgElem.innerText = `[#${itemId}] ${window.selectedItem.name} Íµ¨Îß§ ÏÑ±Í≥µ!`;
            window.openModal('modal-global-alert');
        }).catch(err => console.error("Íµ¨Îß§ Ï≤òÎ¶¨ Ïò§Î•ò:", err));
    }
};

// ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú Î†åÎçîÎßÅ
window.renderShopItems = function(filterType = 'Ï†ÑÏ≤¥', btnElement = null) {
    const listContainer = document.getElementById('sh-item-list');
    if (!listContainer) return;

    // 1. Îç∞Ïù¥ÌÑ∞ Î≤†Ïù¥Ïä§ÏóêÏÑú Ìï¥Í∏à Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ 1~12Î≤à Í∏∞Î≥∏ Ìï¥Í∏à)
    const partyName = window.state.currentPartyName;
    const partyData = window.state.parties[partyName] || {};
    const unlockedItemIds = partyData.unlockedItems || [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

    const savedScrollTop = listContainer.scrollTop;
    listContainer.innerHTML = '';

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏãúÍ∞ÅÌôî
    if (btnElement) {
        document.querySelectorAll('.sh-category-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
    }

    itemData.forEach(item => {
        // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ï£ºÏÑù Ìï¥Ï†ú: Ìï¥Í∏àÎêú ÏïÑÏù¥ÌÖúÎßå ÌëúÏãú
        if (!unlockedItemIds.includes(item.id)) return;
        if (filterType !== 'Ï†ÑÏ≤¥' && item.type !== filterType) return;

        // 2. ÏÜåÏú†Ï£º ÏßÅÏóÖ Î∞∞Ïó¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïö∞Î¶¨Í∞Ä ÏàòÏ†ïÌïú Ìï®Ïàò Ìò∏Ï∂ú)
        const ownerJobs = window.getItemOwnershipInfo(item.id); 
        const maxStock = item.stock || 2; // ÏïÑÏù¥ÌÖú Í≥†Ïú† Ïû¨Í≥† (Í∏∞Î≥∏Í∞í 2)
        const currentStock = maxStock - ownerJobs.length; // ÎÇ®ÏùÄ Ïû¨Í≥† Í≥ÑÏÇ∞
        const isSoldOut = currentStock <= 0;

        // 3. Ïö∞Ï∏° 3Îã® Íµ¨ÏÑ± ÏöîÏÜå Ï§ÄÎπÑ
        // ÏÉÅÎã®: Í∞ÄÍ≤© ÎòêÎäî ÌíàÏ†à
        const topDisplay = isSoldOut 
            ? `<span class="sh-item-soldout">ÌíàÏ†à</span>` 
            : `<span class="sh-item-price">${item.price}G</span>`;

        // Ï§ëÎã®: Ïû¨Í≥† (NaN Î∞©ÏßÄ ÏúÑÌï¥ || 0 Ï≤òÎ¶¨)
        const stockDisplay = `<span class="sh-item-stock">Ïû¨Í≥† ${Math.max(0, currentStock)} / ${maxStock}</span>`;
        
        // ÌïòÎã®: ÏßÅÏóÖ ÏÉâÏÉÅ ÎùºÎ≤® (ÏóÜÏúºÎ©¥ ÎπàÏπ∏)
        let ownerDisplay = '';
        if (ownerJobs.length > 0) {
            const badges = ownerJobs.map(job => `<span class="badge-job badge-${job}">${job.substring(0, 2)}</span>`).join('');
            ownerDisplay = `<div class="sh-item-owner-row">${badges}</div>`;
        }

        const card = document.createElement('div');
        card.className = 'sh-item-card';
        // Ï†ÑÏ≤¥ Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú Íµ¨Îß§/Ïï°ÏÖò Ï∞Ω Ïó¥Í∏∞ (ÌíàÏ†àÏù¥Î©¥ ÌÅ¥Î¶≠ Î∞©ÏßÄ)
        if (!isSoldOut) {
            card.onclick = () => window.openItemAction(item);
        } else {
            card.style.opacity = "0.7";
            card.style.cursor = "default";
        }

        card.innerHTML = `
            <div class="sh-item-info">
                <span class="sh-item-no">#${String(item.id).padStart(2, '0')}</span>
                <span class="sh-item-name">${item.name}</span>
                <span class="sh-item-type">${item.type}</span>
            </div>
            <div class="sh-item-buy-zone">
                <div class="sh-top-row">${topDisplay}</div>
                <div class="sh-mid-row">${stockDisplay}</div>
                <div class="sh-bottom-row">${ownerDisplay}</div>
            </div>
        `;
        
        listContainer.appendChild(card);
    });

    requestAnimationFrame(() => { listContainer.scrollTop = savedScrollTop; });
};

window.unlockItem = function() {
    const inputElem = document.getElementById('sh-unlock-input');
    if (!inputElem) return;

    const rawInput = inputElem.value.trim();
    const partyName = window.state.currentPartyName;
    const partyData = window.state.parties[partyName];

    if (!partyName || !partyData) return;
    if (!rawInput) {
        window.showAlert("ÏïåÎ¶º", "Î≤àÌò∏ ÎòêÎäî Î≤îÏúÑ(Ïòà: 1-13, 15)Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        return;
    }

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤© 1] Ïä§ÎßàÌä∏ ÏûÖÎ†• Î∂ÑÏÑù (ÏâºÌëú, ÌïòÏù¥Ìîà, Î¨ºÍ≤∞Ìëú ÎåÄÏùë)
    let targetIds = [];
    const segments = rawInput.split(','); // 1. ÏâºÌëúÎ°ú Î∂ÑÎ¶¨

    segments.forEach(seg => {
        const rangeMatch = seg.match(/(\d+)\s*[-~]\s*(\d+)/); // 2. Î≤îÏúÑ(1-13) ÌôïÏù∏
        if (rangeMatch) {
            const start = parseInt(rangeMatch[1]);
            const end = parseInt(rangeMatch[2]);
            const min = Math.min(start, end);
            const max = Math.max(start, end);
            for (let i = min; i <= max; i++) targetIds.push(i);
        } else {
            const id = parseInt(seg.trim()); // 3. Îã®Ïùº Ïà´Ïûê ÌôïÏù∏
            if (!isNaN(id)) targetIds.push(id);
        }
    });

    // Ï§ëÎ≥µ Ï†úÍ±∞ Î∞è Ïú†Ìö® Ïà´Ïûê ÌïÑÌÑ∞ÎßÅ
    targetIds = [...new Set(targetIds)].filter(id => id > 0);
    if (targetIds.length === 0) return;

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤© 2] ÌÜ†Í∏Ä Î°úÏßÅ (ÏûàÏúºÎ©¥ ÎπºÍ≥† ÏóÜÏúºÎ©¥ ÎÑ£Í∏∞)
    let currentList = partyData.unlockedItems || [];
    
    targetIds.forEach(id => {
        const index = currentList.indexOf(id);
        if (index > -1) {
            // Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ï†úÍ±∞ (Ïû†Í∏à)
            currentList.splice(index, 1);
        } else {
            // ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä (Ìï¥Í∏à)
            currentList.push(id);
        }
    });

    // Ï†ïÎ†¨
    currentList.sort((a, b) => a - b);

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤© 3] DB ÏóÖÎç∞Ïù¥Ìä∏
    const partyRef = ref(db, `parties/${partyName}`);
    update(partyRef, {
        unlockedItems: currentList
    }).then(() => {
        inputElem.value = ''; // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        
        // Í≤∞Í≥º ÏïåÎ¶º Î©îÏãúÏßÄ Íµ¨ÏÑ±
        const actionMsg = targetIds.length > 1 
            ? `${targetIds.length}Í∞úÏùò ÏïÑÏù¥ÌÖú ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.` 
            : `ÏïÑÏù¥ÌÖú #${targetIds[0]} ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
            
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = actionMsg;
        window.openModal('modal-global-alert');
        
        // ÏÉÅÏ†ê ÌôîÎ©¥ Ï¶âÏãú Í∞±Ïã†
        if (typeof window.renderShopItems === 'function') {
            window.renderShopItems(window.currentShopFilter || 'Ï†ÑÏ≤¥');
        }
    }).catch(err => console.error("ÏÉÅÏ†ê Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:", err));
};

window.openBag = function() {
    const bagPopup = document.getElementById('bg-popup');
    if (!bagPopup) return;
    bagPopup.style.display = 'flex';
    setTimeout(() => bagPopup.classList.add('active'), 10);
    window.renderBagItems('Ï†ÑÏ≤¥');
};

window.closeBag = function() {
    const bagPopup = document.getElementById('bg-popup');
    if (bagPopup) {
        bagPopup.classList.remove('active');
        setTimeout(() => bagPopup.style.display = 'none', 200);
    }
};

window.processSell = function(item) {
    if (!item) return;
    const { currentPartyName: pName, currentCharacter: cName } = window.state;
    const charData = window.state.parties[pName]?.characters?.[cName];
    if (!charData) return;

    const titleElem = document.getElementById('confirm-title');
    const msgElem = document.getElementById('confirm-message');
    const confirmBtn = document.getElementById('confirm-action-btn');

    if (titleElem) titleElem.innerText = "ITEM SELL";
    if (msgElem) {
        msgElem.innerHTML = `
            <div style="text-align:center;">
                <b style="color:var(--accent);">[${item.name}]</b>ÏùÑ(Î•º) ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br>
                <span style="color:#ffd700; font-weight:bold;">ÏàòÏùµ: ${Math.ceil(item.price / 2)}G</span>
            </div>`;
    }

    if (confirmBtn) {
        confirmBtn.onclick = () => {
            const sellPrice = Math.ceil(item.price / 2);
            const newGold = (Number(charData.gold) || 0) + sellPrice;
            const newItems = (charData.items || []).filter(id => Number(id) !== Number(item.id));

            update(ref(db, `parties/${pName}/characters/${cName}`), { 
                gold: newGold, 
                items: newItems 
            }).then(() => {
                charData.gold = newGold;
                charData.items = newItems;

                if (window.updateGoldDisplay) window.updateGoldDisplay();
                window.renderBagItems();
                
                window.closeModal('modal-global-confirm');
                window.closeModal('modal-item-action');
            });
        };
    }

    window.openModal('modal-global-confirm');
};

window.executeDelete = function(itemId) {
    const item = itemData.find(i => i.id == itemId);
    if (!item) return;

    const titleElem = document.getElementById('confirm-title');
    const msgElem = document.getElementById('confirm-message');
    const confirmBtn = document.getElementById('confirm-action-btn');

    if (titleElem) titleElem.innerText = "ITEM DELETE";
    if (msgElem) {
        msgElem.innerHTML = `
            <div style="text-align:center;">
                <b style="color:#ff4444;">[${item.name}]</b><br>
                ÏïÑÏù¥ÌÖúÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?
            </div>`;
    }

    if (confirmBtn) {
        confirmBtn.onclick = () => {
            const currentJob = window.state.currentCharacter;
            window.syncItemOwnership(Number(itemId), currentJob, 'remove');
            
            if (typeof window.saveAllData === 'function') window.saveAllData();

            setTimeout(() => {
                window.renderBagItems();
                window.closeModal('modal-global-confirm');
                window.closeModal('modal-item-action'); // ÏÉÅÏÑ∏Ï∞ΩÎèÑ Ìï®Íªò Îã´Í∏∞
            }, 300);
        };
    }

    window.openModal('modal-global-confirm');
};

window.openTradeTargetSelect = function(itemId) {
    const item = itemData.find(i => i.id == itemId);
    const pName = window.state.currentPartyName;
    const currentJob = window.state.currentCharacter;
    const party = window.state.parties[pName];
    
    window.itemToTrade = item;
    window.selectedTradeTarget = null;

    const msgElem = document.getElementById('alert-message');
    if (!msgElem) return;

    let buttonsHtml = `<div style="margin-bottom:15px; text-align:center;"><b>[${item.name}]</b><br>ÏñëÎèÑ ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>`;
    buttonsHtml += '<div style="display:flex; flex-direction:column; gap:8px;">';
    
    let hasTarget = false; // ÎåÄÏÉÅÏù¥ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨ÌïòÎäî Î≥ÄÏàò Ï∂îÍ∞Ä

    if (party && party.characters) {
        Object.keys(party.characters).forEach(job => {
            const char = party.characters[job];
            
            // Ïù¥Î¶ÑÏù¥ ÏûàÍ≥†, Î≥∏Ïù∏Ïù¥ ÏïÑÎãå Í≤ΩÏö∞Îßå Î≤ÑÌäº ÏÉùÏÑ±
            if (String(job) !== String(currentJob) && char.playerName && char.playerName.trim() !== "") {
                hasTarget = true; // ÎåÄÏÉÅÏùÑ Ï∞æÏùå!
                const displayName = char.playerName;
                
                buttonsHtml += `
                    <button class="trade-target-btn" id="trade-btn-${job}" 
                            style="width:100%; padding:10px; background:rgba(255,255,255,0.05); border:1px solid #444; color:#fff; border-radius:4px; cursor:pointer;"
                            onclick="window.selectTradeTarget('${job}')">
                        <div style="font-size:0.75rem; color:#888; margin-bottom:2px;">${job}</div>
                        <div style="font-size:1rem; font-weight:bold; color:var(--accent);">${displayName}</div>
                    </button>`;
            }
        });
    }

    // ÎßåÏïΩ ÏñëÎèÑ ÎåÄÏÉÅÏù¥ Ìïú Î™ÖÎèÑ ÏóÜÎã§Î©¥ ÏïàÎÇ¥ Î¨∏Íµ¨ Ï∂úÎ†•
    if (!hasTarget) {
        buttonsHtml += `<div style="text-align:center; padding:20px; color:#666; font-size:0.9rem;">ÏñëÎèÑ Í∞ÄÎä•Ìïú ÌååÌã∞ÏõêÏù¥ ÏóÜÏäµÎãàÎã§.</div>`;
    }
    
    buttonsHtml += '</div>';
    buttonsHtml += `
        <div id="trade-action-btns" style="display:flex; gap:10px; margin-top:20px;">
            <button id="final-trade-confirm" class="btn-confirm" 
                    style="flex:1; opacity:0.4; background:#444;" 
                    disabled onclick="window.executeTrade()">ÏñëÎèÑ</button>
            <button class="btn-cancel" 
                    style="flex:1; background:#666; color:#fff; border:none; border-radius:4px; cursor:pointer;" 
                    onclick="window.closeModal('modal-global-alert')">Ï∑®ÏÜå</button>
        </div>`;
    
    msgElem.innerHTML = buttonsHtml;

    // Í∏∞Ï°¥ ÌôïÏù∏ Î≤ÑÌäº Ïà®Í∏∞Í∏∞ (ÏñëÎèÑ Ï†ÑÏö© Î≤ÑÌäºÎì§ÏùÑ ÏÇ¨Ïö©ÌïòÎØÄÎ°ú)
    const originalConfirmBtn = document.querySelector('#modal-global-alert .modal-content > .btn-confirm:not(#final-trade-confirm)');
    if (originalConfirmBtn) originalConfirmBtn.style.display = 'none';

    window.openModal('modal-global-alert');
};

window.selectTradeTarget = function(job) {
    window.selectedTradeTarget = job;

    // Î™®Îì† Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
    document.querySelectorAll('.trade-target-btn').forEach(btn => {
        btn.style.border = '1px solid #444';
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.color = '#fff';
    });

    // ÏÑ†ÌÉùÎêú Î≤ÑÌäº Í∏àÏÉâ Í∞ïÏ°∞
    const selectedBtn = document.getElementById(`trade-btn-${job}`);
    if (selectedBtn) {
        selectedBtn.style.border = '1px solid #ffd700'; // Í∏àÏÉâ ÌÖåÎëêÎ¶¨
        selectedBtn.style.background = 'rgba(255, 215, 0, 0.1)';
        selectedBtn.style.color = '#ffd700';
    }

    // ÏñëÎèÑ Î≤ÑÌäº ÌôúÏÑ±Ìôî
    const confirmBtn = document.getElementById('final-trade-confirm');
    if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
        confirmBtn.style.background = '#ffd700'; // ÌôúÏÑ±Ìôî Ïãú Í∏àÏÉâ
        confirmBtn.style.color = '#000';
    }
};

window.executeTrade = function() {
    const targetJob = window.selectedTradeTarget;
    const item = window.itemToTrade;
    if (!targetJob || !item) return;

    const itemId = Number(item.id);
    const currentJob = window.state.currentCharacter;
    const party = window.state.parties[window.state.currentPartyName];
    const targetChar = party.characters[targetJob];

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ï§ëÎ≥µ ÏÜåÏú† Ï≤¥ÌÅ¨ Î°úÏßÅ
    if (targetChar.items && targetChar.items.includes(itemId)) {
        // Ï§ëÎ≥µÏù∏ Í≤ΩÏö∞: ÏïàÎÇ¥ Î©îÏãúÏßÄÎßå ÎùÑÏö∞Í≥† Ï¢ÖÎ£å (Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïïà Ìï®)
        const msgElem = document.getElementById('alert-message');
        if (msgElem) {
            msgElem.innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <b style="color:#ff4444;">ÏñëÎèÑ Ïã§Ìå®</b><br>
                    ${targetJob}(${targetChar.playerName})Ïù¥(Í∞Ä)<br>Ïù¥ÎØ∏ <b>[${item.name}]</b>ÏùÑ(Î•º) Í∞ÄÏßÄÍ≥† ÏûàÏäµÎãàÎã§.
                </div>`;
        }
        
        // ÌôïÏù∏ Î≤ÑÌäº ÏÇ¥Î¶¨Í∏∞ (Îã´ÏùÑ Ïàò ÏûàÍ≤å)
        const originalConfirmBtn = document.querySelector('#modal-global-alert .modal-content > .btn-confirm:not(#final-trade-confirm)');
        if (originalConfirmBtn) originalConfirmBtn.style.display = 'block';
        
        // ÏñëÎèÑ/Ï∑®ÏÜå Î≤ÑÌäº ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
        const actionBtns = document.getElementById('trade-action-btns');
        if (actionBtns) actionBtns.style.display = 'none';
        
        return; // Ìï®Ïàò Ï¢ÖÎ£å (Ïó¨Í∏∞ÏÑú Î¶¨ÌÑ¥ÌïòÎ©¥ ÎÇ¥ Í∞ÄÎ∞©ÏóêÏÑúÎèÑ ÏÇ≠Ï†ú Ïïà Îê®)
    }

    // 2. Ï§ëÎ≥µÏù¥ ÏïÑÎãê Í≤ΩÏö∞ÏóêÎßå Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Ïù¥Îèô Ïã§Ìñâ
    window.syncItemOwnership(itemId, currentJob, 'remove');
    window.syncItemOwnership(itemId, targetJob, 'add');

    if (typeof window.saveAllData === 'function') window.saveAllData();

    // 3. UI Î≥µÍµ¨ Î∞è ÏÑ±Í≥µ Î©îÏãúÏßÄ
    const originalConfirmBtn = document.querySelector('#modal-global-alert .modal-content > .btn-confirm:not(#final-trade-confirm)');
    if (originalConfirmBtn) originalConfirmBtn.style.display = 'block';

    const msgElem = document.getElementById('alert-message');
    if (msgElem) {
        msgElem.innerHTML = `
            <div style="text-align:center; padding:10px;">
                <b style="color:var(--accent);">[${item.name}]</b><br>
                ${targetJob}ÏóêÍ≤å Ï†ÑÎã¨ÎêòÏóàÏäµÎãàÎã§.
            </div>`;
    }

    const actionBtns = document.getElementById('trade-action-btns');
    if (actionBtns) actionBtns.style.display = 'none';

    window.renderBagItems();
    window.itemToTrade = null;
    window.selectedTradeTarget = null;
};

window.processRewardInput = function() {
    const inputField = document.getElementById('bg-reward-input');
    if (!inputField || !inputField.value.trim()) return;

    const input = inputField.value.trim();
    const itemIds = [];
    
    // ÌååÏã± (1-3, 5...)
    input.split(',').forEach(seg => {
        if (seg.includes('-')) {
            const parts = seg.split('-').map(n => parseInt(n.trim()));
            if (parts.length === 2) {
                const [s, e] = parts;
                for (let i = Math.min(s, e); i <= Math.max(s, e); i++) itemIds.push(i);
            }
        } else {
            const n = parseInt(seg.trim());
            if (!isNaN(n)) itemIds.push(n);
        }
    });

    const { currentCharacter: cName } = window.state;
    let addedNames = [];
    let failedNames = [];

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Î£®ÌîÑ ÎèåÎ©¥ÏÑú Í≤∞Í≥º ÏàòÏßë
    itemIds.forEach(id => {
        const item = itemData.find(i => i.id === id);
        if (!item) return;

        // syncItemOwnershipÏùò Í≤∞Í≥º(true/false)Î•º ÏóÑÍ≤©ÌïòÍ≤å Ï≤¥ÌÅ¨
        const result = window.syncItemOwnership(id, cName, 'add');
        
        if (result === true) {
            addedNames.push(item.name);
        } else {
            failedNames.push(item.name);
        }
    });

    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞è ÌôîÎ©¥ Í∞±Ïã†
    if (addedNames.length > 0) {
        if (typeof window.saveAllData === 'function') window.saveAllData();
        if (typeof window.renderBagItems === 'function') window.renderBagItems();
        inputField.value = ""; // ÏÑ±Í≥µ ÏãúÏóêÎßå ÏûÖÎ†•Ï∞Ω ÎπÑÏõÄ
    }

    // [Î™®Îã¨ Í≤∞Í≥º ÌëúÏãú] - Î¨∏Íµ¨ Ï†ïÎ∞Ä ÌÉÄÍ≤©
    const titleElem = document.getElementById('alert-title');
    const msgElem = document.getElementById('alert-message');

    if (addedNames.length > 0) {
        titleElem.innerText = "Ï≤òÎ¶¨ Í≤∞Í≥º"; // 'ÏßÄÍ∏â' ÎåÄÏã† 'Ï≤òÎ¶¨'Î°ú Îçî Ìè¨Í¥ÑÏ†ÅÏù∏ ÌëúÌòÑ
        msgElem.innerHTML = `
            <div style="text-align:center;">
                <b style="color:var(--accent);">${addedNames.length}Í±¥ Ï≤òÎ¶¨ ÏÑ±Í≥µ</b><br>
                <small style="color:#888;">ÎåÄÏÉÅ: ${addedNames.join(', ')}</small>
                ${failedNames.length > 0 ? `
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #444;">
                        <span style="color:#ffaa00; font-size:0.8rem;">‚ö†Ô∏è Ï†úÏô∏Îê®(Ïû¨Í≥†/Ï§ëÎ≥µ): ${failedNames.join(', ')}</span>
                    </div>
                ` : ""}
            </div>`;
    } else {
        titleElem.innerText = "Ï≤òÎ¶¨ Ïã§Ìå®";
        msgElem.innerHTML = `
            <div style="text-align:center; color:#ff4444;">
                ÏöîÏ≤≠ÌïòÏã† Ìï≠Î™©ÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.<br>
                <small>(Ïù¥ÎØ∏ ÏÜåÏßÄ Ï§ëÏù¥Í±∞ÎÇò Ïû¨Í≥†Í∞Ä ÏÜåÏßÑÎêòÏóàÏäµÎãàÎã§.)</small>
            </div>`;
    }

    window.openModal('modal-global-alert');
};

// Í∞ÄÎ∞© ÏïÑÏù¥ÌÖú Î†åÎçîÎßÅ (items Î≥ÄÏàò ÏÇ¨Ïö©)
window.renderBagItems = function(filterType = 'Ï†ÑÏ≤¥', btnElement = null) {
    const listContainer = document.getElementById('bg-item-list');
    if (!listContainer) return;

    // 1. ÌòÑÏû¨ Ï†ëÏÜç Ï†ïÎ≥¥ Î∞è Îç∞Ïù¥ÌÑ∞ Í≤ΩÎ°ú Ï∂îÏ†Å
    const partyName = window.state.currentPartyName;
    const jobName = window.state.currentCharacter;
    const partyData = window.state.parties[partyName];
    const charData = (partyData && partyData.characters) ? partyData.characters[jobName] : null;
    
    if (typeof window.updateGoldDisplay === 'function') {
        window.updateGoldDisplay(); 
    }

    if (!charData) {
        listContainer.innerHTML = '<p class="sh-empty-msg">Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>';
        return;
    }

    // 2. Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ (ÏïÑÏù¥ÌÖú Î™©Î°ù Ï∂îÏ∂ú Î∞è ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Îß§Ïπ≠)
    const myItemIds = charData.items || [];
    const myItems = itemData.filter(item => myItemIds.includes(item.id));
    const filteredItems = myItems.filter(item => filterType === 'Ï†ÑÏ≤¥' || item.type === filterType);

    // 3. Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº UI ÏóÖÎç∞Ïù¥Ìä∏
    if (btnElement) {
        document.querySelectorAll('.bg-category-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
    }

    // 4. Î¶¨Ïä§Ìä∏ Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçîÎßÅ
    listContainer.innerHTML = '';
    if (filteredItems.length === 0) {
        listContainer.innerHTML = `<p class="sh-empty-msg" style="text-align:center; margin-top:50px;">${filterType} Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>`;
        return;
    }

    // 5. ÌôïÏ†ïÎêú Î†àÏù¥ÏïÑÏõÉÏúºÎ°ú Ïπ¥Îìú ÏÉùÏÑ± (Ï†ïÎ∞Ä ÌÉÄÍ≤© ÏàòÏ†ï Íµ¨Í∞Ñ)
    filteredItems.forEach(item => {
        const sellPrice = Math.ceil(item.price / 2);
        const card = document.createElement('div');
        card.className = 'bag-item-card';
        
        card.innerHTML = `
            <div class="bag-item-left">
                <div class="bag-item-header">
                    <span class="bag-item-id">#${String(item.id).padStart(2, '0')}</span>
                    <span class="bag-item-name">${item.name}</span>
                </div>
                <div class="bag-item-category">${item.type}</div>
            </div>
            <div class="bag-item-right">
                <button class="btn-bag-remove" onclick="event.stopPropagation(); window.executeDelete('${item.id}')" title="ÏïÑÏù¥ÌÖú ÏÇ≠Ï†ú">√ó</button>
                <div class="bag-item-sell-price">ÌåêÎß§Í∞Ä: ${sellPrice}G</div>
                <button class="btn-bag-trade" onclick="event.stopPropagation(); window.openTradeTargetSelect('${item.id}')">ÏñëÎèÑ</button>
            </div>
        `;
        
        // [ÏàòÏ†ï] Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú: openSellAction -> processSell
        card.onclick = () => window.processSell(item);
        listContainer.appendChild(card);
    });
};


// ÏÜåÏú† Ï†ïÎ≥¥ Ï∂îÏ∂ú Ïú†Ìã∏
window.getItemOwnershipInfo = function(itemId) {
    const partyName = window.state.currentPartyName;
    if (!partyName || !window.state.parties[partyName]) return []; // Î¨∏ÏûêÏó¥ 'ÏóÜÏùå' ÎåÄÏã† Îπà Î∞∞Ïó¥ Î∞òÌôò

    const characters = window.state.parties[partyName].characters || {};
    const ownerJobs = [];

    // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ ÎåÄÏã† 'ÏßÅÏóÖÎ™Ö(Key)'ÏùÑ ÏàòÏßëÌï©ÎãàÎã§.
    Object.entries(characters).forEach(([jobName, data]) => {
        if (data.items && data.items.includes(itemId)) {
            ownerJobs.push(jobName);
        }
    });

    return ownerJobs; // ['Ï†ÅÏúÑÎ≥ë', 'Ï≤†Í±∞Ï†ÑÎ¨∏Í∞Ä'] ÏãùÏùò Î∞∞Ïó¥ Î∞òÌôò
};

// Î™®Îã¨ Ïò§Ìîà Ïú†Ìã∏ (ÏÉÅÏ†êÏö©)
window.openItemAction = function(item) {
    if (!item) return;

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Ï†ÑÏó≠ Î≥ÄÏàòÏóê ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖú Ï†ÄÏû• (ReferenceError Î∞©ÏßÄ)
    window.selectedItem = item;

    // Î™®Îã¨ ÎÇ¥ ÌÖçÏä§Ìä∏ ÏÑ∏ÌåÖ (ÏïÑÏù¥ÌÖú Ïù¥Î¶Ñ, Í∞ÄÍ≤© Îì±)
    const titleElem = document.querySelector('#modal-item-action .modal-title'); // Î™®Îã¨ ÌÉÄÏù¥ÌãÄ IDÏóê ÎßûÍ≤å ÏàòÏ†ï
    if (titleElem) titleElem.innerText = item.name;

    const priceElem = document.getElementById('action-item-price'); // Í∞ÄÍ≤© ÌëúÏãú ÏóòÎ¶¨Î®ºÌä∏Í∞Ä ÏûàÎã§Î©¥
    if (priceElem) priceElem.innerText = `${item.price}G`;

    // Í≥µÌÜµ Î™®Îã¨Ï∞Ω ÎùÑÏö∞Í∏∞
    window.openModal('modal-item-action');
};;


// 1. ÌäπÌòú Ï∞Ω Ïó¥Í∏∞ (Ïù∏Ïûê ÏóÜÏù¥ Ï†ÑÏó≠ ÏÉÅÌÉú ÌôúÏö©)
window.openPerks = function() {
    const jobName = window.state.currentCharacter; // ÏÉÅÏÑ∏ ÏãúÌä∏ ÏßÑÏûÖ Ïãú Ï†ÄÏû•Îêú Í∞í
    if (!jobName) {
        console.error("Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
        return;
    }
    
    // UI ÌëúÏãú
    const popup = document.getElementById('popup-perks');
    if (popup) popup.classList.add('active'); 

    // Ìï¥Îãπ ÏßÅÏóÖÏùò Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎ∞Ä ÌÉÄÍ≤©ÌïòÏó¨ Î†åÎçîÎßÅ
    window.renderPerks(jobName);
};

// 2. Ìè¨Ïù∏Ìä∏ Í∞ÄÍ∞ê (Í∞ÄÏû• Ï§ëÏöîÌïú Î∂ÄÎ∂Ñ: currentCharacter Î™ÖÏãú)
window.changePerkPoint = function(amount) {
    const partyName = window.state.currentPartyName;
    const jobName = window.state.currentCharacter; // "ÌòÑÏû¨ Ïó¥Î¶∞ ÏãúÌä∏"Ïùò Ï£ºÏù∏Í≥µ
    
    if (!partyName || !jobName) return;

    const charData = window.state.parties[partyName].characters[jobName];
    const currentPoints = charData.perkPoints || 0;
    const newPoints = Math.max(0, currentPoints + amount);

    // [Îç∞Ïù¥ÌÑ∞ ÎèÖÎ¶Ω] ÌòÑÏû¨ Ï£ºÏù∏Í≥µÏùò ÏÉÅÌÉúÎßå Î≥ÄÍ≤Ω
    const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
    update(charRef, { perkPoints: newPoints }).then(() => {
        // ÏÑ±Í≥µ Ïãú Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ìï¥Îãπ ÏßÅÏóÖ Ï∞ΩÎßå Îã§Ïãú Í∑∏Î¶º
        window.state.parties[partyName].characters[jobName].perkPoints = newPoints;
        window.renderPerks(jobName);
    });
};

// 3. ÌäπÌòú Ï∞Ω Îã´Í∏∞ (ÏÇ¨Ïö©ÏûêÎãò HTMLÏùò window.closePerks ÎåÄÏùë)
window.closePerks = function() {
    const popup = document.getElementById('popup-perks');
    if (popup) popup.classList.remove('active');
};

// 1. Î∞∞ÌãÄÍ≥® ÌÜ†Í∏Ä Î∞è 3Ïπ∏ ÏôÑÏÑ± Ïãú Ìè¨Ïù∏Ìä∏ ÏûêÎèô ÏßÄÍ∏â
window.toggleBattleGoal = function(jobName, index) {
    const partyName = window.state.currentPartyName;
    const charData = window.state.parties[partyName].characters[jobName];
    let newGoals = [...(charData.battleGoals || [false, false, false])];
    let currentPoints = charData.perkPoints || 0;

    // ÌòÑÏû¨ ÏÉÅÌÉú Î∞òÏ†Ñ
    newGoals[index] = !newGoals[index];

    // [Î°úÏßÅ] 3Ïπ∏Ïù¥ Î™®Îëê Ï≤¥ÌÅ¨ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    const checkedCount = newGoals.filter(g => g === true).length;
    
    // ÎßåÏïΩ Î∞©Í∏à 3Î≤àÏß∏ Ïπ∏ÏùÑ Ï≤¥ÌÅ¨ÌñàÎã§Î©¥ Ìè¨Ïù∏Ìä∏ +1 Î∞è Î¶¨ÏÖã
    if (checkedCount === 3) {
        currentPoints += 1;
        newGoals = [false, false, false]; // Ïπ∏ ÎπÑÏö∞Í∏∞
        console.log("Î∞∞ÌãÄÍ≥® ÏôÑÏÑ±! Ìè¨Ïù∏Ìä∏ +1 ÏßÄÍ∏â Î∞è Î¶¨ÏÖã");

const msgElem = document.getElementById('alert-message');
    if (msgElem) msgElem.innerText = "ÌäπÌòú Ìè¨Ïù∏Ìä∏ 1Ï†êÏùÑ ÌöçÎìù!";
    window.openModal('modal-global-alert');
    }

    // DB ÏóÖÎç∞Ïù¥Ìä∏
    const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
    update(charRef, { 
        battleGoals: newGoals,
        perkPoints: currentPoints
    }).then(() => {
        window.state.parties[partyName].characters[jobName].battleGoals = newGoals;
        window.state.parties[partyName].characters[jobName].perkPoints = currentPoints;
        window.renderPerks(jobName);
    });
};

// 2. ÌäπÌòú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä (Ìè¨Ïù∏Ìä∏ ÏÜåÎ™®/ÌôòÍ∏â Î°úÏßÅ Ìè¨Ìï®)
window.togglePerk = function(jobName, perkIdx, subIdx) {
    const partyName = window.state.currentPartyName;
    const charData = window.state.parties[partyName].characters[jobName];
    const checkedPerks = { ...(charData.checkedPerks || {}) };
    let currentPoints = charData.perkPoints || 0;
    const key = `${perkIdx}-${subIdx}`;

    if (checkedPerks[key]) {
        // [Ìï¥Ï†ú Ïãú] Ìè¨Ïù∏Ìä∏ +1 ÌôòÍ∏â
        delete checkedPerks[key];
        currentPoints += 1;
    } else {
        // [Ï≤¥ÌÅ¨ Ïãú] Ìè¨Ïù∏Ìä∏Í∞Ä ÏûàÏùÑ ÎïåÎßå Í∞ÄÎä•
        if (currentPoints <= 0) {
            // ÏÇ¨Ïö©ÏûêÎãòÏù¥ Ï†ÄÏû•Ìï¥ÎëêÏã† Í≥µÌÜµ ÏïåÎ¶ºÏ∞Ω ÌôúÏö©
            const msgElem = document.getElementById('alert-message');
            if (msgElem) msgElem.innerText = "ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÌäπÌòú Ìè¨Ïù∏Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.";
            window.openModal('modal-global-alert');
            return;
        }
        checkedPerks[key] = true;
        currentPoints -= 1;
    }

    // DB ÏóÖÎç∞Ïù¥Ìä∏
    const charRef = ref(db, `parties/${partyName}/characters/${jobName}`);
    update(charRef, { 
        checkedPerks: checkedPerks,
        perkPoints: currentPoints
    }).then(() => {
        window.state.parties[partyName].characters[jobName].checkedPerks = checkedPerks;
        window.state.parties[partyName].characters[jobName].perkPoints = currentPoints;
        window.renderPerks(jobName);
    });
};

window.renderPerks = function(jobName) {
    const pkListContainer = document.getElementById('perk-list-container');
    const bgContainer = document.getElementById('battle-goal-container'); // idÎ°ú Ï†ïÎ∞Ä ÌÉÄÍ≤©
    if (!pkListContainer) return;

    const partyName = window.state.currentPartyName;
    const charData = window.state.parties[partyName].characters[jobName];
    const perks = window.perkData[jobName]; 
    
    if (!charData || !perks) return;

    // 1. [Ìè¨Ïù∏Ìä∏] UI ÏóÖÎç∞Ïù¥Ìä∏
    const pointDisplay = document.getElementById('display-perk-points');
    if (pointDisplay) pointDisplay.textContent = charData.perkPoints || 0;

    // 2. [Î∞∞ÌãÄÍ≥®] 3Ïπ∏ Î†åÎçîÎßÅ
    if (bgContainer) {
        bgContainer.innerHTML = ''; 
        const battleGoals = charData.battleGoals || [false, false, false];
        
        for (let i = 0; i < 3; i++) {
            const box = document.createElement('div');
            // CSS ÌÅ¥ÎûòÏä§Î™Ö pk-bg-box ÏÇ¨Ïö©
            box.className = `pk-bg-box ${battleGoals[i] ? 'checked' : ''}`;
            box.innerText = battleGoals[i] ? '‚úî' : '';
            
            box.onclick = () => {
                if (typeof window.toggleBattleGoal === 'function') {
                    window.toggleBattleGoal(jobName, i);
                }
            };
            bgContainer.appendChild(box);
        }
    }

    // 3. [ÌäπÌòú Î¶¨Ïä§Ìä∏] (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
    const checkedPerks = charData.checkedPerks || {};
    pkListContainer.innerHTML = '';
    perks.forEach((perk, perkIdx) => {
        const row = document.createElement('div');
        row.className = 'pk-row';
        const checkContainer = document.createElement('div');
        checkContainer.className = 'pk-check-container';

        for (let i = 0; i < perk.n; i++) {
            const checkKey = `${perkIdx}-${i}`;
            const isChecked = checkedPerks[checkKey] || false;
            const dot = document.createElement('div');
            dot.className = `pk-check ${isChecked ? 'checked' : ''}`;
            dot.onclick = () => {
                if (typeof window.togglePerk === 'function') {
                    window.togglePerk(jobName, perkIdx, i);
                }
            };
            checkContainer.appendChild(dot);
        }
        const txtDiv = document.createElement('div');
        txtDiv.className = 'pk-txt';
        txtDiv.innerHTML = perk.t;
        row.appendChild(checkContainer);
        row.appendChild(txtDiv);
        pkListContainer.appendChild(row);
    });
};

/* ==========================================
   ÏãúÎÇòÎ¶¨Ïò§ Î≥¥ÏÉÅ Ï≤òÎ¶¨ (Í≥®Îìú, XP, ÌäπÌòú, ÏïÑÏù¥ÌÖú)
   ========================================== */
window.applyScenarioRewards = function(id, isAdding) {
    const sc = window.scenarioData[id];
    if (!sc || !sc.rw || sc.rw === 'ÏóÜÏùå') return;

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    if (!party || !party.characters) return;

    const multiply = isAdding ? 1 : -1;
    const rewards = sc.rw.split(/[,;\n]/).map(s => s.trim()).filter(Boolean);

    rewards.forEach(reward => {
        // 1. ÌäπÌòú Ìè¨Ïù∏Ìä∏ Ïù∏Ïãù
        if (reward.includes('ÌäπÌòú')) {
            const valMatch = reward.match(/\d+/);
            const val = valMatch ? parseInt(valMatch[0]) : 0;
            Object.keys(party.characters).forEach(jobKey => {
                const char = party.characters[jobKey];
                char.perkPoints = (Number(char.perkPoints) || 0) + (val * multiply);
            });
        }
        
        // 2. Í≥®Îìú / Í≤ΩÌóòÏπò Ïù∏Ïãù
        if (reward.includes('G') || reward.includes('ü™ô') || reward.includes('Í≥®Îìú') || /XP|Í≤ΩÌóòÏπò/i.test(reward)) {
            const val = parseInt(reward.replace(/[^0-9-]/g, '')) || 0;
            Object.keys(party.characters).forEach(jobKey => {
                const char = party.characters[jobKey];
                if (/XP|Í≤ΩÌóòÏπò/i.test(reward)) {
                    char.exp = (Number(char.exp) || 0) + (val * multiply);
                } else {
                    char.gold = (Number(char.gold) || 0) + (val * multiply);
                }
            });
        }

        // 3. ÏïÑÏù¥ÌÖú Ìï¥Í∏à (ÏÉÅÏ†ê Ï∂îÍ∞Ä)
        if (reward.includes('Ìï¥Í∏à')) {
            if (!party.unlockedItems) party.unlockedItems = [1,2,3,4,5,6,7,8,9,10,11,12];
            
            const rangeMatch = reward.match(/(\d+)\s*[~-]\s*(\d+)/);
            let targetItems = [];

            if (rangeMatch) {
                const start = parseInt(rangeMatch[1]);
                const end = parseInt(rangeMatch[2]);
                for (let i = start; i <= end; i++) targetItems.push(i);
            } else {
                const itemMatch = reward.match(/\d+/);
                if (itemMatch) targetItems.push(parseInt(itemMatch[0]));
            }

            targetItems.forEach(itemNo => {
                if (isAdding) {
                    if (!party.unlockedItems.includes(itemNo)) party.unlockedItems.push(itemNo);
                } else {
                    party.unlockedItems = party.unlockedItems.filter(n => n !== itemNo);
                }
            });
        }

        // 4. [Ï†ïÎ∞Ä ÏàòÏ†ï] Í∞úÎ≥Ñ ÏïÑÏù¥ÌÖú ÏßÄÍ∏â/ÌöåÏàò Î∞è ÏûêÎèô ÏÉÅÏ†ê Ìï¥Í∏à/Ï∑®ÏÜå
        if (reward.includes('#') && !reward.includes('Ìï¥Í∏à')) {
            const itemMatch = reward.match(/#(\d+)/);
            if (itemMatch) {
                const itemNo = parseInt(itemMatch[1]);
                
                if (isAdding) {
                    // ÏßÄÍ∏â Î°úÏßÅ
                    if (!party.unlockedItems) party.unlockedItems = [1,2,3,4,5,6,7,8,9,10,11,12];
                    if (!party.unlockedItems.includes(itemNo)) {
                        party.unlockedItems.push(itemNo);
                        console.log(`üõí ÏïÑÏù¥ÌÖú #${itemNo} ÏÉÅÏ†ê Ìï¥Í∏à ÏôÑÎ£å`);
                    }
                    window.promptItemOwner(itemNo, id);
                } else {
                    // [Ï∂îÍ∞Ä] ÌöåÏàò Î°úÏßÅ: ÏÉÅÏ†ê Ìï¥Í∏à Ï∑®ÏÜå Î∞è Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Í∞ÄÎ∞©ÏóêÏÑú ÏÇ≠Ï†ú
                    party.unlockedItems = (party.unlockedItems || []).filter(n => n !== itemNo);
                    Object.keys(party.characters).forEach(jobKey => {
                        const char = party.characters[jobKey];
                        if (char.items) {
                            char.items = char.items.filter(it => (typeof it === 'object' ? it.no : it) !== itemNo);
                        }
                    });
                    // [Ï∂îÍ∞Ä] Î∞∞ÏßÄ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Reward Ìï≠Î™© Ï†úÍ±∞)
                    if (sc.ts) {
                        sc.ts = sc.ts.filter(t => String(t.id).toLowerCase() !== 'reward');
                    }
                    console.log(`‚ôªÔ∏è ÏïÑÏù¥ÌÖú #${itemNo} Î∞è Î∞∞ÏßÄ ÌöåÏàò ÏôÑÎ£å`);
                }
            }
        }
    });

    // --- Ïã§ÏãúÍ∞Ñ UI Í∞±Ïã† ---
    const curJob = window.state.currentCharacter;
    if (curJob && party.characters[curJob]) {
        const c = party.characters[curJob];
        if (typeof window.updateSheetUI === 'function') {
            window.updateSheetUI(c.exp, c.lv, c.gold);
        }
        if (typeof window.renderPerks === 'function') {
            window.renderPerks(curJob); 
        }
    }
};
window.promptItemOwner = function(itemNo, scId) {
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    
    // ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
    const activeChars = Object.keys(party.characters).filter(jobKey => {
        const char = party.characters[jobKey];
        return char.playerName && char.playerName.trim() !== "";
    });

    if (activeChars.length === 0) {
        alert("ÏïÑÏù¥ÌÖúÏùÑ ÏàòÎ†πÌï† ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
        return;
    }

    const modalHtml = `
        <div id="modal-item-owner-picker" class="modal-global-alert active" 
             style="display:flex; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000000;">
            <div style="background:#1a1a1a; padding:25px; border-radius:12px; border:1px solid #d4af37; width:90%; max-width:350px; text-align:center;">
                <h3 style="color:#d4af37; margin-bottom:20px; font-size:1.1rem;">üéÅ ÏãúÎÇòÎ¶¨Ïò§ Î≥¥ÏÉÅ ÏïÑÏù¥ÌÖú #${itemNo.toString().padStart(2, '0')}<br>ÏàòÎ†πÏù∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</h3>
                <div style="display:grid; grid-template-columns:1fr; gap:8px;">
                    ${activeChars.map(name => `
                        <button onclick="window.confirmItemGrant('${name}', ${itemNo}, '${scId}')" 
                                class="badge-${name}" 
                                style="padding:15px; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; font-size:1rem;">
                            ${name} (${party.characters[name].playerName})
                        </button>
                    `).join('')}
                </div>
                <button onclick="document.getElementById('modal-item-owner-picker').remove();" 
                        style="margin-top:20px; background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">
                    ÎÇòÏ§ëÏóê Í≤∞Ï†ï
                </button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.confirmItemGrant = async function(jobKey, itemNo, scId) {
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    const char = party.characters[jobKey];
    
    if (!party.unlockedItems) party.unlockedItems = [1,2,3,4,5,6,7,8,9,10,11,12];
    if (!party.unlockedItems.includes(itemNo)) {
        party.unlockedItems.push(itemNo);
    }

    if (!char.items) char.items = [];
    if (!char.items.includes(itemNo)) char.items.push(itemNo);

    // [Ï†ïÎ∞Ä ÏàòÏ†ï] ÏãúÎÇòÎ¶¨Ïò§ Î∞∞ÏßÄ Îç∞Ïù¥ÌÑ∞ Í∏∞Î°ù (Ï§ëÎ≥µ Î∞©ÏßÄ Î∞è Í∑úÍ≤© ÌÜµÏùº)
    if (scId && window.scenarioData[scId]) {
        const sc = window.scenarioData[scId];
        if (!sc.ts) sc.ts = [];
        
        // Í∏∞Ï°¥ reward Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎã§Î©¥ Ï†úÍ±∞ÌïòÏó¨ Íπ®ÎÅóÌïú ÏÉÅÌÉúÎ°ú ÎßåÎì¶
        sc.ts = sc.ts.filter(t => t && t.id && String(t.id).toLowerCase() !== 'reward');
        
        // ÌôïÏã§ÌïòÍ≤å 'Reward'ÎùºÎäî IDÎ°ú Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
        sc.ts.push({ id: 'Reward', c: `ÏïÑÏù¥ÌÖú #${itemNo}`, owner: jobKey });
        console.log("üõ†Ô∏è ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÉÅÌÉú:", sc.ts);
        party.scenarioData = window.scenarioData;
    }

    try {
        const partyRef = ref(db, `parties/${pName}`);
        await set(partyRef, party);
        
        // [Ï∂îÍ∞ÄÎêú ÏàòÏ†ïÏÇ¨Ìï≠] Ï†ÄÏû• ÏÑ±Í≥µ ÌõÑ Ï†ÑÏó≠ ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞Î•º ÌååÌã∞ Îç∞Ïù¥ÌÑ∞ÏôÄ ÎèôÍ∏∞Ìôî
        if (party.scenarioData) window.scenarioData = party.scenarioData;
        
        if (window.state.currentCharacter === jobKey && typeof window.renderBag === 'function') {
            window.renderBag(jobKey); 
        }
        window.renderScenarios();
    } catch (e) {
        console.error("ÏïÑÏù¥ÌÖú Ï†ÄÏû• Ïã§Ìå®:", e);
    }
    
    const modal = document.getElementById('modal-item-owner-picker');
    if (modal) modal.remove();
};
/* ==========================================
   [Ï∂îÍ∞Ä] Î≥¥Î¨º ÏÉÅÏûê Í∞úÎ≥Ñ Î≥¥ÏÉÅ Ï≤òÎ¶¨ Ìï®Ïàò
   ========================================== */
window.applyTreasureReward = function(jobKey, rewardText, isAdding) {
    if (!jobKey || !rewardText || rewardText === 'ÏóÜÏùå') return;

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    const char = party?.characters[jobKey];
    if (!char) return;

    const multiplier = isAdding ? 1 : -1;

    // 1. Í≥®Îìú Î∞òÏòÅ
    if (rewardText.includes('G') || rewardText.includes('ü™ô') || /Í≥®Îìú|gold/i.test(rewardText)) {
        const val = parseInt(rewardText.replace(/[^0-9-]/g, '')) || 0;
        char.gold = (Number(char.gold) || 0) + (val * multiplier);
    }
    
    // 2. Í≤ΩÌóòÏπò Î∞òÏòÅ
    if (/XP|Í≤ΩÌóòÏπò/i.test(rewardText)) {
        const val = parseInt(rewardText.replace(/[^0-9-]/g, '')) || 0;
        char.exp = (Number(char.exp) || 0) + (val * multiplier);
    }

    // 3. ÏïÑÏù¥ÌÖú Î∞òÏòÅ (Ïòà: "#12" ÌòïÌÉúÏùò ÏïÑÏù¥ÌÖú Î≤àÌò∏)
    if (rewardText.includes('#')) {
        const itemNoMatch = rewardText.match(/#(\d+)/);
        if (itemNoMatch) {
            const itemNo = parseInt(itemNoMatch[1]);
            if (!char.items) char.items = [];
            if (isAdding) {
                if (!char.items.includes(itemNo)) char.items.push(itemNo);
            } else {
                char.items = char.items.filter(it => it !== itemNo);
            }
        }
    }

    // ÌòÑÏû¨ ÏÉÅÏÑ∏ ÏãúÌä∏ Ï£ºÏù∏Í≥µÏù¥ÎùºÎ©¥ UI Ï¶âÏãú Í∞±Ïã†
    if (window.state.currentCharacter === jobKey && typeof window.updateSheetUI === 'function') {
        window.updateSheetUI(char.exp, char.lv, char.gold);
    }
};

// Î≥¥Î¨º ÏÜåÏú†Ïûê Î≥ÄÍ≤Ω Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
window.assignTreasure = async function(scId, tsIdx, newOwner) {
    if (!window.scenarioData || !window.scenarioData[scId]) return;
    
    const sc = window.scenarioData[scId];
    if (!sc.ts) sc.ts = [{ id: '?', c: sc.box || "Î≥¥ÏÉÅ ÏóÜÏùå", owner: null }];
    
    const treasure = sc.ts[tsIdx];
    const oldOwner = treasure.owner;
    const rewardText = treasure.c;

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    if (!party) return;

    // [Ï∂îÍ∞Ä] ÏÉÅÏ†ê Ìï¥Í∏à Îç∞Ïù¥ÌÑ∞ Ï†ïÎ∞Ä ÌÉÄÍ≤©: Î≥¥Î¨º ÎÇ¥Ïö©Î¨ºÏóê ÏïÑÏù¥ÌÖú(#)Ïù¥ ÏûàÎã§Î©¥ Ï¶âÏãú ÏÉÅÏ†ê Ìï¥Í∏à
    if (newOwner && rewardText.includes('#')) {
        const itemMatch = rewardText.match(/#(\d+)/);
        if (itemMatch) {
            const itemNo = parseInt(itemMatch[1]);
            if (!party.unlockedItems) party.unlockedItems = [1,2,3,4,5,6,7,8,9,10,11,12];
            if (!party.unlockedItems.includes(itemNo)) {
                party.unlockedItems.push(itemNo);
                console.log(`üõí Î≥¥Î¨ºÏÉÅÏûê ÏïÑÏù¥ÌÖú #${itemNo} ÏÉÅÏ†ê Ìï¥Í∏à ÏôÑÎ£å`);
            }
        }
    }

    // 1. Î≥¥ÏÉÅ Í∞ÄÍ∞ê Ï≤òÎ¶¨ (Í∞ÄÎ∞© ÏßÄÍ∏â Î°úÏßÅ Ìè¨Ìï®)
    if (oldOwner && oldOwner !== newOwner) {
        if (typeof window.applyTreasureReward === 'function') {
            window.applyTreasureReward(oldOwner, rewardText, false);
        }
    }
    if (newOwner && newOwner !== oldOwner) {
        if (typeof window.applyTreasureReward === 'function') {
            window.applyTreasureReward(newOwner, rewardText, true);
        }
    }

    // 2. Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω
    treasure.owner = newOwner || null;

    try {
        // 3. ÌååÌã∞ Í∞ùÏ≤¥ ÎÇ¥Ïùò ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
        party.scenarioData = window.scenarioData;
        
        const partyRef = ref(db, `parties/${pName}`);
        
        // 4. Firebase Ï†ÄÏû•
        await set(partyRef, party);
        console.log(`‚úÖ ÏãúÎÇòÎ¶¨Ïò§ #${scId} Î≥¥Î¨º ÏÜåÏú†Ïûê Î≥ÄÍ≤Ω ÏôÑÎ£å: ${newOwner || 'ÎØ∏ÌöçÎìù'}`);

        // 5. UI ÏóÖÎç∞Ïù¥Ìä∏
        if (typeof window.openTreasureManager === 'function') {
            window.openTreasureManager(scId);
        }
        if (typeof window.renderScenarios === 'function') {
            window.renderScenarios();
        }
    } catch (error) {
        console.error("‚ùå Î≥¥Î¨º Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        if (typeof window.showGlobalAlert === 'function') {
            window.showGlobalAlert("Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        }
    }
};


// 1. Î≥¥Î¨º ÏàòÎ†πÏù∏ ÏÑ†ÌÉù Ïª§Ïä§ÌÖÄ Î™®Îã¨ (ÏïÑÏù¥ÌÖú Î≥¥ÏÉÅ ÎîîÏûêÏù∏ Í≥ÑÏäπ)
window.openTreasureOwnerPicker = function(scenarioId, idx, currentOwner, activeChars, party) {
    const old = document.getElementById('modal-treasure-owner-picker');
    if (old) old.remove();

    const modalHtml = `
        <div id="modal-treasure-owner-picker" class="modal-global-alert active" 
             style="display:flex; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000001;">
            <div style="background:#1a1a1a; padding:25px; border-radius:12px; border:1px solid #d4af37; width:90%; max-width:350px; text-align:center;">
                <h3 style="color:#d4af37; margin-bottom:20px; font-size:1.1rem;">üíé Î≥¥Î¨º ÏàòÎ†πÏù∏ ÏÑ†ÌÉù</h3>
                <div style="display:grid; grid-template-columns:1fr; gap:8px;">
                    <button onclick="window.assignTreasure('${scenarioId}', ${idx}, ''); document.getElementById('modal-treasure-owner-picker').remove(); window.openTreasureManager('${scenarioId}');" 
                            style="padding:12px; border:1px solid #444; border-radius:6px; background:#333; color:#ccc; font-weight:bold; cursor:pointer; font-size:0.95rem;">
                        ÎØ∏ÌöçÎìù
                    </button>
                    ${activeChars.map(name => `
                        <button onclick="window.assignTreasure('${scenarioId}', ${idx}, '${name}'); document.getElementById('modal-treasure-owner-picker').remove(); window.openTreasureManager('${scenarioId}');" 
                                class="badge-${name}" 
                                style="padding:12px; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; font-size:0.95rem; ${currentOwner === name ? 'outline:3px solid white;' : ''}">
                            ${name} (${party.characters[name].playerName})
                        </button>
                    `).join('')}
                </div>
                <button onclick="document.getElementById('modal-treasure-owner-picker').remove();" 
                        style="margin-top:20px; background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">
                    Ï∑®ÏÜå
                </button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// 2. Î©îÏù∏ Î≥¥Î¨º Í¥ÄÎ¶¨Ïûê Ìï®Ïàò (ÏïÑÏù¥ÏΩò ÎîîÏûêÏù∏ Ïú†ÏßÄ Î∞è ÏÑ†ÌÉù Î∞î ÏàòÏ†ï)
window.openTreasureManager = function(scenarioId) {
    const sc = window.scenarioData ? window.scenarioData[scenarioId] : null;
    if (!sc) return;

    if (!sc.ts || sc.ts.length === 0) {
        if (sc.box && sc.box !== 'ÏóÜÏùå') {
            sc.ts = [{ id: '?', c: sc.box, owner: null }];
        } else {
            alert("Ïù¥ ÏãúÎÇòÎ¶¨Ïò§ÏóêÎäî ÌöçÎìù Í∞ÄÎä•Ìïú Î≥¥Î¨ºÏù¥ ÏóÜÏäµÎãàÎã§.");
            return;
        }
    }

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName] || {};
    const activeChars = Object.keys(party.characters || {}).filter(name => 
        party.characters[name].playerName && party.characters[name].playerName.trim() !== ""
    );

    const old = document.getElementById('modal-treasure-manager');
    if (old) old.remove();

    const modalHtml = `
        <div id="modal-treasure-manager" class="modal-global-alert active" 
             style="display:flex !important; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000000;">
            <div class="modal-content" style="background:#1a1a1a; color:white; padding:25px; border-radius:12px; border:1px solid #d4af37; max-width:420px; width:90%; text-align:center;">
                <h3 id="treasure-title" style="margin-top:0; color:#d4af37;">#${scenarioId.toString().padStart(2, '0')} Î≥¥Î¨º Í∏∞Î°ù</h3>
                <div id="treasure-list" style="max-height:55vh; overflow-y:auto;">
                    ${sc.ts.map((t, idx) => {
                        const isAssigned = t.owner && t.owner !== "";
                        return `
                            <div class="treasure-item ${isAssigned ? 'assigned' : ''}" style="background:#222; padding:12px; border-radius:8px; margin:10px 0; border-left:4px solid ${isAssigned ? '#d4af37' : '#555'}; text-align:left;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                   <div style="font-size:0.75rem; font-weight:bold; color:${isAssigned ? '#d4af37' : '#888'}; transition: 0.2s;">#${t.id}</div>
                                    ${isAssigned ? 
                                        `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 12L10 15V22L4 19V12Z" fill="#5D2E0C"/>
                                            <path d="M10 15L20 11V18L10 22V15Z" fill="#8B4513"/>
                                            <path d="M6 11C6 9 10 7 13 7C17 7 20 9 20 11L10 14L6 11Z" fill="#FFD700"/>
                                            <circle cx="9" cy="11" r="2" fill="#FACC15"/>
                                            <circle cx="12" cy="10" r="2.5" fill="#FFD700"/>
                                            <circle cx="15" cy="10" r="2" fill="#FACC15"/>
                                            <circle cx="11" cy="12" r="2" fill="#FFD700"/>
                                            <circle cx="14" cy="12" r="2" fill="#FACC15"/>
                                            <path d="M4 12L3 7L12 1L13 6L4 12Z" fill="#A0522D" stroke="#5D2E0C" stroke-width="0.5"/>
                                            <path d="M10 15L20 11" stroke="#FFD700" stroke-width="1.5" stroke-linecap="round" opacity="0.8"/>
                                        </svg>` : 
                                        `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M4 9L10 12V19L4 16V9Z" fill="#5D2E0C"/>
                                            <path d="M10 12L20 8V15L10 19V12Z" fill="#8B4513"/>
                                            <path d="M4 9L14 5L20 8L10 12L4 9Z" fill="#A0522D"/>
                                            <path d="M10 12L20 8" stroke="#FFD700" stroke-width="1" opacity="0.4"/>
                                            <path d="M13 9L15 10V13L13 12V9Z" fill="#FFD700" stroke="#5D2E0C" stroke-width="0.5"/>
                                        </svg>`
                                    }
                                </div>
                                <div style="font-size:0.95rem; margin:4px 0; font-weight:bold; color:${isAssigned ? '#d4af37' : '#ff4444'};">
                                    ${isAssigned ? t.c : '???' }
                                </div>

                              <div onclick="window.openTreasureOwnerPicker('${scenarioId}', ${idx}, '${t.owner || ''}', ${JSON.stringify(activeChars).replace(/"/g, "'")}, ${JSON.stringify(party).replace(/"/g, "'")})" 
     class="${isAssigned ? 'badge-' + t.owner : ''}"
     style="width:24%; padding:8px 10px; border-radius:6px; cursor:pointer; text-align:center; font-size:0.85rem; font-weight:bold; transition: 0.2s;
            ${isAssigned 
                ? `border:none; color:white;` 
                : `background:#333; color:#888; border:1px solid #444;`}">
    ${isAssigned ? t.owner : 'ÎØ∏ÌöçÎìù'}
</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button onclick="document.getElementById('modal-treasure-manager').remove();" style="background:none; border:none; color:#666; text-decoration:underline; cursor:pointer; margin-top:15px;">Îã´Í∏∞</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};
/* ==========================================
   2. ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î†åÎçîÎßÅ (UI ÏµúÏ†ÅÌôî)
   ========================================== */
window.renderScenarios = function() {
    const grid = document.getElementById('scenario-grid');
    if (!grid || !window.scenarioData) return;

    try {
        const html = Object.entries(window.scenarioData).map(([id, sr]) => {
            if (!sr) return ''; 

            const status = sr.st || "locked"; 
            const isDone = status === "completed";
            const isLocked = (status === "locked") || (sr.isBlocked === true); 
            const displayId = id.toString().padStart(2, '0');
            
            const treasures = sr.ts || [];
            
            // --- Î≥¥Î¨ºÏÉÅÏûê ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ (Í∏∞Î≥∏ Î°úÏßÅ Ïú†ÏßÄ + ÏïàÏ†ÑÌïú ÎπÑÍµê Ï∂îÍ∞Ä) ---
            const realTreasures = treasures.filter(t => t && t.id && String(t.id).toLowerCase() !== 'reward');
            const hasTreasure = (sr.box && sr.box !== 'ÏóÜÏùå') || realTreasures.length > 0;
            const hasUnclaimed = realTreasures.some(t => !t.owner || t.owner === "");
            
            // ÏÜåÏú†Ïûê Î∞∞ÏßÄ Ï†ïÎ≥¥ (Reward Îß§Ïπ≠ Î∞è ÎåÄÏÜåÎ¨∏Ïûê Î¨¥Ïãú ÏïàÏ†Ñ Ï≤òÎ¶¨)
            const rewardOwners = treasures.filter(t => t && t.id && String(t.id).toLowerCase() === 'reward' && t.owner).map(t => t.owner);
            const boxOwners = [...new Set(realTreasures.filter(t => t.owner).map(t => t.owner))];

            return `
                <div class="sr-card ${isLocked ? 'locked' : ''} ${isDone ? 'completed' : ''}" 
                     onclick="${isLocked ? '' : `window.toggleScenarioStatus('${id}')`}"
                     style="position: relative;">
                    
                    <div class="sr-info-zone">
                        <div class="sr-title-row">
                            <span class="sr-no">#${displayId}</span>
                            <span class="sr-title">${sr.t || 'Ïïå Ïàò ÏóÜÎäî ÏãúÎÇòÎ¶¨Ïò§'}</span>
                        </div>
                        
                        <div class="sr-reward-preview ${isDone ? 'show-reward' : 'hide-reward'}" style="display: flex; flex-wrap: wrap; align-items: flex-start; gap: 4px; white-space: normal; word-break: keep-all; line-height: 1.4;">
                            <span style="flex-basis: 100%; margin-bottom: 2px;">üéÅ Î≥¥ÏÉÅ: ${sr.rw || 'ÏóÜÏùå'}</span>
                            ${rewardOwners && rewardOwners.length > 0 
                                ? rewardOwners.map(owner => `<span class="badge-job badge-${owner}">${owner.substring(0, 2)}</span>`).join('') 
                                : ''}
                        </div>
                    </div>

                    <div class="sr-status-zone">
                        ${!isLocked ? `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${hasTreasure ? `
                                    <div style="display: flex; align-items: center; position: relative; z-index: 200;">
                                        <div class="sr-owners-badges" style="display: flex; gap: 2px; margin-right: 5px;">
                                            ${boxOwners.map(owner => {
                                                const shortName = owner.substring(0, 2);
                                                return `<span class="badge-job badge-${owner}">${shortName}</span>`;
                                            }).join('')}
                                        </div>
                                        <button class="sr-btn-treasure" 
                                                onclick="event.preventDefault(); event.stopPropagation(); window.openTreasureManager('${id}');"
                                                style="background:none; border:none; cursor:pointer; padding:2px; display:flex; align-items:center; justify-content:center; position:relative;">
                                            
                                            ${hasUnclaimed ? 
                                                // ÎØ∏ÌöçÎìù Î≥¥Î¨º ÏûàÏùå: Îã´Ìûå ÏûÖÏ≤¥ ÏÉÅÏûê (Í∏∞Ï°¥ SVG Ïú†ÏßÄ)
                                                `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M4 9L10 12V19L4 16V9Z" fill="#5D2E0C"/>
                                                    <path d="M10 12L20 8V15L10 19V12Z" fill="#8B4513"/>
                                                    <path d="M4 9L14 5L20 8L10 12L4 9Z" fill="#A0522D"/>
                                                    <path d="M10 12L20 8" stroke="#FFD700" stroke-width="1" opacity="0.4"/>
                                                    <path d="M13 9L15 10V13L13 12V9Z" fill="#FFD700" stroke="#5D2E0C" stroke-width="0.5"/>
                                                </svg>`
                                                : 
                                                // Î™®Îëê ÌöçÎìùÌï®: Ïó¥Î¶∞ ÏûÖÏ≤¥ ÏÉÅÏûê (Í∏∞Ï°¥ SVG Ïú†ÏßÄ)
                                                `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M4 12L10 15V22L4 19V12Z" fill="#5D2E0C"/>
                                                    <path d="M10 15L20 11V18L10 22V15Z" fill="#8B4513"/>
                                                    <path d="M6 11C6 9 10 7 13 7C17 7 20 9 20 11L10 14L6 11Z" fill="#FFD700"/>
                                                    <circle cx="9" cy="11" r="2" fill="#FACC15"/><circle cx="12" cy="10" r="2.5" fill="#FFD700"/><circle cx="15" cy="10" r="2" fill="#FACC15"/>
                                                    <path d="M4 12L3 7L12 1L13 6L4 12Z" fill="#A0522D" stroke="#5D2E0C" stroke-width="0.5"/>
                                                    <path d="M10 15L20 11" stroke="#FFD700" stroke-width="1.5" stroke-linecap="round" opacity="0.8"/>
                                                </svg>`
                                            }
                                        </button>
                                    </div>
                                ` : ''}
                                <span class="sr-badge ${isDone ? 'done' : 'ready'}">
                                    ${isDone ? 'ÏôÑÎ£å' : 'Í∞ÄÎä•'}
                                </span>
                            </div>
                        ` : '<span class="sr-lock-icon">üîí</span>'}
                    </div>
                </div>
            `;
        }).join('');
        
        grid.innerHTML = html || '<div style="color:white; text-align:center; padding:50px;">ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    } catch (err) {
        console.error("‚ùå renderScenarios Ïò§Î•ò:", err);
    }
};
/* ==========================================
   3. ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÌÉú ÌÜ†Í∏Ä Î∞è Ìï¥Í∏à Î°úÏßÅ
   ========================================== */
window.toggleScenarioStatus = async function(id) {
    if (!window.scenarioData || !window.scenarioData[id] || window.isToggling) return;
    window.isToggling = true;

    const sc = window.scenarioData[id];

    // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÏàòÎèô Ìï¥Í∏à Îì±ÏúºÎ°ú Ïù¥ÎØ∏ 'ready' ÏÉÅÌÉúÎùºÎ©¥, ÌòπÏãú ÎÇ®ÏïÑÏûàÏùÑÏßÄ Î™®Î•º isBlockedÎ•º Ìï¥Ï†úÌï¥ Ï§çÎãàÎã§.
    if (sc.st === 'ready' || sc.st === 'unlocked') {
        sc.isBlocked = false;
    }

    // Ïó¨Ï†ÑÌûà Í∞ïÏ†úÎ°ú Ï∞®Îã®Îêú ÏÉÅÌÉú(isBlocked: true)ÎùºÎ©¥ Ï§ëÎã®
    if (sc.isBlocked) { 
        window.isToggling = false; 
        return; 
    }

    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];

    // ÏÉÅÌÉú ÏàúÌôò Î°úÏßÅ
    if (sc.st === 'locked') {
        sc.st = 'ready'; 
    } else if (sc.st === 'ready' || sc.st === 'unlocked') {
        sc.st = 'completed';
        // Ïù¥ ÏãúÏ†êÏóêÏÑú 21~25 Î≤îÏúÑ Ìï¥Í∏à Îì± Î≥¥ÏÉÅÏù¥ Ï†ïÏÉÅ Ï≤òÎ¶¨Îê©ÎãàÎã§.
        window.applyScenarioRewards(id, true); 
        window.unlockNextScenarios(id); 
    } else if (sc.st === 'completed') {
        sc.st = 'ready';
        window.applyScenarioRewards(id, false);
        
        // Ïû†Í∏à Ìï¥Ï†ú Î°úÏßÅ (lks Î≥µÍµ¨)
        if (sc.lks) sc.lks.forEach(lid => {
            const t = window.scenarioData[lid];
            if (t && t.isBlocked) { t.isBlocked = false; t.st = 'locked'; }
        });
    }

    // UI ÏóÖÎç∞Ïù¥Ìä∏
    window.renderScenarios();

    // Firebase Ï†ÄÏû•
    try {
        if (party && pName) {
            party.scenarioData = window.scenarioData;
            const partyRef = ref(db, `parties/${pName}`);
            await set(partyRef, party);
        }
    } catch (e) {
        console.error("‚ùå Ï†ÄÏû• Ïã§Ìå®:", e);
    } finally {
        setTimeout(() => { window.isToggling = false; }, 300);
    }
};

// Îã§Ïùå ÏãúÎÇòÎ¶¨Ïò§ Ìï¥Í∏à/Ï∞®Îã® Ï≤òÎ¶¨
window.unlockNextScenarios = function(currentId) {
    const sc = window.scenarioData[currentId];
    if (!sc) return;

    // 1. nxt (Ìï¥Í∏à)
    if (sc.nxt) {
        sc.nxt.forEach(nid => {
            const target = window.scenarioData[nid];
            if (target && target.st === 'locked' && !target.isBlocked) {
                target.st = 'ready';
            }
        });
    }
    // 2. lks (ÏÉÅÌò∏ Î∞∞ÌÉÄÏ†Å Ïû†Í∏à)
    if (sc.lks) {
        sc.lks.forEach(lid => {
            const target = window.scenarioData[lid];
            if (target && target.st !== 'completed') {
                target.st = 'locked';
                target.isBlocked = true;
            }
        });
    }
};


window.handleManualScenarioToggle = function() {
    const input = document.getElementById('manual-sr-id');
    if (!input) return;
    
    const srId = input.value.trim();

    // Í≥µÌÜµ ÏïåÎ¶ºÏ∞Ω Ï†úÏñ¥ Ìï®Ïàò (Í∏∞Ï°¥ Ïú†ÏßÄ)
    const showAlert = (msg) => {
        const alertModal = document.getElementById('modal-global-alert');
        const alertMsg = document.getElementById('alert-message');
        if (alertModal && alertMsg) {
            alertMsg.innerText = msg;
            alertModal.classList.remove('hidden');
        } else {
            alert(msg);
        }
    };

    // 1. Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (Í∏∞Ï°¥ Ïú†ÏßÄ)
    if (!srId || !window.scenarioData || !window.scenarioData[srId]) {
        showAlert("Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏãúÎÇòÎ¶¨Ïò§ Î≤àÌò∏ÏûÖÎãàÎã§.");
        input.value = '';
        input.focus();
        return;
    }

    const sr = window.scenarioData[srId];

    // 2. ÏôÑÎ£å ÏÉÅÌÉú Ï≤¥ÌÅ¨ (Í∏∞Ï°¥ Ïú†ÏßÄ)
    if (sr.st === 'completed') {
        showAlert(`#${srId} ÏãúÎÇòÎ¶¨Ïò§Îäî Ïù¥ÎØ∏ ÏôÑÎ£åÌïòÏó¨ ÏÉÅÌÉúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏäµÎãàÎã§.`);
        input.value = '';
        return;
    }

    // 3. ÏÉÅÌÉú ÌÜ†Í∏Ä Î°úÏßÅ [Ï†ïÎ∞Ä ÌÉÄÍ≤©: ÏãúÏä§ÌÖú ÌëúÏ§Ä readyÎ°ú ÏàòÏ†ï]
    if (sr.st === 'locked' || sr.isBlocked === true) {
        sr.st = 'ready'; // active ÎåÄÏã† readyÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÌÅ¥Î¶¨Ïñ¥ Î°úÏßÅÍ≥º Ìò∏ÌôòÎêòÍ≤å Ìï®
        sr.isBlocked = false;
    } else {
        sr.st = 'locked'; 
        sr.isBlocked = true;
    }

    // 4. [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ ÏßÅÏ†ë Ï†ÄÏû• (ÏÇ¨Ïö©Ïûê Í∏∞Ï°¥ Î∞©Ïãù Î≥µÍµ¨)
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    if (pName) {
        try {
            // ÏÉÅÎã®Ïóê ÏÑ†Ïñ∏Îêú Ï†ÑÏó≠ Î≥ÄÏàò db, ref, updateÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©
            const partyRef = ref(db, `parties/${pName}`);
            update(partyRef, { scenarioData: window.scenarioData })
                .then(() => console.log(`‚úÖ #${srId} ÏãúÎÇòÎ¶¨Ïò§ ÏÑúÎ≤Ñ Ï†ÄÏû• ÏÑ±Í≥µ`))
                .catch(err => console.error("‚ùå ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïã§Ìå®:", err));
        } catch (err) {
            console.error("‚ùå Firebase Ï∞∏Ï°∞ Ïò§Î•ò:", err);
        }
    }

    if (typeof window.renderScenarios === 'function') {
        window.renderScenarios();
    }
    
    // 5. ÎßàÎ¨¥Î¶¨ (Í∏∞Ï°¥ Ïú†ÏßÄ)
    input.value = '';
    input.focus();
};

// 4. ÏãúÎÇòÎ¶¨Ïò§ Î™®Îìú ÌåùÏóÖ Ïó¥Í∏∞ (Î©îÏù∏ ÏßÑÏûÖÏ†ê)
window.openScenarioMode = function() {
    const popup = document.getElementById('popup-scenario');
    if (!popup) return;

    // Í∞ïÏ†ú Í∞ÄÏãúÌôî Î∞è ÌôúÏÑ±Ìôî
    popup.style.display = 'flex'; 
    popup.classList.add('active');

    // Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Ï≤¥ÌÅ¨ (ÌååÌã∞ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Î°úÎìú)
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    
    if (party && party.scenarioData) {
        window.scenarioData = JSON.parse(JSON.stringify(party.scenarioData));
    } else if (!window.scenarioData) {
        // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏïÑÏòà ÏóÜÏúºÎ©¥ ÌÖúÌîåÎ¶øÏóêÏÑú Î≥µÏÇ¨
        window.scenarioData = JSON.parse(JSON.stringify(window.SCENARIO_TEMPLATE || {}));
    }

    // ÌôîÎ©¥ Î†åÎçîÎßÅ Ìò∏Ï∂ú
    if (typeof window.renderScenarios === 'function') {
        window.renderScenarios();
    }
};

// 5. ÏãúÎÇòÎ¶¨Ïò§ Î™®Îìú Î∞è Î™®Îì† Í¥ÄÎ†® Î™®Îã¨ Îã´Í∏∞
window.closeScenarioMode = function() {
    const popup = document.getElementById('popup-scenario');
    if (popup) {
        popup.classList.remove('active');
        popup.style.display = 'none';
    }
    
    // Î≥¥Î¨º Í¥ÄÎ¶¨ Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÎã§Î©¥ Ìï®Íªò Îã´Í∏∞
    const tm = document.getElementById('modal-treasure-manager');
    if (tm) {
        tm.remove(); // Ïù¥ Î™®Îã¨ÏùÄ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌïòÎØÄÎ°ú ÏÇ≠Ï†úÌïòÎäî Í≤ÉÏù¥ ÍπîÎÅîÌï©ÎãàÎã§.
    }
};

// 6. Í≥µÌÜµ Î™®Îã¨ Îã´Í∏∞ ÎåÄÏùë (Í∏∞Ï°¥ Í∞ÄÏù¥Îìú Ï§ÄÏàò)
window.closeModal = function(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        modal.classList.add('hidden');
    }
};


window.saveCityEventData = async function() {
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    
    // Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
    if (pName && party && party.cityEvents) {
        try {
            // ÏÇ¨Ïö©ÏûêÎãòÏùò Firebase Íµ¨Ï°∞Ïù∏ parties/ÌååÌã∞Ïù¥Î¶Ñ/cityEvents Í≤ΩÎ°úÏóê ÏßÅÏ†ë Ï†ÄÏû•
            const cityEventRef = ref(db, `parties/${pName}/cityEvents`);
            await set(cityEventRef, party.cityEvents); 
            
            console.log(`‚úÖ [DB Ï†ÄÏû• ÏÑ±Í≥µ] '${pName}' ÌååÌã∞Ïùò ÎèÑÏãú Ïù¥Î≤§Ìä∏Í∞Ä ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`);
        } catch (e) {
            console.error("‚ùå [DB Ï†ÄÏû• Ïã§Ìå®] Firebase Ï†ÑÏÜ° Ï§ë Ïò§Î•ò Î∞úÏÉù:", e);
        }
    } else {
        console.warn("‚ö†Ô∏è [Ï†ÄÏû• Ï§ëÎã®] Ï†ÄÏû•Ìï† ÌååÌã∞ Ïù¥Î¶ÑÏù¥ÎÇò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
    }
};

// 1. ÎèÑÏãú Ïù¥Î≤§Ìä∏ Î™®Îìú Ïó¥Í∏∞
window.openCityEventMode = function() {
    const popup = document.getElementById('ce-popup');
    if (!popup) return;

    // ÏãúÎÇòÎ¶¨Ïò§ Î∞©Ïãù: Ïä§ÌÉÄÏùº Í∞ïÏ†ú Î∂ÄÏó¨ Î∞è active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
    popup.style.display = 'flex'; 
    popup.classList.add('active');

    // Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏ Ïà®Í∏∞Í∏∞
    const charSheet = document.getElementById('modal-char-sheet');
    if (charSheet) charSheet.style.display = 'none';

    // Îç∞Ïù¥ÌÑ∞ Î†åÎçîÎßÅ Ìò∏Ï∂ú
    if (typeof window.renderCityEvent === 'function') {
        window.renderCityEvent();
    }
};

// 2. ÎèÑÏãú Ïù¥Î≤§Ìä∏ Î™®Îìú Îã´Í∏∞ (Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏Î°ú Î≥µÍ∑Ä)
window.closeCityEventMode = function() {
    const popup = document.getElementById('ce-popup');
    if (popup) {
        // ÏãúÎÇòÎ¶¨Ïò§ Î∞©Ïãù: active Ï†úÍ±∞ Î∞è Ïä§ÌÉÄÏùº none Í∞ïÏ†ú
        popup.classList.remove('active');
        popup.style.display = 'none';
    }

    // Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏ Îã§Ïãú Í∞ÄÏãúÌôî
    const charSheet = document.getElementById('modal-char-sheet');
    if (charSheet) {
        charSheet.style.display = 'flex'; // ÎòêÎäî ÏõêÎûò ÏãúÌä∏Ïùò display Î∞©ÏãùÏóê ÎßûÏ∂∞ 'block'
    }
};

window.initCityEventData = function() {
    const pName = window.state.currentPartyName || window.state.homeSelectedParty;
    const party = window.state.parties[pName];
    
    if (!party) return null;

    let isModified = false; 

    // 1. Îç∞Ïù¥ÌÑ∞Í∞Ä ÏïÑÏòà ÏóÜÎäî Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
    if (!party.cityEvents) {
        party.cityEvents = { 
            deck: [1, 2, 3, 4, 5, 6, 7, 8], 
            discard: [], 
            logs: [] 
        };
        isModified = true;
    }
    
    // 2. Î°úÍ∑∏ Î∞∞Ïó¥ ÎàÑÎùΩ Î∞©ÏßÄ
    if (!party.cityEvents.logs) {
        party.cityEvents.logs = [];
        isModified = true;
    }

    // 3. 22Î≤à Ï¥àÍ≥º Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
    const originalDeckLen = party.cityEvents.deck.length;
    const originalDiscardLen = (party.cityEvents.discard || []).length;

    party.cityEvents.deck = (party.cityEvents.deck || []).filter(n => n <= 22);
    party.cityEvents.discard = (party.cityEvents.discard || []).filter(n => n <= 22);

    if (originalDeckLen !== party.cityEvents.deck.length || originalDiscardLen !== party.cityEvents.discard.length) {
        isModified = true;
    }

    // 4. [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ ÏûàÎã§Î©¥ Firebase ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
    if (isModified && typeof window.saveCityEventData === 'function') {
        window.saveCityEventData();
    }

    return party.cityEvents;
};

// 2. ÌôîÎ©¥ Î†åÎçîÎßÅ (Î∞∞ÏßÄ Í∑∏Î¶¨Í∏∞)
window.renderCityEvent = function() {
    const data = window.initCityEventData();
    if (!data) return;

    const { deck, discard, logs } = data;
    const allIds = Array.from({ length: 22 }, (_, i) => i + 1);

    // Ïû†Í∏¥ Îç± Í≥ÑÏÇ∞: Ï†ÑÏ≤¥ÏóêÏÑú Îç±Í≥º ÏÜåÎ©∏Îç±ÏùÑ Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄ
    const locked = allIds.filter(id => !deck.includes(id) && !discard.includes(id));

    // Î∞∞ÏßÄ ÏÉùÏÑ± Ìó¨Ìçº Ìï®Ïàò
    const createBadges = (list, typeClass) => {
        return list.sort((a, b) => a - b).map(id => `
            <span class="ce-card-badge ${typeClass}" 
                  onclick="document.getElementById('ce-input-id').value='${id}'">
                ${id}
            </span>
        `).join('') || '<span style="color:#444; font-size:0.75rem;">ÏóÜÏùå</span>';
    };

    // Í∞Å ÏÑπÏÖòÏóê Î∞∞ÏßÄ Ìà¨ÏûÖ
    document.getElementById('ce-deck-numbers').innerHTML = createBadges(deck, 'ce-card-active');
    document.getElementById('ce-removed-numbers').innerHTML = createBadges(discard, 'ce-card-removed');
    document.getElementById('ce-locked-numbers').innerHTML = createBadges(locked, 'ce-card-locked');

    // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById('ce-count-active').innerText = deck.length;
    document.getElementById('ce-count-removed').innerText = discard.length;
    document.getElementById('ce-count-locked').innerText = locked.length;

    // Î°úÍ∑∏ Î†åÎçîÎßÅ Ìï®Ïàò Ìò∏Ï∂ú
    window.renderCityEventLogs(logs);
};

/**
 * ÎèÑÏãú Ïù¥Î≤§Ìä∏ ÌÜµÌï© Ï†úÏñ¥ (Ìï¥Í∏à/ÏÜåÎ©∏/Î≥µÍ∑Ä) - Ï†ïÎ∞Ä ÌÉÄÍ≤© ÏàòÏ†ïÎ≥∏
 */
window.handleCityEvent = async function(actionType) { // async Ï∂îÍ∞Ä
    const idInput = document.getElementById('ce-input-id');
    const noteInput = document.getElementById('ce-input-note');
    if (!idInput || !noteInput) return;

    const id = parseInt(idInput.value);
    const note = noteInput.value.trim();

    // 1. Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (isNaN(id) || id < 1 || id > 22) {
        const msgElem = document.getElementById('alert-message');
        if (msgElem) msgElem.innerText = "1Î≤àÎ∂ÄÌÑ∞ 22Î≤à ÏÇ¨Ïù¥Ïùò Ïπ¥Îìú Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
        window.openModal('modal-global-alert');
        idInput.value = '';
        idInput.focus();
        return;
    }

    const data = window.initCityEventData(); 
    if (!data) return;

    let actionName = "";
    let statusText = "";

    // 2. Ïï°ÏÖò ÌÉÄÏûÖÎ≥Ñ Î°úÏßÅ Ï≤òÎ¶¨ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
    if (actionType === 'toggle') {
        const idx = data.deck.indexOf(id);
        if (idx > -1) {
            data.deck.splice(idx, 1);
            actionName = "Ïû†Í∏à";
            statusText = "Îç±ÏóêÏÑú Ï†úÍ±∞Îê®";
        } else {
            const disIdx = data.discard.indexOf(id);
            if (disIdx > -1) data.discard.splice(disIdx, 1);
            data.deck.push(id);
            actionName = "Ìï¥Í∏à";
            statusText = "Îç±Ïóê Ï∂îÍ∞ÄÎê®";
        }
    } 
    else if (actionType === 'remove') {
        const idx = data.deck.indexOf(id);
        if (idx > -1) data.deck.splice(idx, 1);
        if (!data.discard.includes(id)) data.discard.push(id);
        actionName = "ÏÜåÎ©∏";
        statusText = "ÏòÅÍµ¨ ÏÜåÎ©∏Îê®";
    } 
    else if (actionType === 'bottom') {
        const idx = data.deck.indexOf(id);
        if (idx > -1) data.deck.splice(idx, 1);
        const disIdx = data.discard.indexOf(id);
        if (disIdx > -1) data.discard.splice(disIdx, 1);
        data.deck.push(id);
        actionName = "Î≥µÍ∑Ä";
        statusText = "Îç± Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô";
    }

    // 3. Î°úÍ∑∏ Í∏∞Î°ù (ÏµúÏã†Ïàú)
    const newLog = {
        id: id,
        type: actionName,
        note: note || statusText,
        date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    };
    data.logs.unshift(newLog);
    if (data.logs.length > 20) data.logs.pop();

    // 4. [Ï†ïÎ∞Ä ÌÉÄÍ≤©] Firebase ÏÑúÎ≤Ñ Ï†ÄÏû• Î∞è ÌôîÎ©¥ Í∞±Ïã†
    if (typeof window.saveCityEventData === 'function') {
        await window.saveCityEventData(); // ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
    }

    window.renderCityEvent(); 
    
    // 5. ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
    idInput.value = "";
    noteInput.value = "";
    idInput.focus();
};

/**
 * Î°úÍ∑∏ Î™©Î°ù ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞ ÌÜ†Í∏Ä
 */
window.toggleCityEventLogs = function() {
    const container = document.getElementById('ce-log-container');
    const icon = document.getElementById('ce-log-toggle-icon');
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        icon.innerText = '‚ñ≤';
    } else {
        container.classList.add('hidden');
        icon.innerText = '‚ñº';
    }
};

window.deleteCityEventLog = function(index) {
    const msgElem = document.getElementById('confirm-message');
    const actionBtn = document.getElementById('confirm-action-btn');

    if (msgElem && actionBtn) {
        msgElem.innerText = "Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?";

        actionBtn.onclick = async function() { // async Ï∂îÍ∞Ä
            const data = window.initCityEventData();
            if (data && data.logs) {
                data.logs.splice(index, 1);
                
                // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÏÑúÎ≤Ñ Ï†ÄÏû• Ìï®ÏàòÎ°ú ÍµêÏ≤¥
                if (typeof window.saveCityEventData === 'function') {
                    await window.saveCityEventData();
                }
                
                window.renderCityEvent();
            }
            window.closeModal('modal-global-confirm');
        };

        window.openModal('modal-global-confirm');
    }
};

window.clearCityEventLogs = function() {
    const msgElem = document.getElementById('confirm-message');
    const actionBtn = document.getElementById('confirm-action-btn');

    if (msgElem && actionBtn) {
        msgElem.innerText = "Î™®Îì† Ïù¥Î≤§Ìä∏ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?";
        
        actionBtn.onclick = async function() { // async Ï∂îÍ∞Ä
            const data = window.initCityEventData();
            if (data) {
                data.logs = [];
                
                // [Ï†ïÎ∞Ä ÌÉÄÍ≤©] ÏÑúÎ≤Ñ Ï†ÄÏû• Ìï®ÏàòÎ°ú ÍµêÏ≤¥
                if (typeof window.saveCityEventData === 'function') {
                    await window.saveCityEventData();
                }
                
                window.renderCityEvent();
            }
            window.closeModal('modal-global-confirm');
        };

        window.openModal('modal-global-confirm');
    }
};

/**
 * Î°úÍ∑∏ Î†åÎçîÎßÅ (Ï§ÑÎ∞îÍøà ÌóàÏö© Î∞è ÏöîÏïΩ ÎùÑÏö∞Í∏∞ Î∞òÏòÅ)
 */
window.renderCityEventLogs = function(logs) {
    const container = document.getElementById('ce-log-container');
    const summary = document.getElementById('ce-log-summary');
    if (!container || !summary) return;

    if (!logs || logs.length === 0) {
        summary.innerHTML = 'üìú ÏµúÍ∑º Í∏∞Î°ù: ÏóÜÏùå';
        container.innerHTML = '<div style="color:#444; text-align:center; padding:15px; font-size:0.75rem;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
        return;
    }

    // 1. ÏµúÏÉÅÎã® ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏: 4Ïπ∏ ÎùÑÏö∞Í∏∞ Î∞è Ï¥àÎ°ùÏÉâ Í∏ÄÏî® Ï†ÅÏö©
    const latest = logs[0];
    const space = "&nbsp;&nbsp;&nbsp;&nbsp;"; 
    summary.innerHTML = `üìú ÏµúÍ∑º Í∏∞Î°ù${space}<b style="color:#2ecc71;">#${latest.id} ${latest.note || latest.type}</b>`;

    // 2. Í∞úÎ≥Ñ Î°úÍ∑∏ Ïπ¥Îìú Î†åÎçîÎßÅ
    container.innerHTML = logs.map((log, index) => `
        <div class="ce-log-card" style="font-size: 0.8rem; margin-bottom: 8px; padding: 12px; border-left: 3px solid ${log.type === 'ÏÜåÎ©∏' ? '#c0392b' : 'var(--accent)'}; background: #222; border-radius: 6px; position: relative; height: auto;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center;">
                <b style="color: ${log.type === 'ÏÜåÎ©∏' ? '#ff6b6b' : '#ffd700'};">#${log.id} ${log.type}</b>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="color: #666; font-size: 0.7rem;">${log.date}</span>
                    <span onclick="event.stopPropagation(); window.deleteCityEventLog(${index})" 
                          style="background:#c0392b; color:white; padding:2px 8px; border-radius:4px; font-size:0.7rem; cursor:pointer; font-weight:bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ÏÇ≠Ï†ú</span>
                </div>
            </div>
            <div style="color: #bbb; line-height:1.5; word-break: break-all; white-space: normal;">${log.note}</div>
        </div>
    `).join('');
};



</script>
</body>
</html>